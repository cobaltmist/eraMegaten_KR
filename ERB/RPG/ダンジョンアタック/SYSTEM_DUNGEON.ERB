;_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/#
;
;	Module		:STSTEM_DUNGEON.ERB
;	Facility	:ダンジョンＲＰＧモジュール
;
;	Licence		:。
;
;	Modification Data:
;
;	Edit	Date			Author					Reason
;	001		20XX/XX/XX			N鳥					新規作成
;	002		2011/01/15			P					ダンジョン内調教においてASSIを排除する条件を追加
;	003		2011/01/21			P					トリッシュを調整
;	004		2011/01/27			旅人				キャプス・ロック実装
;	005		2011/02/04			P					トリッシュの価格調整・チュートリアルの条件にガンスリンガー所持を加える
;	006		2011/02/05			Rsp暇人				性格変化酒の解決処理を追加
;	007		2011/02/06			P					ガリバーマジックを主人が死亡・
;	008		2011/02/24			P					デバッグフラグがONのとき、ハニービーを常に使用可能なように変更
;	009		2011/02/27			P					ATTACK開始時に会話不能・先制攻撃キャンセル・逃走不能のフラグを0にするように
;	010		2011/03/04			P					SHOPダンジョンにコインによる購入処理を追加。また少しアイテム表示の字数を増やし、最大個数判定関数がない場合も落ちないように変更
;													金を取得する宝ばこがBIT演算に対応していなかったのを修正
;	011		2011/03/06			P					ダンジョンSHOPでスキルカードを扱う場合字数の問題で【スキル名】だけ扱うように
;	012		2011/03/08			P					DDMのバグを修正
;	013		2011/03/18			P					探索中でも方法によって、自宅サーバー所属の仲魔を送還できていたのを修正
;	014		2011/03/28			P					ダークゾーン・@DUNGEON_WORPの仕様を一部変更。COMP使用不能の処理を追加
;	015		2011/04/27			Ｎ鳥				探索開始時に衣装を設定、探索終了時に保存するように変更
;	016		2011/05/02			P					汎用的配置関数を作成
;	017		2011/05/02			P					汎用的配置関数の共通配置数関数を製作
;	018		2011/05/08			Ｎ鳥				ＣＯＭＰ合体を基本機能に
;	019		2011/05/10			P					ダンジョン内のANALYZEをTAからSAVESTR:10000~に変更
;	019		2011/05/23			P					一時アナライズをダンジョンサイズ互換処理のあとに移動
;	020		2011/06/20			P					ダークゾーン内のアナライズの視界を自分のマスだけに戻し、そのかわり壁にぶつかった際に壁のアナライズをとるように
;	021		2011/11/06			旅人				統合整備(タイル文字の共通化)
;	022		2012/01/02			Ｎ鳥				魔法の箱追加
;	023		2012/01/18			P					COMPからマントラDL出来るように変更
;	024		2012/02/17			ネトリス			素質『発情可』を持っていると魅了状態時に10％の確率で発情
;													欲情が10000以上になる、または5000以上で素質『発情可』があると発情
;													発情状態の時に30％の確率でHAPPYに
;													気力0と発情しているときは、ステート経過ターンが増えない、以上を追加
;	025		2012/02/28			ネトリス			性欲処理を使えるようにしました
;	026		2012/12/02			ネトリス			性欲処理周りを『CFLAG:ダンジョン内発情用欲情値』を参照するように変更などなど
;													『CFLAG:ダンジョン内発情用欲情値』に上限を設定、発情すると膣内とヴァギナに『汚れ:愛液』がつくように
;	027		2012/12/27			P					ダンジョン内でマントラを取得しようとする際にポジションに空きがあるとエラーがでていたのを修正
;	028		2013/12/02			ひみつ				ダンジョンリストの表示方法を変更。自動効果以外の装備スキルも機能するように変更。
;													スキル属性表示の適用範囲拡大。スキル属性表示にキャラ情報を渡すように
;	029		2014/01/03			銃Ｐ				ターミナルからベルベットルームとマントラに行ける様に加筆
;	030		2015/01/13			Ｊ( 'ー`)し			マージ時に生じていたターミナル不具合を修正
;	031		2015/01/18			Ｊ( 'ー`)し			ターミナルでメニューが余剰に表示される不具合を修正
;	032		2015/09/19			54-762				ＭＡＧ消費処理から種族：人間を除外されるよう処置
;	032		2015/12/11			JK好き				エストマ等が画面に表示されるように修正
;	033		2016/05/02			ネトリス			休憩を追加
;	034		2016/05/02			（U´・ω・｀）		日記帳exeに基づくフィルタリング機能の追加
;	035		2016/07/29			（U´・ω・｀）		ランランダンジョンのための記述を追加
;	036		2016/07/30			（U´・ω・｀）		オートフィルタの確認が個人的にうざかったので除去
;													あとランランダンジョンの記述を修正
;	037		2016/08/01			（U´・ω・｀）		ランランダンジョンのフラグ管理修正×２
;	038		2016/08/07			（U´・ω・｀）		WORP,FORCEMOVE時のランランダンジョンの移動中断処理を実装
;	039		2016/09/25			多治見国々			ダンジョンの推奨レベルの表示をオプションでも選択できるように
;	040		2017/06/23			kuni				キャラ表示でINPUT_CHARA_LISTを使用するように変更
;	041		2018/06/09			名無				一日に複数回探索、結界石消費でダンジョン内調教できるように
;	042		2018/08/25			名無				呪いのレッドカーペット
;	043		2018/09/05			名無				関数DUNGEON_TRAP_BADSTATEを追加
;	044		2018/11/08			JK好き				エストマ時にパーティ人数を参照して平均Lvを計算するように変更ついでにエストマとキャプスロックの判定が同居するように変更
;	045		2019/11/21			JK好き				異能者デビルシフターが変身悪魔変更できない様に修正　CASTING_CHANGE_LINK_F()を使用
;	046		2020/02/20			JK好き				自動レベルアップ使用時はＣＯＭＰから成長比率設定が出来るように追加
;	047		2020/05/13			JK好き				@COMMAND_MAGIC_FIELDに特技と魔法を切り替えられるボタンを追加
;	048		2020/06/28			JK好き				膣内が精液で汚れている場合は10％の確率でヴァギナに汚れが付くを1％に変更
;	049		2020/08/19			JK好き				ダンジョン推奨レベルの表示のズレを修正
;	050		2020/08/22			春眠				ターミナルから喰人のスキルセット・ステータスセットが行えるようについでにサンヒターのUIをちょっと変更
;	051		2020/08/22			Jガン				扉、→等色固定のマスの色を変えやすいように
;	052		2020/09/23			Jガン				ダンジョンでの買い物のエラーの修正
;	053		2020/10/14			Jガン				エネミーエンカウントの無限ループ対策
;	LNKUI	2021/02/11			Rsp暇人 			ダンジョン探索中、COMP（またはMENU)画面からリンケージ一覧を呼び出せるように
;	054		2021/04/11			Jガン				3D時のダンジョンの処理を追加
;													ウパニシャッド処理追加
;	055		2021/04/22			JK好き				結界石によるダンジョン内調教であなたを選択できる問題を修正
;	056		2021/07/24			っとっとき			ダンジョン探索モード設定オプションの追加
;	057		2021/11/06			Schrott				東方EXにて、ミタマコイコイと同時に発動できる、御霊招来CSTR専用スキルを追加。
;	058		2021/12/12			ロッド@カヤノソト	地形自動生成やF.O.E.の配置と制御に関する処理を追加
;	059		2022/01/04			ロッド@カヤノソト	地形自動生成やF.O.E.に関する処理について、一部のダンジョンにおいてのみ実行されるように機能を隔離しました。※「FLAG:地形自動生成・FOEフラグ」が1(ON)の場合のみ有効
;	060		2021/12/30			JK好き				@ENEMY_TABLE 御霊招来でエラー落ちする場合がある問題を修正
;	061		2022/03/07			JK好き				@SHOW_DUNGEONLIST及び@FILTER_DUNGEONLIST ダンジョンを128個まで表示できるように修正、ボタンの番号を変更
;	062		2022/06/07			Collared			UI整理プロジェクトにより配置変更 & ショップコマンド番号の呼び出しに
;_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/#
;=====================================================================
;던전ＲＰＧモジュール
;=====================================================================


@SHOPCOMABLE_101
#DIM LCOUNT
RESULT:1 = 1
RESULTS = 탐색
;---- EDIT 041 MOD START   -------------------------
;なんかの不손際で0未満なら0に
SIF FLAG:던전탐색완료 < 0
	FLAG:던전탐색완료 = 0
;---- EDIT 056 MOD START   -------------------------
IF FLAG:던전탐색모드설정 == 0
	;一日一回、もしくはマスターが絶倫、謎の魅力、禁断の知識ないしレベル50以上なら二回、レベル100以上なら三回まで
	SIF FLAG:던전탐색완료 >= 1+(TALENT:MASTER:절륜 || TALENT:MASTER:수수께끼의매력 || TALENT:MASTER:금단의지식 || BASE:MASTER:LV >= 50)+(BASE:MASTER:LV >= 100)
		RETURN 0
ELSEIF FLAG:던전탐색모드설정 == 1
	SIF FLAG:던전탐색완료 >= 1
		RETURN 0
ELSEIF FLAG:던전탐색모드설정 == 2
	;一日一回、もしくはマスターが絶倫、謎の魅力ないしレベル50以上なら二回、レベル100以上なら三回まで
	SIF FLAG:던전탐색완료 >= 1+(TALENT:MASTER:절륜 || TALENT:MASTER:수수께끼의매력 || BASE:MASTER:LV >= 50)+(BASE:MASTER:LV >= 100)
		RETURN 0
ENDIF
;---- EDIT 056 MOD END   -------------------------
;---- EDIT 041 MOD END   -------------------------
;당신が臨月だと不可
SIF (TALENT:MASTER:임신 && CFLAG:MASTER:출산예정일 - 2 <= DAY)
	RETURN 0
;당신육아중だと不可
SIF TALENT:MASTER:육아중
	RETURN 0
;パーティに一人以上いるなら
LOCAL = 0
FOR LCOUNT, 0, CHARANUM
	SIF CFLAG:LCOUNT:PT플래그 == 2
		LOCAL += 1
NEXT
IF LOCAL > 0
	RETURN 1
ELSE
	RETURN 0
ENDIF

@SHOP_COM_101
DRAWLINE
IF FLAG:던전탐색모드설정 == 1
	PRINTFORML 탐색할 장소를 선택해 주세요
ELSEIF FLAG:던전탐색모드설정 == 0
	PRINTFORML 탐색할 장소를 선택해 주세요 (남은 탐색 횟수 {( 1 + (TALENT:MASTER:절륜 || TALENT:MASTER:수수께끼의매력 || TALENT:MASTER:금단의지식 || BASE:MASTER:LV >= 50) + (BASE:MASTER:LV >= 100) - FLAG:던전탐색완료 )} )
ELSEIF FLAG:던전탐색모드설정 == 2
	PRINTFORML 탐색할 장소를 선택해 주세요 (남은 탐색 횟수 {( 1 + (TALENT:MASTER:절륜 || TALENT:MASTER:수수께끼의매력 || BASE:MASTER:LV >= 50) + (BASE:MASTER:LV >= 100) - FLAG:던전탐색완료 )} )
ENDIF
;ランランンジョンの効果リセット
SIF EQUIP:MASTER:런런던전 == 0 || FLAG:COMP사용불능
	CLEARBIT FLAG:232,0
CALL SHOW_DUNGEONLIST
SIF RESULT == -1
	RETURN 0
LOCAL = RESULT
FLAG:현던전 = LOCAL
FLAG:MAG소비율 = 100
FLAG:월령진행률 = 100
FLAG:탈출 = 0
;-- 던전32:不思議な던전 --------
;地形自動生成やF.O.E.制御関係のフラグやパラメータをクリアする。	※誤って値が残り続けることでの事故防止のため、ここでの初期化自体は常に行うようにする。
FLAG:지형자동생성・FOE플래그 = 0		;地形の自動生成およびF.O.E.を利用するを利用しない	※補足：地形の自動生成およびF.O.E.を利用する던전の場合、この後の「START_DUNGEON_{FLAG:현던전}」の関数内でフラグをONに設定します。
CALL CD_CLEAR_PARAMETERS				;地形自動生成・F.O.E.制御用の各種パラメータをクリアする
CALL CD_CREAR_TIME_AND_TURN, 0			;던전内の経過時間・経過ターン数カウントをクリアする
;-- 던전32:不思議な던전 --------
;에스트마의 효과 리셋 처리
CALL ENCOUNTER_CHANGER
;시작지점을 호출 (현M、현X、현Y에 각각 대입)
CALLFORM START_DUNGEON_{FLAG:현던전}
;현재의 플로어데이터를 읽어들임
CALL MAKE_FLOOR, FLAG:현던전
CALL AUTOMAP
;-- タルタロスにF.O.E.『刈り取るもの』を追加するパッチ --------
;던전内の経過時間・経過ターン数カウントの初期設定を行う
IF FLAG:지형자동생성・FOE플래그 == 1
	CALL CD_CREAR_TIME_AND_TURN, 1
ENDIF
;-- タルタロスにF.O.E.『刈り取るもの』を追加するパッチ --------
;던전 개시시의 이벤트
TRYCALLFORM EVENT_DUNGEON_START_{FLAG:현던전}

;-- 던전32:不思議な던전 --------
;던전開始時のイベントで「FLAG:탈출 = 1」に設定している場合、던전を開始せず취소する。
;　※던전イベント内でやっぱり던전突入をやめるという処理を可能とするための処理。不思議な던전系に限らず共通処理として用意しています。
IF FLAG:탈출 == 1
	FLAG:탈출 = 0	;脱出フラグをデフォルトに戻す
	RETURN 0		;던전突入を취소する
ENDIF
;-- 던전32:不思議な던전 --------

;---- EDIT 041 MOD START   -------------------------
FLAG:던전탐색완료 += 1
;---- EDIT 041 MOD END   -------------------------

FLAG:도주불가플래그 = 0
FLAG:회화불능플래그 = 0
FLAG:선제기습취소 = 0
;---- EDIT 015 ADD START -------------------------
;탐색에 참가 가능한 캐릭터의 의상의 설정、PALAM・SOURCE・EX를 초기화
FOR LOCAL , 0 , CHARANUM
	SIF CFLAG:LOCAL:전투참가불가능 == 1
		CONTINUE
	SIF (ABL:LOCAL:종족 == 0 || CFLAG:LOCAL:소환불가 || CFLAG:LOCAL:소속ＣＯＭＰ == -1) && CFLAG:LOCAL:PT플래그 == 1
		CONTINUE
	CALL CLOTHES_TRAIN,LOCAL,1
	VARSET PALAM:LOCAL:0 , 0
	VARSET SOURCE:LOCAL:0 , 0
	VARSET EX:LOCAL:0 , 0
NEXT
;---- EDIT 015 ADD END   -------------------------
CALL DUNGEON_ATTACK
;---- EDIT 015 ADD START -------------------------
;탐색에 참가 가능한 캐릭터의 의상을 보존
FOR LOCAL , 0 , CHARANUM
	SIF CFLAG:LOCAL:전투참가불가능 == 1
		CONTINUE
	SIF (ABL:LOCAL:종족 == 0 || CFLAG:LOCAL:소환불가 || CFLAG:LOCAL:소속ＣＯＭＰ == -1) && CFLAG:LOCAL:PT플래그 == 1
		CONTINUE
	CALL CLOTHES_TRAIN,LOCAL,1
NEXT
;---- EDIT 015 ADD END   -------------------------
;---- EDIT 002 ADD START -------------------------
;ここに来れないASSI及び健在でないASSIを排除する
IF FLAG:던전내조교 == 1
	FLAG:던전내조교조수대피 = ASSI
	SIF ASSI >= 0 && ABL:ASSI:종족 == 0 && CFLAG:ASSI:PT플래그 == 1
		ASSI = -1
	SIF ASSI >= 0 && GET_STATE(CFLAG:ASSI:상태이상) != "GOOD"
		ASSI = -1
	BEGIN TRAIN
ENDIF
;---- EDIT 002 ADD END   -------------------------

SIF FLAG:던전내조교 == 1
	BEGIN TRAIN
;---- EDIT 003 ADD START -------------------------
;日付변경時の処理に移動
;SIF FLAG:트리슈의샘이용횟수 > 0
;	FLAG:트리슈의샘이용횟수 = 1
;SIF FLAG:트리슈조교 == -1
;	FLAG:트리슈조교 = -2
;---- EDIT 003 ADD START -------------------------

FLAG:SHOP커맨드 = 0
FLAG:소마기프트 = 0
FLAG:보옥륜기프트 = 0
FOR LOCAL,0,CHARANUM
	SIF CFLAG:LOCAL:악마변신 == 1
		CALL ACTION_2310 , LOCAL , 0
NEXT
BEGIN TURNEND
RESTART
;=====================================================================
;攻略可能던전を표시
;=====================================================================
@SHOW_DUNGEONLIST
#LOCALSIZE 300
VARSET LOCAL, -1
LOCAL:99 = 1
FOR LOCAL,1 ,128
	IF LOCAL <= 63
		SIF GETBIT(FLAG:던전필터1,LOCAL)
			CONTINUE
	ELSE
		SIF GETBIT(FLAG:던전필터2,LOCAL - 64)
			CONTINUE
	ENDIF
	TRYCCALLFORM PREREQUISITE_DUNGEON_{LOCAL}
		IF RESULT || FLAG:DEBUG
			LOCAL:(LOCAL:99) = LOCAL
			LOCAL:99 ++
		ENDIF
	CATCH
	ENDCATCH
NEXT
LOCAL:99 = 0
$SHOW_LIST
FOR LOCAL, LOCAL:99 * 리스트표시수(), (LOCAL:99 + 1) * 리스트표시수()
	SIF LOCAL == 0 || LOCAL == 99
		CONTINUE
	SIF LOCAL:LOCAL == -1
		BREAK
	CALLFORM GET_DUNGEON_NAME_{LOCAL:LOCAL}
	IF FLAG:DEBUG || FLAG:던전의권장레벨표시설정
		PRINTFORM [{LOCAL:LOCAL,2}] %RESULTS,34,LEFT%
		TRYCCALLFORM GET_DUNGEON_LV_{LOCAL:LOCAL}
			PRINTFORMLC 　(권장LV:{RESULT, 2}\@ FLAG:DEBUG ?　최저LV:{RESULT:1, 2}　최고LV:{RESULT:2, 2}　보스LV:{RESULT:3, 2}#\@)
		CATCH
		ENDCATCH
		PRINTL 
	ELSE
		PRINTFORMLC [{LOCAL:LOCAL, 2}] %RESULTS, 20, LEFT%
	ENDIF
NEXT
PRINTFORM \@ LINEISEMPTY() ? # \n \@
IF FLAG:DEBUG
	PRINTL [998] 샘플던전
;	PRINTL [999] 던전メーカー
ENDIF
;ノーマル以下で一周눈の一日눈のみチュートリアルが出現する
IF FLAG:주회횟수 == 0 && FLAG:전투난이도 < 3 && DAY == 1 && TALENT:MASTER:건슬링거 && TALENT:MASTER:도구지식 == 3
	DRAWLINE
	PRINTL [200] 튜토리얼(1일째에만 선택가능)
	DRAWLINE
ENDIF
DRAWLINE
PRINTLC [1002] 필터링 설정
PRINTLC [1010] 자동 필터링
PRINTL [1011] 필터 전체 해제
DRAWLINE
PRINTL [1000] 돌아간다
PRINTFORMLC \@ LOCAL:99 > 0 ? [1001] 이전페이지 # %" " * 16%\@
PRINTFORMLC \@ LOCAL:99 < 5 && LOCAL:((LOCAL:99+1) * 리스트표시수()) >= 0 ? [1003] 다음페이지 # %" " * 16%\@
$INPUT_LOOP
INPUT
IF RESULT == 200 && FLAG:주회횟수 == 0 && FLAG:전투난이도 < 3 && DAY == 1
	PRINTW 던전 탐색을 포함해 전투에 관한 튜토리얼을 받는 것이 가능합니다
	PRINTW 던전은 하츠다이 쉘터를 사용합니다
;	PRINTW チュートリアルではゲームの進行を有利にするために아이템を획득できますが
	PRINTW 튜토리얼을 받지 않고 하츠다이 쉘터를 클리어한 경우에 비하면 보수가 감소하니 주의하세요
	PRINTW eraMegaten의 전투 시스템은 다소 복잡하기 떄문에 RPG에 자신이 없는 분은 튜토리얼을 받는 것을 추천합니다
	PRINTL 튜토리얼을 받겠습니까?
	CALL INPUT_YN,"예","아니오"
	SIF RESULT == 1
		RESTART
	PRINTW 그럼 튜토리얼을 시작합니다
	PRINTL 
	CUSTOMDRAWLINE =
	WAIT
	던전플래그:34:30 = 1
	RETURN 34
ELSEIF RESULT == 1000
	RETURN -1
ELSEIF RESULT == 1001 && LOCAL:99 > 0
	LOCAL:99 -= 1
	GOTO SHOW_LIST
ELSEIF RESULT == 1002
	PRINTL 설정을 변경할 던전을 선택해주세요
	CALL FILTER_DUNGEONLIST
	RESTART
ELSEIF RESULT == 1010
	CALL DIARY_DUNGEON_FILTER_MAIN
	PRINTW 일기장 exe 에서 클리어한 던전을 필터링 했습니다
	PRINTL 
	RESTART
ELSEIF RESULT == 1011
	CALL DIARY_DUNGEON_FILTER_ALLOFF
	PRINTW 던전 필터를 전부 해제 했습니다
	PRINTL 
	RESTART
ELSEIF RESULT == 1003 && LOCAL:99 < 5 && LOCAL:((LOCAL:99 + 1) * 리스트표시수()) >= 0
	LOCAL:99 += 1
	GOTO SHOW_LIST
ELSEIF RESULT == 998
	RETURN 0
;ELSEIF RESULT == 999 && FLAG:DEBUG
;	CALL DUNGEON_MAKER
;	RESTART
ELSE
	LOCAL = RESULT
	TRYCCALLFORM PREREQUISITE_DUNGEON_{RESULT}
		SIF RESULT == 0 && FLAG:DEBUG == 0
			GOTO INPUT_LOOP
		RETURN LOCAL
	CATCH
		REUSELASTLINE 
		GOTO INPUT_LOOP
	ENDCATCH
ENDIF
;=====================================================================
;攻略可能던전のリストを필터링する
;=====================================================================
@FILTER_DUNGEONLIST
LOCAL:99 = 0
FOR LOCAL,0,128
	TRYCCALLFORM PREREQUISITE_DUNGEON_{LOCAL}
		IF RESULT || FLAG:DEBUG
			LOCAL:1 = 0
			IF LOCAL <= 63
				SIF GETBIT(FLAG:던전필터1,LOCAL)
					LOCAL:1 = 1
			ELSE
				SIF GETBIT(FLAG:던전필터2,LOCAL - 64)
					LOCAL:1 = 1
			ENDIF
			;色セット
			SIF LOCAL:1
				SETCOLOR 0x990000
			TRYCCALLFORM GET_DUNGEON_NAME_{LOCAL}
			CATCH
				CONTINUE
			ENDCATCH
			PRINTFORMLC [{LOCAL, 2}] %RESULTS, 20, LEFT%
			LOCAL:99++
			RESETCOLOR
		ENDIF
	CATCH
	ENDCATCH
NEXT
PRINTFORM \@ LINEISEMPTY() ? # \n \@
PRINTL [1000] 돌아간다
$INPUT_LOOP
INPUT
IF RESULT == 1000
	RETURN
ELSEIF RESULT >= 0 && RESULT <= 128
	LOCAL = RESULT
	TRYCCALLFORM PREREQUISITE_DUNGEON_{LOCAL}
		IF RESULT || FLAG:DEBUG
			TRYCCALLFORM GET_DUNGEON_NAME_{LOCAL}
			CATCH
				REUSELASTLINE 
				GOTO INPUT_LOOP
			ENDCATCH
			IF LOCAL < 64
				INVERTBIT FLAG:던전필터1,LOCAL
			ELSE
				INVERTBIT FLAG:던전필터2,LOCAL-64
			ENDIF
			REUSELASTLINE 
			RESTART
		ELSE
			REUSELASTLINE 
			GOTO INPUT_LOOP
		ENDIF
	CATCH
		REUSELASTLINE 
		GOTO INPUT_LOOP
	ENDCATCH
ELSE
ENDIF

;=====================================================================
;現在の던전の現在の플로어のANALYZE情報획득
;引数はＸ・Ｙ
;描画速度改善用
;=====================================================================
@GET_FLOOR_ANALYZE_T, ARG, ARG:1
#FUNCTION
;RETURNF DA:ARG:(ARG:1+100)
RETURNF DPOINT("GET" , , ARG , ARG:1 , FLAG:현M , @"던전%TOSTR(FLAG:현던전 , "00")%")

;=====================================================================
;플로어のANALYZE情報設置
;ARGは代入する数値で、
;以降の引数はそれぞれ、던전・階層・Ｘ・Ｙを示す
;=====================================================================
@SET_FLOOR_ANALYZE, ARG, ARG:1, ARG:2, ARG:3, ARG:4
#LOCALSIZE 1
;現在のFLOORのANALYZE情報も同時に更新
CALLF DPOINT("SET" , ARG , ARG:3 , ARG:4 , ARG:2 , @"던전%TOSTR(ARG:1 , "00")%")

;DA:(ARG:3):(ARG:4+100) = ARG
;LOCAL = ARG:3+ARG:4*FLAG:최대X
;SAVESTR:GET_FLOOR_ANALYZE_NUM(ARG:1, ARG:2) = %SUBSTRING(SAVESTR:GET_FLOOR_ANALYZE_NUM(ARG:1, ARG:2), 0, LOCAL)%%TOSTR(ARG)%%SUBSTRING(SAVESTR:GET_FLOOR_ANALYZE_NUM(ARG:1, ARG:2), LOCAL+1)%
RETURN 0

;=====================================================================
;플로어데이터 작성 처리
;인수는 던전 번호
;=====================================================================
@MAKE_FLOOR, ARG
;던전별 플로어데이터를 취득
CALLFORM MAKE_FLOOR_{ARG}
;플로어の기본데이터を체크し、なければセット
;CALL SET_FLOOR_ANALYZE_DEFAULT, ARG, FLAG:현M
;現在の던전の現在の플로어のアナライズ情報を取得する
;CALL SET_FLOOR_ANALYZE_T, ARG, FLAG:현M
;---- D3D 054 START (ADD) ------------------------------
;SIF EQUIP:MASTER:モノスコープ
SIF D3D_WORP == 0
	CALL D3D_AUTOFLIP
D3D_WORP = 0
;---- D3D 054 END   (ADD) ------------------------------
;=====================================================================
;FLOOR_ANALYZE
;플로어전체や部屋をまとめてアナライズする
;ボス部屋などを使う際にどうぞ
;ARG M　ARG:1 X始点 ARG:2 X終点 Y始点 Y終点
;=====================================================================
@FLOOR_ANALYZE, ARG = -1, ARG:1 = -1, ARG:2 = -1, ARG:3 = -1, ARG:4 = -1
#LOCALSIZE 2
ARG = ARG == -1 ? FLAG:현M # ARG
ARG:1 = ARG:1 == -1 ? 0 # ARG:1
ARG:2 = ARG:2 == -1 ? FLAG:최대X # ARG:2
ARG:3 = ARG:3 == -1 ? 0 # ARG:3
ARG:4 = ARG:4 == -1 ? FLAG:최대Y # ARG:4
FOR LOCAL:1, ARG:3, ARG:4
	FOR LOCAL, ARG:1, ARG:2
		CALL SET_FLOOR_ANALYZE, 2, FLAG:현던전, ARG, LOCAL, LOCAL:1
	NEXT
NEXT
;=====================================================================
;현재의 플로어를 묘화
;=====================================================================
@SHOW_FLOOR
#LOCALSIZE 2
#LOCALSSIZE 1
#DIM 개행플래그, 1
CUSTOMDRAWLINE =
CALLFORM FLOORNAME_{FLAG:현던전}
;ALIGNMENT RIGHT
IF FLAG:커스텀게임화면
	PRINTFORML   ￥{MONEY,9}    ＣＯＭＰ용량： {NUM_NAKAMA() + 소프트용량()}/{FLAG:ＣＯＭＰ용량}사용중
	PRINTFORM MAG:{BASE:MASTER:ＭＡＧ,9}    
ELSE
	PRINTFORML   ￥{MONEY,8}    ＣＯＭＰ용량： {NUM_NAKAMA() + 소프트용량()}/{FLAG:ＣＯＭＰ용량}사용중
	PRINTFORM MAG:{BASE:MASTER:ＭＡＧ,8}    
ENDIF
IF FLAG:월령 != 0 && FLAG:월령 != 8
	PRINTFORML {FLAG:월령}/8 \@ FLAG:월령벡터 == 0 ? ＹＯＵＮＧ # ＯＬＤ \@ ＭＯＯＮ
ELSE
	PRINTFORML \@ FLAG:월령 == 8 ? ＦＵＬＬ ＭＯＯＮ # ＮＥＷ ＭＯＯＮ\@
ENDIF
;---- D3D 054 START (ADD) ------------------------------
IF D3D_ACTIVE
; && EQUIP:MASTER:モノスコープ
	ALIGNMENT LEFT
	CALL D3D_SHOW_GRAPHIC
	TRYGOTO D3D_SHOW_FLOOR_FINISH
ENDIF
;---- D3D 054 END   (ADD) ------------------------------
ALIGNMENT CENTER
IF FLAG:최대Y < 18
	FOR LOCAL , 0 , (18 - FLAG:최대Y)/2
		PRINTL
	NEXT
ENDIF

;CALLFORM GET_DUNGEON_NAME_{FLAG:현던전}
CALLF DPOINT( , , 0 , 0 , FLAG:현M , @"던전%TOSTR(FLAG:현던전,"00")%")
FOR LOCAL:1, MAX(0, FLAG:현Y - 9 - MAX(0, ((FLAG:현Y+9)-FLAG:최대Y))), MIN(FLAG:현Y+9+MAX(0, 9-FLAG:현Y), FLAG:최대Y)
;FOR LOCAL:1, MAX(0, FLAG:현Y-20), MIN(FLAG:현Y+20, FLAG:최대Y)
	FOR LOCAL, MAX(0, FLAG:현X - 15 - MAX(0, ((FLAG:현X+15)-FLAG:최대X))), MIN(FLAG:현X+15+MAX(0, 15-FLAG:현X), FLAG:최대X)
		IF FLAG:현X == LOCAL && FLAG:현Y == LOCAL:1
			SETCOLOR 0x33ffcc
			PRINT ＠
			RESETCOLOR
			CONTINUE
		ENDIF
		IF DA:(FLAG:현X):(FLAG:현Y) % 10 == -1 && !((EQUIP:MASTER:다크스캐너 || EQUIP:MASTER:허니・비) && NUM_SUMMONER() ) && FLAG:라이트마 == 0
			SETCOLOR 0x333344
			IF ABS(LOCAL-FLAG:현X)+ABS(LOCAL:1-FLAG:현Y) > 1
				PRINT ？
				RESETCOLOR
				CONTINUE
			ENDIF
		ENDIF
		IF DPOINT( , , LOCAL , LOCAL:1) > 0
			CALL DG_GET_TILE(LOCAL, LOCAL:1, FLAG:현M, FLAG:현던전)
			PRINTFORM %RESULTS%
		ELSE
			PRINT 　
		ENDIF
		RESETCOLOR
	NEXT
	PRINTL
NEXT
ALIGNMENT LEFT

IF FLAG:최대Y < 18
	FOR LOCAL , 0 , (18 - FLAG:최대Y+1)/2
		PRINTL
	NEXT
ENDIF
;---- D3D 054 START (ADD) ------------------------------
$D3D_SHOW_FLOOR_FINISH
;---- D3D 054 END   (ADD) ------------------------------
;---- EDIT 004 DEL START -------------------------
;IF EQUIP:MASTER:에너미소나  && NUM_SUMMONER()
;;	IF FLAG:エンカウント変動 == 1
;;		PRINTFORML 조우율：{(FLAG:인카운트율)/2}％   
;;	ELSEIF FLAG:エンカウント変動 == 2
;;		PRINTFORML 조우율：{(FLAG:인카운트율)*2}％   
;;	ELSE
;		PRINTFORML 조우율：{FLAG:인카운트율}％   
;;	ENDIF
;ENDIF
;---- EDIT 004 DEL END ---------------------------
;---- EDIT 004 ADD START -------------------------
;改行 ;개행플래그
개행플래그 = 0
LOCALS = 

IF EQUIP:MASTER:에너미소나  && NUM_SUMMONER()
	PRINTFORM 조우율：{FLAG:인카운트율, 3}％   
	개행플래그 = 1
ENDIF
IF EQUIP:MASTER:캡스・락  && NUM_SUMMONER()
	PRINT CAPS-LOCK:ON   
	개행플래그 = 1
ENDIF
IF FLAG:에스트마 || FLAG:라이트마 || FLAG:리프트마
	SIF FLAG:에스트마
		PRINT 에스트마 
	SIF FLAG:라이트마
		PRINT 라이트마
	SIF FLAG:리프트마
		PRINT 리프트마 
	PRINT 효과 중
	개행플래그 = 1
ENDIF
;CHK:改行
SIF 개행플래그
	PRINTL 
;---- EDIT 004 ADD END ---------------------------

;=====================================================================
;던전でのコマンドを표시して설정
;=====================================================================
@SHOW_DUNGEON_COMMAND
;PRINTL ＣＯＭＭＡＮＤ                [10]ＩＴＥＭ     [14]ＣＯＭＰ    　[l]ＬＯＧ
;PRINTL         [8]↑                 [11]ＭＡＧＩＣ   [15]ＦＯＲＭ    　[*]%ハート%
;PRINTL [4]← [5]調べる [6]→         [12]ＥＸＴＲＡ   [16]ＳＴＡＴＵＳ  [r]ＲＵＮ
;PRINTL         [2]↓                 [13]ＥＱＵＩＰ   [17]ＭＡＧ
SELECTCASE FLAG:던전내조작설정
	CASE 0
		PRINT ＣＯＭＭＡＮＤ                
		PRINTBUTTON "[i]ＩＴＥＭ" , "i"
		PRINT       
		IF NUM_SUMMONER(1)
			PRINTBUTTON "[c]ＣＯＭＰ　　　" , "c"
		ELSE
			PRINTBUTTON "[c]ＭＥＮＵ　　　" , "c"
		ENDIF
		PRINTBUTTON "[L]ＬＯＧ" , "L"
		PRINTL
		;---- D3D 054 START (MOD) ------------------------------
		IF D3D_ACTIVE
		; && EQUIP:MASTER:モノスコープ
			PRINTBUTTON "[7]←","7"
			PRINT    
			PRINTBUTTON "[8]↑","8"
			PRINT    
			PRINTBUTTON "[9]→","9"
			PRINT          
		ELSE
			PRINT         
			PRINTBUTTON "[8]↑","8"
			PRINT                  
		ENDIF
		;---- D3D 054 END   (MOD) ------------------------------
		PRINTBUTTON "[m]ＭＡＧＩＣ","m"
		PRINT     
		PRINTBUTTON "[f]ＦＯＲＭ　　　","f"
		SIF FLAG:무후후전개
			PRINTBUTTON "[*]" + ハート() , "*"
		PRINTL
		;---- D3D 054 START (MOD) ------------------------------
		IF D3D_ACTIVE
		; && EQUIP:MASTER:モノスコープ
			PRINTBUTTON "[4]＜","4"
		ELSE
			PRINTBUTTON "[4]←","4"
		ENDIF
		PRINT  
		;---- D3D 054 END   (MOD) ------------------------------
		PRINTBUTTON "[5]조  사","5"
		PRINT  
		;---- D3D 054 START (MOD) ------------------------------
		IF D3D_ACTIVE
		; && EQUIP:MASTER:モノスコープ
			PRINTBUTTON "[6]＞","6"
		ELSE
			PRINTBUTTON "[6]→","6"
		ENDIF
		PRINT          
		;---- D3D 054 END   (MOD) ------------------------------
		PRINTBUTTON "[e]ＥＸＴＲＡ","e"
		PRINT     
		PRINTBUTTON "[s]ＳＴＡＴＵＳ　","s"
		IF EQUIP:MASTER:런런던전 == 1 && !FLAG:COMP사용불능
			IF GETBIT(FLAG:232,0)
				PRINTBUTTON "[r]ＲＵＮ ＯＮ","r"
			ELSE
				PRINTBUTTON "[r]ＲＵＮ ＯＦＦ","r"
			ENDIF
		ENDIF
		PRINTL
		;---- D3D 054 START (MOD) ------------------------------
		IF D3D_ACTIVE
		; && EQUIP:MASTER:モノスコープ
			PRINT       
			PRINTBUTTON "[2]Ｖ","2"
			PRINTBUTTON "[0]↓","0"
			PRINT               
			;PRINT                  
		ELSE
			PRINT         
			PRINTBUTTON "[2]↓","2"
			PRINT                  
		ENDIF
		;---- D3D 054 END   (MOD) ------------------------------
		PRINTBUTTON "[E]ＥＱＵＩＰ","E"
		PRINT     
		PRINTBUTTON "[M]ＭＡＧ","M"
		;---- D3D 054 START (ADD) ------------------------------
		;IF EQUIP:MASTER:モノスコープ
			PRINT         
			PRINTBUTTON "[D]３Ｄ？","D"
		;ENDIF
		;---- D3D 054 END   (MOD) ------------------------------
		PRINTL
		CUSTOMDRAWLINE =
		PRINTL
	CASE 1
		PRINT ＣＯＭＭＡＮＤ                
		PRINTBUTTON "[1]ＩＴＥＭ" , "1"
		PRINT       
		IF NUM_SUMMONER(1)
			PRINTBUTTON "[5]ＣＯＭＰ　　　" , "5"
		ELSE
			PRINTBUTTON "[5]ＭＥＮＵ　　　" , "5"
		ENDIF
		PRINTBUTTON "[+]ＬＯＧ" , "+"
		PRINTL
		;---- D3D 054 START (MOD) ------------------------------
		IF D3D_ACTIVE
		; && EQUIP:MASTER:モノスコープ
			PRINTBUTTON "[q]←","q"
			PRINT    
			PRINTBUTTON "[w]↑","w"
			PRINT    
			PRINTBUTTON "[e]→","e"
			PRINT          
		ELSE
			PRINT         
			PRINTBUTTON "[w]↑","w"
			PRINT                  
		ENDIF
		;---- D3D 054 END   (MOD) ------------------------------
		PRINTBUTTON "[2]ＭＡＧＩＣ","2"
		PRINT     
		PRINTBUTTON "[6]ＦＯＲＭ　　　","6"
		SIF FLAG:무후후전개
			PRINTBUTTON "[9]" + ハート() , "9"
		PRINTL
		;---- D3D 054 START (MOD) ------------------------------
		IF D3D_ACTIVE
		; && EQUIP:MASTER:モノスコープ
			PRINTBUTTON "[a]＜","a"
		ELSE
			PRINTBUTTON "[a]←","a"
		ENDIF
		PRINT  
		;---- D3D 054 END   (MOD) ------------------------------
		PRINTBUTTON "[f]조  사","f"
		PRINT  
		;---- D3D 054 START (MOD) ------------------------------
		IF D3D_ACTIVE
		; && EQUIP:MASTER:モノスコープ
			PRINTBUTTON "[d]＞","d"
		ELSE
			PRINTBUTTON "[d]→","d"
		ENDIF
		PRINT          
		;---- D3D 054 END   (MOD) ------------------------------
		PRINTBUTTON "[3]ＥＸＴＲＡ","3"
		PRINT     
		PRINTBUTTON "[7]ＳＴＡＴＵＳ　","7"
		IF EQUIP:MASTER:런런던전 == 1 && !FLAG:COMP사용불능
			IF GETBIT(FLAG:232,0)
				PRINTBUTTON "[r]ＲＵＮ ＯＮ","r"
			ELSE
				PRINTBUTTON "[r]ＲＵＮ ＯＦＦ","r"
			ENDIF
		ENDIF
		PRINTL
		;---- D3D 054 START (MOD) ------------------------------
		IF D3D_ACTIVE
		; && EQUIP:MASTER:モノスコープ
			PRINT       
			PRINTBUTTON "[s]Ｖ","s"
			PRINTBUTTON "[x]↓","x"
			PRINT               
			;PRINT                  
		ELSE
			PRINT         
			PRINTBUTTON "[s]↓","s"
			PRINT                  
		ENDIF
		;---- D3D 054 END   (MOD) --------------------------------
		PRINTBUTTON "[4]ＥＱＵＩＰ","4"
		PRINT     
		PRINTBUTTON "[8]ＭＡＧ","8"
		;---- D3D 054 START (ADD) ------------------------------
		;IF EQUIP:MASTER:モノスコープ
			PRINT         
			PRINTBUTTON "[D]３Ｄ？","D"
		;ENDIF
		;---- D3D 054 END   (MOD) --------------------------------
		PRINTL
		CUSTOMDRAWLINE =
		PRINTL
		CASEELSE
		FLAG:던전내조작설정 = 0
		CALL SHOW_DUNGEON_COMMAND
ENDSELECT
;=====================================================================
;던전攻略のメイン処理
;=====================================================================
@DUNGEON_ATTACK
;---- D3D 054 START (ADD) ------------------------------
#DIM DYNAMIC D3D_TOWALK;WALK_DUNGEON 関数などへ渡すべき数値を保存するDYNAMIC変数
#DIM DYNAMIC D3D_LOCALCOORD,2;一時的に座標値を保存するDYNAMIC変数
;---- D3D 054 END   (ADD) --------------------------------
#LOCALSIZE 1

;종료조건이 충족될때까지 처리를 반복

WHILE 1 == 1
	FLAG:윈도우메시지스킵 = 0
	CALL REFRESH_FORMATION
	$PRINT
	SIF FLAG:던전내조교 == 1
		BREAK
	;탈출플래그가 세워지면 끝
	IF FLAG:탈출
		TRYCALLFORM EVENT_DUNGEON_END_{FLAG:현던전}
		FLAG:탈출스킬금지 = 0
		;-- タルタロスにF.O.E.『刈り取るもの』を追加するパッチ --------
		;地形自動生成やF.O.E.制御関係のフラグやパラメータをクリアする。	※誤って値が残り続けることでの事故防止のため、ここでの初期化自体は常に行うようにする。
		FLAG:지형자동생성・FOE플래그 = 0		;地形の自動生成およびF.O.E.を利用しない		※補足：地形の自動生成およびF.O.E.を利用する던전の場合、この後の「START_DUNGEON_{FLAG:현던전}」の関数内でフラグをONに設定します。
		CALL CD_CLEAR_PARAMETERS				;地形自動生成・F.O.E.制御用の各種パラメータをクリアする
		CALL CD_CREAR_TIME_AND_TURN, 0			;던전内の経過時間・経過ターン数カウントをクリアする
		;-- タルタロスにF.O.E.『刈り取るもの』を追加するパッチ --------
		BREAK
	ENDIF
	REDRAW 0
	;조우율을 읽어들임
	CALLFORM ENCOUNT_RATE_{FLAG:현던전}
	;FLAG:인카운트율 = FLAG:인카운트율 * (100 + FLAG:인카운트율보정) / 100
	;던전을 묘화
	CALL SHOW_FLOOR
	;현 파티 묘화
	CALL SHOW_NOW_FORMATION_P,0,2,,2
	FLAG:커맨드표시행수 = LINECOUNT
	;커맨드 표시
	CALL SHOW_DUNGEON_COMMAND
	
	;입력대기
	$INPUT_LOOP
	ONEINPUTS
	REDRAW 1
	;---- D3D 054 START (ADD) ------------------------------
	IF D3D_ACTIVE
	; && EQUIP:MASTER:モノスコープ
		SELECTCASE RESULTS
			CASE "8","w","7","q","9","e","0","x"
			{
				SIF ((RESULTS == "8" || RESULTS == "7" || RESULTS == "9" || RESULTS == "0") && FLAG:던전내조작설정 != 0)
				 || ((RESULTS == "w" || RESULTS == "q" || RESULTS == "e" || RESULTS == "x") && FLAG:던전내조작설정 != 1)
			}
					GOTO D3D_SKIPNEWINPUT
				IF RESULTS == "8" || RESULTS == "w"
					SELECTCASE D3D_PLAYER_DIRECTION
						CASE 0
							D3D_TOWALK = 8
						CASE 1
							D3D_TOWALK = 6
						CASE 2
							D3D_TOWALK = 2
						CASE 3
							D3D_TOWALK = 4
					ENDSELECT
					CALL D3D_GET_FRONT_COORD(FLAG:현X,FLAG:현Y)
				ELSEIF RESULTS == "7" || RESULTS == "q"
					SELECTCASE D3D_PLAYER_DIRECTION
						CASE 0
							D3D_TOWALK = 4
						CASE 1
							D3D_TOWALK = 8
						CASE 2
							D3D_TOWALK = 6
						CASE 3
							D3D_TOWALK = 2
					ENDSELECT
					CALL D3D_GET_LEFT_COORD(FLAG:현X,FLAG:현Y)
				ELSEIF RESULTS == "9" || RESULTS == "e"
					SELECTCASE D3D_PLAYER_DIRECTION
						CASE 0
							D3D_TOWALK = 6
						CASE 1
							D3D_TOWALK = 2
						CASE 2
							D3D_TOWALK = 4
						CASE 3
							D3D_TOWALK = 8
					ENDSELECT
					CALL D3D_GET_RIGHT_COORD(FLAG:현X,FLAG:현Y)
				ELSEIF RESULTS == "0" || RESULTS == "x"
					SELECTCASE D3D_PLAYER_DIRECTION
						CASE 0
							D3D_TOWALK = 2
						CASE 1
							D3D_TOWALK = 4
						CASE 2
							D3D_TOWALK = 8
						CASE 3
							D3D_TOWALK = 6
					ENDSELECT
					CALL D3D_GET_BEHIND_COORD(FLAG:현X,FLAG:현Y)
				ENDIF
				D3D_LOCALCOORD:0 = RESULT:0,RESULT:1
				;ここから一般化コードにしてもいいかな
				IF GETBIT(FLAG:232,0) == 0
					;歩いて探索
					IF D3D_IS_MAPRANGE(D3D_TOWALK) != 1
						CLEARLINE 1
						GOTO PRINT
					ENDIF
					CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, D3D_LOCALCOORD:0, D3D_LOCALCOORD:1)
					CALLFORM CAN_ENTER_{FLAG:현던전},D3D_LOCALCOORD:0,D3D_LOCALCOORD:1
					IF RESULT == 0
						CLEARLINE 1
						GOTO PRINT
					ENDIF
					CALL WALK_DUNGEON,D3D_TOWALK
				ELSE
					;런런던전
					;非D3D(既存)移動の方をそのまま移植
					;マップ端っこなら進めない
					IF D3D_IS_MAPRANGE(D3D_TOWALK) != 1
						CLEARLINE 1
						GOTO PRINT
					ENDIF
					;壁とかだったら進めない
					CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, D3D_LOCALCOORD:0, D3D_LOCALCOORD:1)
					CALLFORM CAN_ENTER_{FLAG:현던전},D3D_LOCALCOORD:0,D3D_LOCALCOORD:1
					IF RESULT == 0
						CLEARLINE 1
						GOTO PRINT
					ENDIF
					;ここから２マス目の判定開始
					IF D3D_IS_MAPRANGE(D3D_TOWALK,1) != 1
						;2マス目がマップ端っこなら進めない
						CALL WALK_DUNGEON,D3D_TOWALK
						RESTART
					ENDIF
					CALL D3D_GET_FRONT_COORD(FLAG:현X,FLAG:현Y)
					CALL D3D_GET_FRONT_COORD(RESULT:0,RESULT:1)
					D3D_LOCALCOORD:0 = RESULT:0,RESULT:1
					CALLFORM CAN_ENTER_{FLAG:현던전},D3D_LOCALCOORD:0,D3D_LOCALCOORD:1
					IF RESULT == 0
						;2マス目が壁とかだったら歩く
						CALL WALK_DUNGEON,D3D_TOWALK
					ELSE
						CALL DUNGEON_RUNRUN_CHECK,D3D_TOWALK
						IF RESULT == 0
							CALL WALK_DUNGEON,D3D_TOWALK
						ELSE
							CALL SET_FLOOR_ANALYZE(2,FLAG:현던전, FLAG:현M, D3D_LOCALCOORD:0, D3D_LOCALCOORD:1)
							;それ以外の時に初めて走る
							CALL RUN_DUNGEON,D3D_TOWALK
						ENDIF
					ENDIF
				ENDIF
			CASE "4","a"
				SIF (RESULTS == "4" && FLAG:던전내조작설정 != 0) || (RESULTS == "a" && FLAG:던전내조작설정 != 1)
					GOTO D3D_SKIPNEWINPUT
				CALL D3D_CHANGE_DIRECTION(-1)
				CLEARLINE 1
				GOTO PRINT
			CASE "6","d"
				SIF (RESULTS == "6" && FLAG:던전내조작설정 != 0) || (RESULTS == "d" && FLAG:던전내조작설정 != 1)
					GOTO D3D_SKIPNEWINPUT
				CALL D3D_CHANGE_DIRECTION(1)
				CLEARLINE 1
				GOTO PRINT
			CASE "2","s"
				SIF (RESULTS == "2" && FLAG:던전내조작설정 != 0) || (RESULTS == "s" && FLAG:던전내조작설정 != 1)
					GOTO D3D_SKIPNEWINPUT
				CALL D3D_CHANGE_DIRECTION(2)
				CLEARLINE 1
				GOTO PRINT
			CASE "D"
				D3D_ACTIVE = 0
				CLEARLINE 1
				GOTO PRINT
			CASEELSE
				GOTO D3D_SKIPNEWINPUT
		ENDSELECT
		RESTART
	ENDIF
	$D3D_SKIPNEWINPUT
	;---- D3D 054 END   (ADD) --------------------------------
	SELECTCASE FLAG:던전내조작설정
		CASE 0
			SELECTCASE RESULTS
				CASE "5"
					SELECTCASE DA:(FLAG:현X):(FLAG:현Y)
						CASE -9
							CALL DUNGEON_TERMINAL
						CASE -19
							CALL FOUNTAIN_OF_TRISH
						CASE -29
							CALL DUNGEON_ELEVATOR
						CASEELSE
							CALLFORM EVENT_CHECK_DUNGEON_{FLAG:현던전}
					ENDSELECT
					;-- 던전32:不思議な던전 --------
					;「5」キーを押下してその場で待機の場合も敵シンボルが動く
					IF FLAG:지형자동생성・FOE플래그 == 1
						CALL SEF_SYMBOL_CHARA_ACTION
					ENDIF
					;-- 던전32:不思議な던전 --------
				CASE "8"
					;ランランンジョンの판정
					IF GETBIT(FLAG:232,0) == 0
						;歩いて탐색
						IF !RANGE(FLAG:현Y-1, 0, FLAG:최대Y-1)
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X, FLAG:현Y-1)
						CALLFORM CAN_ENTER_{FLAG:현던전},FLAG:현X,FLAG:현Y-1
						IF RESULT == 0
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						CALL WALK_DUNGEON,8
					ELSE
						;走って탐색
						;１マス눈の侵入可能판정開始
						;マップ端っこなら進めない
						IF !RANGE(FLAG:현Y-1, 0, FLAG:최대Y-1)
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						;壁とかだったら進めない
						CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X, FLAG:현Y-1)
						CALLFORM CAN_ENTER_{FLAG:현던전},FLAG:현X,FLAG:현Y-1
						IF RESULT == 0
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						;1マス눈は侵入可能
						;ついで2マス눈の侵入可能판정開始						
						IF !RANGE(FLAG:현Y-2, 0, FLAG:최대Y-1)
							;2マス눈がマップ端っこなら歩く
							CALL WALK_DUNGEON,8
							RESTART
						ENDIF
						CALLFORM CAN_ENTER_{FLAG:현던전},FLAG:현X,FLAG:현Y-2
						IF RESULT == 0
							;2マス눈が壁とかだったら歩く
							CALL WALK_DUNGEON,8
						ELSE
							CALL DUNGEON_RUNRUN_CHECK,8
							IF RESULT == 0
							CALL WALK_DUNGEON,8
							ELSE
							CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X, FLAG:현Y-2)
							;それ以外の時に初めて走る
							CALL RUN_DUNGEON,8
							ENDIF
						ENDIF
					ENDIF
				CASE "4"
					;ランランンジョンの판정
					IF GETBIT(FLAG:232,0) == 0
						;歩いて탐색
						IF !RANGE(FLAG:현X-1, 0, FLAG:최대X-1)
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X-1, FLAG:현Y)
						CALLFORM CAN_ENTER_{FLAG:현던전},FLAG:현X-1,FLAG:현Y
						IF RESULT == 0
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						CALL WALK_DUNGEON,4
					ELSE
						;走って탐색
						;１マス눈の侵入可能판정開始
						;マップ端っこなら進めない
						IF !RANGE(FLAG:현X-1, 0, FLAG:최대X-1)
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						;壁とかだったら進めない
						CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X-1, FLAG:현Y)
						CALLFORM CAN_ENTER_{FLAG:현던전},FLAG:현X-1,FLAG:현Y
						IF RESULT == 0
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						;1マス눈は侵入可能
						;ついで2マス눈の侵入可能판정開始
						IF !RANGE(FLAG:현X-2, 0, FLAG:최대X-1)
							;2マス눈がマップ端っこなら歩く
							CALL WALK_DUNGEON,4
							RESTART
						ENDIF
						CALLFORM CAN_ENTER_{FLAG:현던전},FLAG:현X-2,FLAG:현Y
						IF RESULT == 0
							;2マス눈が壁とかだったら歩く
							CALL WALK_DUNGEON,4
						ELSE
							CALL DUNGEON_RUNRUN_CHECK,4
							IF RESULT == 0
							CALL WALK_DUNGEON,4
							ELSE
							CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X-2, FLAG:현Y)
							;それ以外の時に初めて走る
							CALL RUN_DUNGEON,4
							ENDIF
						ENDIF
					ENDIF
				CASE "6"
					;ランランンジョンの판정
					IF GETBIT(FLAG:232,0) == 0
						;歩いて탐색
						IF !RANGE(FLAG:현X+1, 0, FLAG:최대X-1)
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X+1, FLAG:현Y)
						CALLFORM CAN_ENTER_{FLAG:현던전},FLAG:현X+1,FLAG:현Y
						IF RESULT == 0
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						CALL WALK_DUNGEON,6
					ELSE
						;走って탐색
						;１マス눈の侵入可能판정開始
						;マップ端っこなら進めない
						IF !RANGE(FLAG:현X+1, 0, FLAG:최대X-1)
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						;壁とかだったら進めない
						CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X+1, FLAG:현Y)
						CALLFORM CAN_ENTER_{FLAG:현던전},FLAG:현X+1,FLAG:현Y
						IF RESULT == 0
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						;1マス눈は侵入可能
						;ついで2マス눈の侵入可能판정開始
						IF !RANGE(FLAG:현X+2, 0, FLAG:최대X-1)
							;2マス눈がマップ端っこなら歩く
							CALL WALK_DUNGEON,6
							RESTART
						ENDIF
						CALLFORM CAN_ENTER_{FLAG:현던전},FLAG:현X+2,FLAG:현Y
						IF RESULT == 0
							;2マス눈が壁とかだったら歩く
							CALL WALK_DUNGEON,6
						ELSE
							CALL DUNGEON_RUNRUN_CHECK,6
							IF RESULT == 0
							CALL WALK_DUNGEON,6
							ELSE
							;それ以外の時に初めて走る
							CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X+2, FLAG:현Y)
							CALL RUN_DUNGEON,6
							ENDIF
						ENDIF
					ENDIF
				CASE "2"
					;ランランンジョンの판정
					IF GETBIT(FLAG:232,0) == 0
						;歩いて탐색
						IF !RANGE(FLAG:현Y+1, 0, FLAG:최대Y-1)
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X, FLAG:현Y+1)
						CALLFORM CAN_ENTER_{FLAG:현던전},FLAG:현X,FLAG:현Y+1
						IF RESULT == 0
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						CALL WALK_DUNGEON,2
					ELSE
						;走って탐색
						;１マス눈の侵入可能판정開始
						;マップ端っこなら進めない
						IF !RANGE(FLAG:현Y+1, 0, FLAG:최대Y-1)
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						;壁とかだったら進めない
						CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X, FLAG:현Y+1)
						CALLFORM CAN_ENTER_{FLAG:현던전},FLAG:현X,FLAG:현Y+1
						IF RESULT == 0
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						;1マス눈は侵入可能
						;ついで2マス눈の侵入可能판정開始
						IF !RANGE(FLAG:현Y+2, 0, FLAG:최대Y-1)
							;2マス눈がマップ端っこなら歩く
							CALL WALK_DUNGEON,2
							RESTART
						ENDIF
						CALLFORM CAN_ENTER_{FLAG:현던전},FLAG:현X,FLAG:현Y+2
						IF RESULT == 0
							;2マス눈が壁とかだったら歩く
							CALL WALK_DUNGEON,2
						ELSE
							CALL DUNGEON_RUNRUN_CHECK,2
							IF RESULT == 0
							CALL WALK_DUNGEON,2
							ELSE
							;それ以外の時に初めて走る
							CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X, FLAG:현Y+2)
							CALL RUN_DUNGEON,2
							ENDIF
						ENDIF
					ENDIF
					CASE "c"
					;IF NUM_SUMMONER(1) == 0
					;	PRINTW 誰もＣＯＭＰを使えない
					;	CLEARLINE 2
					;	GOTO INPUT_LOOP
					;ENDIF
					CALL COMMAND_COMP_FIELD
				CASE "i"
					CALL COMMAND_ITEM_FIELD
				CASE "m"
					CALL COMMAND_MAGIC_FIELD_LIST,2
				CASE "e"
					CALL COMMAND_MAGIC_FIELD_LIST,1
				CASE "0", "U", "V", "W", "X", "Y", "Z"
					IF RESULTS == "0"
						ONEINPUTS
						LOCAL = TOINT(RESULTS)
					ELSE
						SELECTCASE RESULTS
							CASE "U"
								LOCAL = 1
							CASE "V"
								LOCAL = 2
							CASE "W"
								LOCAL = 3
							CASE "X"
								LOCAL = 4
							CASE "Y"
								LOCAL = 5
							CASE "Z"
								LOCAL = 6
						ENDSELECT
					ENDIF
					IF RANGE(LOCAL, 1, 6) && POS(LOCAL) >= 0
						CALL COMMAND_MAGIC_FIELD, 2, POS(LOCAL), 1
					ELSE
						CLEARLINE 2
					ENDIF
				CASE "E"
					CALL EQUIPMENT
				CASE "f"
					CALL FORM_INPUT
				CASE "s"
					CALL SHOP_COM_301
				CASE "M"
					CALL SWITCH_MAG
				CASE "*"
					CALL DUNGEON_MUFUFU
				CASE "r"
					CALL DUNGEON_RUNRUN
				CASE "L"
					CALL MESSAGE_WINDOW_LOG(, , , , , 1)
				;---- D3D 054 START (ADD) ------------------------------
				CASE "D"
					;IF EQUIP:MASTER:モノスコープ
						D3D_ACTIVE = 1
						CLEARLINE 1
						GOTO PRINT
					;ENDIF
				;---- D3D 054 END   (ADD) --------------------------------
				CASEELSE
					GOTO INPUT_LOOP
			ENDSELECT
		CASE 1
			SELECTCASE RESULTS
				CASE "f"
					SELECTCASE DA:(FLAG:현X):(FLAG:현Y)
						CASE -9
							CALL DUNGEON_TERMINAL
						CASE -19
							CALL FOUNTAIN_OF_TRISH
						CASE -29
							CALL DUNGEON_ELEVATOR
						CASEELSE
							CALLFORM EVENT_CHECK_DUNGEON_{FLAG:현던전}
					ENDSELECT
				CASE "w"
					;ランランンジョンの판정
					IF GETBIT(FLAG:232,0) == 0
						;歩いて탐색
						IF !RANGE(FLAG:현Y-1, 0, FLAG:최대Y-1)
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X, FLAG:현Y-1)
						CALLFORM CAN_ENTER_{FLAG:현던전},FLAG:현X,FLAG:현Y-1
						IF RESULT == 0
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						CALL WALK_DUNGEON,8
					ELSE
						;走って탐색
						;１マス눈の侵入可能판정開始
						;マップ端っこなら進めない
						IF !RANGE(FLAG:현Y-1, 0, FLAG:최대Y-1)
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						;壁とかだったら進めない
						CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X, FLAG:현Y-1)
						CALLFORM CAN_ENTER_{FLAG:현던전},FLAG:현X,FLAG:현Y-1
						IF RESULT == 0
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						;1マス눈は侵入可能
						;ついで2マス눈の侵入可能판정開始						
						IF !RANGE(FLAG:현Y-2, 0, FLAG:최대Y-1)
							;2マス눈がマップ端っこなら歩く
							CALL WALK_DUNGEON,8
							RESTART
						ENDIF
						CALLFORM CAN_ENTER_{FLAG:현던전},FLAG:현X,FLAG:현Y-2
						IF RESULT == 0
							;2マス눈が壁とかだったら歩く
							CALL WALK_DUNGEON,8
						ELSE
							CALL DUNGEON_RUNRUN_CHECK,8
							IF RESULT == 0
							CALL WALK_DUNGEON,8
							ELSE
							CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X, FLAG:현Y-2)
							;それ以外の時に初めて走る
							CALL RUN_DUNGEON,8
							ENDIF
						ENDIF
					ENDIF
				CASE "a"
					;ランランンジョンの판정
					IF GETBIT(FLAG:232,0) == 0
						;歩いて탐색
						IF !RANGE(FLAG:현X-1, 0, FLAG:최대X-1)
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X-1, FLAG:현Y)
						CALLFORM CAN_ENTER_{FLAG:현던전},FLAG:현X-1,FLAG:현Y
						IF RESULT == 0
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						CALL WALK_DUNGEON,4
					ELSE
						;走って탐색
						;１マス눈の侵入可能판정開始
						;マップ端っこなら進めない
						IF !RANGE(FLAG:현X-1, 0, FLAG:최대X-1)
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						;壁とかだったら進めない
						CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X-1, FLAG:현Y)
						CALLFORM CAN_ENTER_{FLAG:현던전},FLAG:현X-1,FLAG:현Y
						IF RESULT == 0
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						;1マス눈は侵入可能
						;ついで2マス눈の侵入可能판정開始
						IF !RANGE(FLAG:현X-2, 0, FLAG:최대X-1)
							;2マス눈がマップ端っこなら歩く
							CALL WALK_DUNGEON,4
							RESTART
						ENDIF
						CALLFORM CAN_ENTER_{FLAG:현던전},FLAG:현X-2,FLAG:현Y
						IF RESULT == 0
							;2マス눈が壁とかだったら歩く
							CALL WALK_DUNGEON,4
						ELSE
							CALL DUNGEON_RUNRUN_CHECK,4
							IF RESULT == 0
							CALL WALK_DUNGEON,4
							ELSE
							CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X-2, FLAG:현Y)
							;それ以外の時に初めて走る
							CALL RUN_DUNGEON,4
							ENDIF
						ENDIF
					ENDIF
				CASE "d"
					;ランランンジョンの판정
					IF GETBIT(FLAG:232,0) == 0
						;歩いて탐색
						IF !RANGE(FLAG:현X+1, 0, FLAG:최대X-1)
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X+1, FLAG:현Y)
						CALLFORM CAN_ENTER_{FLAG:현던전},FLAG:현X+1,FLAG:현Y
						IF RESULT == 0
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						CALL WALK_DUNGEON,6
					ELSE
						;走って탐색
						;１マス눈の侵入可能판정開始
						;マップ端っこなら進めない
						IF !RANGE(FLAG:현X+1, 0, FLAG:최대X-1)
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						;壁とかだったら進めない
						CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X+1, FLAG:현Y)
						CALLFORM CAN_ENTER_{FLAG:현던전},FLAG:현X+1,FLAG:현Y
						IF RESULT == 0
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						;1マス눈は侵入可能
						;ついで2マス눈の侵入可能판정開始
						IF !RANGE(FLAG:현X+2, 0, FLAG:최대X-1)
							;2マス눈がマップ端っこなら歩く
							CALL WALK_DUNGEON,6
							RESTART
						ENDIF
						CALLFORM CAN_ENTER_{FLAG:현던전},FLAG:현X+2,FLAG:현Y
						IF RESULT == 0
							;2マス눈が壁とかだったら歩く
							CALL WALK_DUNGEON,6
						ELSE
							CALL DUNGEON_RUNRUN_CHECK,6
							IF RESULT == 0
							CALL WALK_DUNGEON,6
							ELSE
							;それ以外の時に初めて走る
							CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X+2, FLAG:현Y)
							CALL RUN_DUNGEON,6
							ENDIF
						ENDIF
					ENDIF
				CASE "s"
					;ランランンジョンの판정
					IF GETBIT(FLAG:232,0) == 0
						;歩いて탐색
						IF !RANGE(FLAG:현Y+1, 0, FLAG:최대Y-1)
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X, FLAG:현Y+1)
						CALLFORM CAN_ENTER_{FLAG:현던전},FLAG:현X,FLAG:현Y+1
						IF RESULT == 0
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						CALL WALK_DUNGEON,2
					ELSE
						;走って탐색
						;１マス눈の侵入可能판정開始
						;マップ端っこなら進めない
						IF !RANGE(FLAG:현Y+1, 0, FLAG:최대Y-1)
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						;壁とかだったら進めない
						CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X, FLAG:현Y+1)
						CALLFORM CAN_ENTER_{FLAG:현던전},FLAG:현X,FLAG:현Y+1
						IF RESULT == 0
							CLEARLINE 1
							GOTO PRINT
						ENDIF
						;1マス눈は侵入可能
						;ついで2マス눈の侵入可能판정開始
						IF !RANGE(FLAG:현Y+2, 0, FLAG:최대Y-1)
							;2マス눈がマップ端っこなら歩く
							CALL WALK_DUNGEON,2
							RESTART
						ENDIF
						CALLFORM CAN_ENTER_{FLAG:현던전},FLAG:현X,FLAG:현Y+2
						IF RESULT == 0
							;2マス눈が壁とかだったら歩く
							CALL WALK_DUNGEON,2
						ELSE
							CALL DUNGEON_RUNRUN_CHECK,2
							IF RESULT == 0
							CALL WALK_DUNGEON,2
							ELSE
							;それ以外の時に初めて走る
							CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X, FLAG:현Y+2)
							CALL RUN_DUNGEON,2
							ENDIF
						ENDIF
					ENDIF
				CASE "5"
					;IF NUM_SUMMONER(1) == 0
					;	PRINTW 誰もＣＯＭＰを使えない
					;	CLEARLINE 2
					;	GOTO INPUT_LOOP
					;ENDIF
					CALL COMMAND_COMP_FIELD
				CASE "0"
					IF RESULTS == "0"
						ONEINPUTS
						LOCAL = TOINT(RESULTS)
					ELSE
						SELECTCASE RESULTS
							CASE "U"
								LOCAL = 1
							CASE "V"
								LOCAL = 2
							CASE "W"
								LOCAL = 3
							CASE "X"
								LOCAL = 4
							CASE "Y"
								LOCAL = 5
							CASE "Z"
								LOCAL = 6
						ENDSELECT
					ENDIF
					IF RANGE(LOCAL, 1, 6) && POS(LOCAL) >= 0
						CALL COMMAND_MAGIC_FIELD, 2, POS(LOCAL), 1
					ELSE
						CLEARLINE 2
					ENDIF
				CASE "1"
					CALL COMMAND_ITEM_FIELD
				CASE "2"
					CALL COMMAND_MAGIC_FIELD_LIST,2
				CASE "3"
					CALL COMMAND_MAGIC_FIELD_LIST,1
				CASE "4"
					CALL EQUIPMENT
				CASE "6"
					CALL FORM_INPUT
				CASE "7"
					CALL SHOP_COM_301
				CASE "8"
					CALL SWITCH_MAG
				CASE "9"
					CALL DUNGEON_MUFUFU
				CASE "r"
					CALL DUNGEON_RUNRUN
				CASE "+"
					CALL MESSAGE_WINDOW_LOG(, , , , , 1)
				;---- D3D 054 START (ADD) ------------------------------
				CASE "D"
					;IF EQUIP:MASTER:モノスコープ
						D3D_ACTIVE = 1
						CLEARLINE 1
						GOTO PRINT
					;ENDIF
				;---- D3D 054 END   (ADD) --------------------------------
				CASEELSE
					GOTO INPUT_LOOP
			ENDSELECT
		CASEELSE
		FLAG:던전내조작설정 = 0
		GOTO PRINT
	ENDSELECT
WEND

;=====================================================================
;隊列변경입력
;=====================================================================

@FORM_INPUT
DRAWLINE
PRINTL [0] 전후 바꿈 [1] 포지션 변경 [1000] 돌아간다
$INPUT_LOOP_FORM
INPUT
IF RESULT == 0
	CALL CHANGE_POS,1,6
	CALL CHANGE_POS,2,5
	CALL CHANGE_POS,3,4
ELSEIF RESULT == 1
	CALL SETUP_FORMATION
ELSEIF RESULT == 1000
	RETURN 0
ELSE
	GOTO INPUT_LOOP_FORM
ENDIF

RETURN 1

;=====================================================================
;歩いて移動
;=====================================================================
@WALK_DUNGEON,ARG
LOCAL = 0
SELECTCASE ARG
	CASE 8
		FLAG:현Y -= 1
	CASE 4
		FLAG:현X -= 1
	CASE 6
		FLAG:현X += 1
	CASE 2
		FLAG:현Y += 1
ENDSELECT

;ＭＡＧ소비
CALL CONSUME_MAG

;ガリバーマジック
IF EQUIP:MASTER:걸리버・매직 == 1 && !FLAG:COMP사용불능
	FOR LOCAL,1,7
		LOCALS = 포지션{LOCAL}
		IF FLAG:LOCALS > -1 && TALENT:(FLAG:LOCALS):서머너 && (TALENT:(FLAG:LOCALS):이능자 == 0 && TALENT:(FLAG:LOCALS):페르소나구사자 == 0 && CFLAG:(FLAG:LOCALS):악마변신 == 0 && TALENT:(FLAG:LOCALS):달인 == 0)
			SELECTCASE GET_STATE(CFLAG:(FLAG:LOCALS):상태이상)
				CASE "DYING","STONE","FLY","PALYZE","BIND","CHARM","SLEEP","PANIC"
					CONTINUE
				CASEELSE
					CALL VAR_HP,FLAG:LOCALS,1,3
			ENDSELECT
		ENDIF
	NEXT
ENDIF

CALL AUTOMAP
;毒などの체크
FOR LOCAL,1,7
	LOCALS = 포지션{LOCAL}
	IF FLAG:LOCALS > -1
		LOCAL:1 = FLAG:LOCALS
		IF FLAG:무후후전개
	
			;一歩ごとに체력が5회복する（최대値は기력の現在値）
			SIF BASE:(LOCAL:1):체력 < BASE:(LOCAL:1):기력
				BASE:(LOCAL:1):체력 += 5
			
			;CFLAG:던전내발정용욕정치が15000以下の場合
			IF CFLAG:(LOCAL:1):던전내발정용욕정치 < 15000
				;정액の箇所ひとつに付き욕정が정액중독ＬＶ分増える
				CFLAG:(LOCAL:1):던전내발정용욕정치 += GET_STAIN("질내" , "정액" , LOCAL:1) * ABL:(LOCAL:1):정액중독
				CFLAG:(LOCAL:1):던전내발정용욕정치 += GET_STAIN("바기나" , "정액" , LOCAL:1) * ABL:(LOCAL:1):정액중독
				CFLAG:(LOCAL:1):던전내발정용욕정치 += GET_STAIN("입" , "정액" , LOCAL:1) * ABL:(LOCAL:1):정액중독
				CFLAG:(LOCAL:1):던전내발정용욕정치 += GET_STAIN("손" , "정액" , LOCAL:1) * ABL:(LOCAL:1):정액중독
				CFLAG:(LOCAL:1):던전내발정용욕정치 += GET_STAIN("가슴" , "정액" , LOCAL:1) * ABL:(LOCAL:1):정액중독
				CFLAG:(LOCAL:1):던전내발정용욕정치 += GET_STAIN("애널" , "정액" , LOCAL:1) * ABL:(LOCAL:1):정액중독
				CFLAG:(LOCAL:1):던전내발정용욕정치 += GET_STAIN("머리카락" , "정액" , LOCAL:1) * ABL:(LOCAL:1):정액중독

				;アソコと유두が노출していると노출증ＬＶ分욕정が増える
				SIF TEQUIP:(LOCAL:1):유두노출 == -1
					CFLAG:(LOCAL:1):던전내발정용욕정치 += ABL:(LOCAL:1):노출증
				SIF TEQUIP:(LOCAL:1):음순노출 == -1
					CFLAG:(LOCAL:1):던전내발정용욕정치 += ABL:(LOCAL:1):노출증

				SIF 위험일(LOCAL:1) == 2
					CFLAG:(LOCAL:1):던전내발정용욕정치 += 2 * ABL:(LOCAL:1):욕망
				;CFLAG:던전내발정용욕정치の上限は15000
				SIF CFLAG:(LOCAL:1):던전내발정용욕정치 > 15000
					CFLAG:(LOCAL:1):던전내발정용욕정치 = 15000
			ENDIF
			
			;질내が정액で불결ている場合は10％の확률で바기나に불결が付く
			IF GET_STAIN("질내" , "정액" , LOCAL:1) && GET_STAIN("바기나" , "정액" , LOCAL:1) == 0 && RAND:100 < 10
				SETCOLOR COLOR("pink")
				PRINTFORMW %CALLNAME:(LOCAL:1)% 보지에 쏟아진 정액이 흘러나왔다…
				RESETCOLOR
				CALL SET_STAIN("바기나" , "정액" , LOCAL:1)
				;三分の一の確立で질내の불결소거
				SIF RAND:3 == 0
					STAIN:(LOCAL:1):질내 = 0
			ENDIF
		
			;욕정一定値以下で発情終了
			IF  CFLAG:(LOCAL:1):던전내발정용욕정치 < 2000 && CFLAG:(LOCAL:1):던전내발정
				CFLAG:(LOCAL:1):던전내발정 = 0
				PRINTFORMW %조사처리(CALLNAME:(LOCAL:1),"는")% 침착해졌다
			ENDIF
	
			;욕정が10000以上になると発情
			IF (!TALENT:(LOCAL:1):남자 || TALENT:(LOCAL:1):오토코노코) && !CFLAG:(LOCAL:1):던전내발정 && CFLAG:(LOCAL:1):던전내발정용욕정치 >= 10000
				CFLAG:(LOCAL:1):던전내발정 = 1
				CALL SET_STAIN("질내" , "애액" , LOCAL:1)
				CALL SET_STAIN("바기나" , "애액" , LOCAL:1)
				SETCOLOR COLOR("pink")
				PRINTFORMW %조사처리(CALLNAME:(LOCAL:1),"는")% 머릿속이 핑크색으로 물들었다
				RESETCOLOR
			;発情상태の時に30％の확률でHAPPYになる
			ELSEIF RAND:100 < 30 && CFLAG:(LOCAL:1):던전내발정 && CFLAG:(LOCAL:1):상태이상 != GET_STATE_NUM("HAPPY")
				CFLAG:(LOCAL:1):상태이상 = GET_STATE_NUM("HAPPY")
			ENDIF
			;素質『발정가능』を持っていると魅了상태時に10％の확률で発情する
			IF TALENT:(LOCAL:1):남자 == 0 && CFLAG:(LOCAL:1):상태이상 == GET_STATE_NUM("CHARM") && TALENT:(LOCAL:1):발정가능 && CFLAG:(LOCAL:1):던전내발정 == 0 && RAND:100 < 10
				CFLAG:(LOCAL:1):던전내발정 = 1
				CALL SET_STAIN("질내" , "애액" , LOCAL:1)
				CALL SET_STAIN("바기나" , "애액" , LOCAL:1)
				SETCOLOR COLOR("pink")
				PRINTFORMW %조사처리(CALLNAME:(LOCAL:1),"는")% 머릿속이 핑크색으로 물들었다
				RESETCOLOR
			ENDIF

			;당신밀려넘어짐이벤트　仲魔が発情상태の時に指定확률で당신を押し倒す
			;설정と조건に該当したら FLAG:밀려넘어짐이벤트, 40 を立てて本処理を実行
			;↓はテスト用、これにすると押し倒し祭り
			;IF GETBIT(FLAG:밀려넘어짐이벤트,0) && RAND:100 < FLAG:밀려넘어짐이벤트발생률 && CFLAG:(LOCAL:1):던전내발정 == 0
			IF GETBIT(FLAG:밀려넘어짐이벤트,0) && RAND:100 < FLAG:밀려넘어짐이벤트발생률 && CFLAG:(LOCAL:1):던전내발정
				CLEARBIT FLAG:밀려넘어짐이벤트, 40
				;女 → 男
				IF     GETBIT(FLAG:밀려넘어짐이벤트,1)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 0 && TALENT:(LOCAL:1):후타나리 == 0 &&TALENT:(LOCAL:1):처녀 == 0 && TALENT:(LOCAL:1):재생처녀 == 0 && TALENT:(MASTER):남자 == 1 && TALENT:(MASTER):오토코노코 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;双女→ 男
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,2)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 0 && TALENT:(LOCAL:1):후타나리 == 1 && TALENT:(LOCAL:1):처녀 == 0 && TALENT:(LOCAL:1):재생처녀 == 0 && TALENT:(MASTER):남자 == 1 && TALENT:(MASTER):오토코노코 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;男 → 男
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,3)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 1 && TALENT:(LOCAL:1):오토코노코 == 0 && TALENT:(MASTER):남자 == 1 && TALENT:(MASTER):오토코노코 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;男娘→ 男 
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,4)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 1 && TALENT:(LOCAL:1):오토코노코 == 1 && TALENT:(MASTER):남자 == 1 && TALENT:(MASTER):오토코노코 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;女 → 女
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,5)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 0 && TALENT:(LOCAL:1):후타나리 == 0 && TALENT:(LOCAL:1):처녀 == 0 && TALENT:(LOCAL:1):재생처녀 == 0 && TALENT:(MASTER):남자 == 0 && TALENT:(MASTER):후타나리 == 0 &&TALENT:(MASTER):처녀 == 0 && TALENT:(MASTER):재생처녀 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;双女→ 女
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,6)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 0 && TALENT:(LOCAL:1):후타나리 == 1 && TALENT:(LOCAL:1):처녀 == 0 && TALENT:(LOCAL:1):재생처녀 == 0 && TALENT:(MASTER):남자 == 0 && TALENT:(MASTER):후타나리 == 0 &&TALENT:(MASTER):처녀 == 0 && TALENT:(MASTER):재생처녀 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;男 → 女
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,7)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 1 && TALENT:(LOCAL:1):오토코노코 == 0 && TALENT:(MASTER):남자 == 0 && TALENT:(MASTER):후타나리 == 0 &&TALENT:(MASTER):처녀 == 0 && TALENT:(MASTER):재생처녀 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;男娘→ 女
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,8)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 1 && TALENT:(LOCAL:1):오토코노코 == 1 && TALENT:(MASTER):남자 == 0 && TALENT:(MASTER):후타나리 == 0 &&TALENT:(MASTER):처녀 == 0 && TALENT:(MASTER):재생처녀 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;女 →男娘
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,9)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 0 && TALENT:(LOCAL:1):후타나리 == 0 && TALENT:(LOCAL:1):처녀 == 0 && TALENT:(LOCAL:1):재생처녀 == 0 && TALENT:(MASTER):남자 == 1 && TALENT:(MASTER):오토코노코 == 1
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;双女→男娘
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,10) && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 0 && TALENT:(LOCAL:1):후타나리 == 1 && TALENT:(LOCAL:1):처녀 == 0 && TALENT:(LOCAL:1):재생처녀 == 0 && TALENT:(MASTER):남자 == 1 && TALENT:(MASTER):오토코노코 == 1
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;男 →男娘 
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,11) && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 1 && TALENT:(LOCAL:1):오토코노코 == 0 && TALENT:(MASTER):남자 == 1 && TALENT:(MASTER):오토코노코 == 1
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;男娘→男娘
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,12) && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 1 && TALENT:(LOCAL:1):오토코노코 == 1 && TALENT:(MASTER):남자 == 1 && TALENT:(MASTER):오토코노코 == 1
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;女 →双女 
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,13) && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 0 && TALENT:(LOCAL:1):후타나리 == 0 && TALENT:(LOCAL:1):처녀 == 0 && TALENT:(LOCAL:1):재생처녀 == 0 && TALENT:(MASTER):남자 == 0 && TALENT:(MASTER):후타나리 == 1 &&TALENT:(MASTER):처녀 == 0 && TALENT:(MASTER):재생처녀 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;双女→双女
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,14) && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 0 && TALENT:(LOCAL:1):후타나리 == 1 && TALENT:(LOCAL:1):처녀 == 0 && TALENT:(LOCAL:1):재생처녀 == 0 && TALENT:(MASTER):남자 == 0 && TALENT:(MASTER):후타나리 == 1 &&TALENT:(MASTER):처녀 == 0 && TALENT:(MASTER):재생처녀 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;男 →双女 
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,15) && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 1 && TALENT:(LOCAL:1):오토코노코 == 0 && TALENT:(MASTER):남자 == 0 && TALENT:(MASTER):후타나리 == 1 &&TALENT:(MASTER):처녀 == 0 && TALENT:(MASTER):재생처녀 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;男娘→双女
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,16) && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 1 && TALENT:(LOCAL:1):오토코노코 == 1 && TALENT:(MASTER):남자 == 0 && TALENT:(MASTER):후타나리 == 1 &&TALENT:(MASTER):처녀 == 0 && TALENT:(MASTER):재생처녀 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				ELSE
					CLEARBIT FLAG:밀려넘어짐이벤트, 40
				ENDIF
				IF GETBIT(FLAG:밀려넘어짐이벤트, 40)
					SETCOLOR COLOR("pink")
					PRINTFORMW 욕정을 참을 수 없어진 %조사처리(CALLNAME:(LOCAL:1),"는")% %조사처리(CALLNAME:MASTER,"를")% 밀어 넘어뜨리고 덮쳤다！
					RESETCOLOR
					PRINTL 
					PRINTFORMW 당황한 %CALLNAME:MASTER%의 제지는 욕정으로 가득찬 %CALLNAME:(LOCAL:1)%에게는 유혹하는 소리로만 들렸고,
					PRINTFORMW 억지로 주어지는 쾌감에 %CALLNAME:MASTER%의 몸이 튀어 오를 때마다 조금씩 달콤한 울림이 울려퍼졌다…
					CALL 성욕처리, LOCAL:1 , MASTER ,  1
				ENDIF
			ENDIF

		ENDIF

		IF CFLAG:(LOCAL:1):상태이상 > 0
			;기력0と発情しているときは、ステート経過ターンが増えない
			SIF !(FLAG:무후후전개 && (BASE:(ARG:1):기력 == 0 || 위험일(LOCAL:1) >= 2))
				CFLAG:(LOCAL:1):상태이상경과턴수 += FLAG:미조우걸음수/2
			;バッド스테이터스・セービング
			CALL BADSTATUS_SAVING,LOCAL:1
			;毒なら데미지
			SIF CFLAG:(LOCAL:1):상태이상 == GET_STATE_NUM("POISON") && FLAG:미조우걸음수 % 4 == 0
				CALL VAR_HP,LOCAL:1,-MAX(MAXBASE:(LOCAL:1):ＭＰ/16,1),3
			;麻痺ならMP減少
			SIF CFLAG:(LOCAL:1):상태이상 == GET_STATE_NUM("PALYZE") && FLAG:미조우걸음수 % 4 == 0
				CALL VAR_MP,LOCAL:1,-MAX(MAXBASE:(LOCAL:1):ＭＰ/16,1),3
			CFLAG:(LOCAL:1):상태이상경과턴수 -= FLAG:미조우걸음수/2
		ENDIF
	ENDIF
NEXT

LOCAL = 0
;移動後の던전이벤트呼び出し
SELECTCASE DA:(FLAG:현X):(FLAG:현Y)
	CASE -9
		CALL DUNGEON_TERMINAL
	CASE -19
		CALL FOUNTAIN_OF_TRISH
	CASE -29
		CALL DUNGEON_ELEVATOR
	CASEELSE
		CALLFORM EVENT_ENTER_DUNGEON_{FLAG:현던전},ARG
ENDSELECT
SIF RESULT || FLAG:인카운트하지않는다 || FLAG:탈출
	LOCAL = 1

;遭遇체크
IF LOCAL == 0
	;-- 던전32:不思議な던전 --------
	;遭遇チェックのタイミングで敵シンボルの移動などの処理を行う
	IF FLAG:지형자동생성・FOE플래그 == 1
		CALL SEF_SYMBOL_CHARA_ACTION
	ENDIF
	;-- 던전32:不思議な던전 --------
	LOCAL:3 = FLAG:인카운트율보정 + 100
	SIF EQUIP:MASTER:에너미호이호이 && NUM_SUMMONER()
		LOCAL:3 *= 2
	SIF EQUIP:MASTER:에너미바이바이 && NUM_SUMMONER()
		LOCAL:3 /= 2
;---- EDIT 042 ADD START -------------------------
	SIF EQUIP:MASTER:저주의레드카펫
		LOCAL:3 = -100
;---- EDIT 042 ADD END -------------------------
	$ENCOUNT_START
	SIF RAND:100 <= LOCAL:3
		CALLFORM CHECK_ENCOUNT_{FLAG:현던전}
	IF RESULT == 1
		LOCAL:1 = 1
;---- EDIT 004 MOD START -------------------------
;		IF FLAG:에스트마
		IF FLAG:에스트마 || ( EQUIP:MASTER:캡스・락 && NUM_SUMMONER() )
			LOCAL:30 = 0
;---- EDIT 004 MOD END ---------------------------
			LOCAL:1 = 0
			LOCAL:2 = 0
			;아군합계LV及び아군합계人数をカウント
			FOR LOCAL, 1, 7
;---- EDIT 004 MOD START -------------------------
;				SIF POS(LOCAL) >= 0
				IF POS(LOCAL) >= 0
					LOCAL:2 += BASE:POS(LOCAL):LV
					LOCAL:30 += 1
				ENDIF
;---- EDIT 004 MOD END ---------------------------
			NEXT
			FOR LOCAL, 7, 17
				SIF POS(LOCAL) <= 0
					CONTINUE
				LOCALS = 포지션{LOCAL}
;---- EDIT 004 ADD START -------------------------
				;CHK:에스트마 (式: 적LV < 아군합계LV / 6);LOCAL:30にパーティ人数が入っているはずなのでそれを参照する様に변경
				IF FLAG:에스트마 && ( BASE:POS(LOCAL):LV < (LOCAL:2 / LOCAL:30) )
					CALL 캐릭터삭제(POS(LOCAL))
					CONTINUE
				ENDIF
				;CHK:캡스・락 (式: 적LV < 主人LV - 12)
				IF ( EQUIP:MASTER:캡스・락 && NUM_SUMMONER() ) && ( BASE:POS(LOCAL):LV <= BASE:MASTER:LV - 12 )
					CALL 캐릭터삭제(POS(LOCAL))
					CONTINUE
				ENDIF
				;그외
				LOCAL:1 = 1
;---- EDIT 004 ADD END ---------------------------
			NEXT
		ENDIF
		FLAG:미조우걸음수 = 0
		IF LOCAL:1 > 0
			PRINTW 악마와 조우했다！
			CALL BATTLE_START
		ENDIF
	ENDIF
	LOCAL:3 -= 100
	SIF LOCAL:3 > 0
		GOTO ENCOUNT_START
ENDIF
CALL MOVE_MOON
CALL AUTOMAP

RETURN 1

;=====================================================================
;런런던전
;=====================================================================

@DUNGEON_RUNRUN
INVERTBIT FLAG:232,0
RETURN 1

;=====================================================================
;런런던전 체크用変数
;=====================================================================

@DUNGEON_RUNRUN_CHECK,ARG
#LOCALSIZE 3
LOCAL:1 = 2
LOCAL:2 = 2

;向きによる移動方向の판정
SELECTCASE ARG
	CASE 8
		;8はy-1
		LOCAL:2 = 1
	CASE 4
		;4はx-1
		LOCAL:1 = 1
	CASE 6
		;6はx+1
		LOCAL:1 = 3
	CASE 2
		;2はy+1
		LOCAL:2 = 3
ENDSELECT


;通路の체크
;
;進行方向がy+1とすると、x-1とx+1のどちらかが
;yとy+2が侵入不可かつy+1が「侵入不可でないでない」←変な表現だけどこれが正直正しい　なら横に通路があると見なしてとまる
;
;x  -=+
;y  222
;y  111
;y  000
;
;こういうことですね我ながら分かりやすいです

;y軸移動 2,8の時の通路체크
IF ARG == 2 || ARG == 8
	;x-1側の체크 !DA DA !DAでAND
	SIF DA:(FLAG:현X-1):(FLAG:현Y) % 10 == 0 && DA:(FLAG:현X-1):(FLAG:현Y+LOCAL:2-2) % 10 != 0 && DA:(FLAG:현X-1):(FLAG:현Y+LOCAL:2+LOCAL:2-4) % 10 == 0
		RETURN 0
	;x+1側の체크
	SIF DA:(FLAG:현X+1):(FLAG:현Y) % 10 == 0 && DA:(FLAG:현X+1):(FLAG:현Y+LOCAL:2-2) % 10 != 0 && DA:(FLAG:현X+1):(FLAG:현Y+LOCAL:2+LOCAL:2-4) % 10 == 0
		RETURN 0		
ENDIF

;x軸移動 4,6の時の通路체크
IF ARG == 4 || ARG == 6
	;y-1側の체크 !DA DA !DAでAND
	SIF DA:(FLAG:현X):(FLAG:현Y-1) % 10 == 0 && DA:(FLAG:현X+LOCAL:1-2):(FLAG:현Y-1) % 10 != 0 && DA:(FLAG:현X+LOCAL:1+LOCAL:1-4):(FLAG:현Y-1) % 10 == 0
		RETURN 0
	;y+1側の체크
	SIF DA:(FLAG:현X):(FLAG:현Y+1) % 10 == 0 && DA:(FLAG:현X+LOCAL:1-2):(FLAG:현Y+1) % 10 != 0 && DA:(FLAG:현X+LOCAL:1+LOCAL:1-4):(FLAG:현Y+1) % 10 == 0
		RETURN 0		
ENDIF

;移動先のマスが両方とも1であれば1を返す
SIF DA:(FLAG:현X+LOCAL:1-2):(FLAG:현Y+LOCAL:2-2) % 10 == 1 && DA:(FLAG:현X+LOCAL:1+LOCAL:1-4):(FLAG:현Y+LOCAL:2+LOCAL:2-4) % 10 == 1 
	RETURN 1
RETURN 0

;=====================================================================
;走って移動
;=====================================================================

@RUN_DUNGEON,ARG
;歩いて移動を２回……しているだけではないのです

;もしラン中断フラグが既に立っている場合、一歩눈に入る前に消す
SIF GETBIT(FLAG:233,0) == 1
	CLEARBIT FLAG:233,0

;１回目の移動
LOCAL = 0
LOCAL:99 = 0
SELECTCASE ARG
	CASE 8
		FLAG:현Y -= 1
	CASE 4
		FLAG:현X -= 1
	CASE 6
		FLAG:현X += 1
	CASE 2
		FLAG:현Y += 1
ENDSELECT

;ＭＡＧ소비
CALL CONSUME_MAG

;ガリバーマジック
IF EQUIP:MASTER:걸리버・매직 == 1 && !FLAG:COMP사용불능
	FOR LOCAL,1,7
		LOCALS = 포지션{LOCAL}
		IF FLAG:LOCALS > -1 && TALENT:(FLAG:LOCALS):서머너 && (TALENT:(FLAG:LOCALS):이능자 == 0 && TALENT:(FLAG:LOCALS):페르소나구사자 == 0 && CFLAG:(FLAG:LOCALS):악마변신 == 0 && TALENT:(FLAG:LOCALS):달인 == 0)
			SELECTCASE GET_STATE(CFLAG:(FLAG:LOCALS):상태이상)
				CASE "DYING","STONE","FLY","PALYZE","BIND","CHARM","SLEEP","PANIC"
					CONTINUE
				CASEELSE
					CALL VAR_HP,FLAG:LOCALS,1,3
			ENDSELECT
		ENDIF
	NEXT
ENDIF

;なんでここでAUTOMAP読んでるんだろ？
CALL AUTOMAP
;毒などの체크
FOR LOCAL,1,7
	LOCALS = 포지션{LOCAL}
	IF FLAG:LOCALS > -1
		LOCAL:1 = FLAG:LOCALS
		IF FLAG:무후후전개
	
			;一歩ごとに체력が5회복する（최대値は기력の現在値）
			SIF BASE:(LOCAL:1):체력 < BASE:(LOCAL:1):기력
				BASE:(LOCAL:1):체력 += 5
			
			;CFLAG:던전내발정용욕정치が15000以下の場合
			IF CFLAG:(LOCAL:1):던전내발정용욕정치 < 15000
				;정액の箇所ひとつに付き욕정が정액중독ＬＶ分増える
				CFLAG:(LOCAL:1):던전내발정용욕정치 += GET_STAIN("질내" , "정액" , LOCAL:1) * ABL:(LOCAL:1):정액중독
				CFLAG:(LOCAL:1):던전내발정용욕정치 += GET_STAIN("바기나" , "정액" , LOCAL:1) * ABL:(LOCAL:1):정액중독
				CFLAG:(LOCAL:1):던전내발정용욕정치 += GET_STAIN("입" , "정액" , LOCAL:1) * ABL:(LOCAL:1):정액중독
				CFLAG:(LOCAL:1):던전내발정용욕정치 += GET_STAIN("손" , "정액" , LOCAL:1) * ABL:(LOCAL:1):정액중독
				CFLAG:(LOCAL:1):던전내발정용욕정치 += GET_STAIN("가슴" , "정액" , LOCAL:1) * ABL:(LOCAL:1):정액중독
				CFLAG:(LOCAL:1):던전내발정용욕정치 += GET_STAIN("애널" , "정액" , LOCAL:1) * ABL:(LOCAL:1):정액중독
				CFLAG:(LOCAL:1):던전내발정용욕정치 += GET_STAIN("머리카락" , "정액" , LOCAL:1) * ABL:(LOCAL:1):정액중독

				;アソコと유두が노출していると노출증ＬＶ分욕정が増える
				SIF TEQUIP:(LOCAL:1):유두노출 == -1
					CFLAG:(LOCAL:1):던전내발정용욕정치 += ABL:(LOCAL:1):노출증
				SIF TEQUIP:(LOCAL:1):음순노출 == -1
					CFLAG:(LOCAL:1):던전내발정용욕정치 += ABL:(LOCAL:1):노출증

				SIF 위험일(LOCAL:1) == 2
					CFLAG:(LOCAL:1):던전내발정용욕정치 += 2 * ABL:(LOCAL:1):욕망
				;CFLAG:던전내발정용욕정치の上限は15000
				SIF CFLAG:(LOCAL:1):던전내발정용욕정치 > 15000
					CFLAG:(LOCAL:1):던전내발정용욕정치 = 15000
			ENDIF
			
			;질내が정액で불결ている場合は10％の확률で바기나に불결が付く
			IF GET_STAIN("질내" , "정액" , LOCAL:1) && GET_STAIN("바기나" , "정액" , LOCAL:1) == 0 && RAND:100 < 10
				SETCOLOR COLOR("pink")
				PRINTFORMW %CALLNAME:(LOCAL:1)% 보지에 쏟아진 정액이 흘러나왔다…
				RESETCOLOR
				CALL SET_STAIN("바기나" , "정액" , LOCAL:1)
				;三分の一の確立で질내の불결소거
				SIF RAND:3 == 0
					STAIN:(LOCAL:1):질내 = 0
			ENDIF
		
			;욕정一定値以下で発情終了
			IF  CFLAG:(LOCAL:1):던전내발정용욕정치 < 2000 && CFLAG:(LOCAL:1):던전내발정
				CFLAG:(LOCAL:1):던전내발정 = 0
				PRINTFORMW %조사처리(CALLNAME:(LOCAL:1),"는")% 침착해졌다
			ENDIF
	
			;욕정が10000以上になると発情
			IF (!TALENT:(LOCAL:1):남자 || TALENT:(LOCAL:1):오토코노코) && !CFLAG:(LOCAL:1):던전내발정 && CFLAG:(LOCAL:1):던전내발정용욕정치 >= 10000
				CFLAG:(LOCAL:1):던전내발정 = 1
				CALL SET_STAIN("질내" , "애액" , LOCAL:1)
				CALL SET_STAIN("바기나" , "애액" , LOCAL:1)
				SETCOLOR COLOR("pink")
				PRINTFORMW %조사처리(CALLNAME:(LOCAL:1),"는")% 머릿속이 핑크색으로 물들었다
				RESETCOLOR
			;発情상태の時に30％の확률でHAPPYになる
			ELSEIF RAND:100 < 30 && CFLAG:(LOCAL:1):던전내발정 && CFLAG:(LOCAL:1):상태이상 != GET_STATE_NUM("HAPPY")
				CFLAG:(LOCAL:1):상태이상 = GET_STATE_NUM("HAPPY")
			ENDIF
			;素質『발정가능』を持っていると魅了상태時に10％の확률で発情する
			IF TALENT:(LOCAL:1):남자 == 0 && CFLAG:(LOCAL:1):상태이상 == GET_STATE_NUM("CHARM") && TALENT:(LOCAL:1):발정가능 && CFLAG:(LOCAL:1):던전내발정 == 0 && RAND:100 < 10
				CFLAG:(LOCAL:1):던전내발정 = 1
				CALL SET_STAIN("질내" , "애액" , LOCAL:1)
				CALL SET_STAIN("바기나" , "애액" , LOCAL:1)
				SETCOLOR COLOR("pink")
				PRINTFORMW %조사처리(CALLNAME:(LOCAL:1),"는")% 머릿속이 핑크색으로 물들었다
				RESETCOLOR
			ENDIF

			;당신밀려넘어짐이벤트　仲魔が発情상태の時に指定확률で당신を押し倒す
			;설정と조건に該当したら FLAG:밀려넘어짐이벤트, 40 を立てて本処理を実行
			;↓はテスト用、これにすると押し倒し祭り
			;IF GETBIT(FLAG:밀려넘어짐이벤트,0) && RAND:100 < FLAG:밀려넘어짐이벤트발생률 && CFLAG:(LOCAL:1):던전내발정 == 0
			IF GETBIT(FLAG:밀려넘어짐이벤트,0) && RAND:100 < FLAG:밀려넘어짐이벤트발생률 && CFLAG:(LOCAL:1):던전내발정
				CLEARBIT FLAG:밀려넘어짐이벤트, 40
				;女 → 男
				IF     GETBIT(FLAG:밀려넘어짐이벤트,1)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 0 && TALENT:(LOCAL:1):후타나리 == 0 &&TALENT:(LOCAL:1):처녀 == 0 && TALENT:(LOCAL:1):재생처녀 == 0 && TALENT:(MASTER):남자 == 1 && TALENT:(MASTER):오토코노코 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;双女→ 男
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,2)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 0 && TALENT:(LOCAL:1):후타나리 == 1 && TALENT:(LOCAL:1):처녀 == 0 && TALENT:(LOCAL:1):재생처녀 == 0 && TALENT:(MASTER):남자 == 1 && TALENT:(MASTER):오토코노코 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;男 → 男
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,3)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 1 && TALENT:(LOCAL:1):오토코노코 == 0 && TALENT:(MASTER):남자 == 1 && TALENT:(MASTER):오토코노코 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;男娘→ 男 
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,4)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 1 && TALENT:(LOCAL:1):오토코노코 == 1 && TALENT:(MASTER):남자 == 1 && TALENT:(MASTER):오토코노코 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;女 → 女
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,5)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 0 && TALENT:(LOCAL:1):후타나리 == 0 && TALENT:(LOCAL:1):처녀 == 0 && TALENT:(LOCAL:1):재생처녀 == 0 && TALENT:(MASTER):남자 == 0 && TALENT:(MASTER):후타나리 == 0 &&TALENT:(MASTER):처녀 == 0 && TALENT:(MASTER):재생처녀 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;双女→ 女
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,6)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 0 && TALENT:(LOCAL:1):후타나리 == 1 && TALENT:(LOCAL:1):처녀 == 0 && TALENT:(LOCAL:1):재생처녀 == 0 && TALENT:(MASTER):남자 == 0 && TALENT:(MASTER):후타나리 == 0 &&TALENT:(MASTER):처녀 == 0 && TALENT:(MASTER):재생처녀 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;男 → 女
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,7)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 1 && TALENT:(LOCAL:1):오토코노코 == 0 && TALENT:(MASTER):남자 == 0 && TALENT:(MASTER):후타나리 == 0 &&TALENT:(MASTER):처녀 == 0 && TALENT:(MASTER):재생처녀 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;男娘→ 女
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,8)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 1 && TALENT:(LOCAL:1):오토코노코 == 1 && TALENT:(MASTER):남자 == 0 && TALENT:(MASTER):후타나리 == 0 &&TALENT:(MASTER):처녀 == 0 && TALENT:(MASTER):재생처녀 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;女 →男娘
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,9)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 0 && TALENT:(LOCAL:1):후타나리 == 0 && TALENT:(LOCAL:1):처녀 == 0 && TALENT:(LOCAL:1):재생처녀 == 0 && TALENT:(MASTER):남자 == 1 && TALENT:(MASTER):오토코노코 == 1
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;双女→男娘
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,10) && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 0 && TALENT:(LOCAL:1):후타나리 == 1 && TALENT:(LOCAL:1):처녀 == 0 && TALENT:(LOCAL:1):재생처녀 == 0 && TALENT:(MASTER):남자 == 1 && TALENT:(MASTER):오토코노코 == 1
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;男 →男娘 
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,11) && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 1 && TALENT:(LOCAL:1):오토코노코 == 0 && TALENT:(MASTER):남자 == 1 && TALENT:(MASTER):오토코노코 == 1
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;男娘→男娘
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,12) && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 1 && TALENT:(LOCAL:1):오토코노코 == 1 && TALENT:(MASTER):남자 == 1 && TALENT:(MASTER):오토코노코 == 1
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;女 →双女 
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,13) && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 0 && TALENT:(LOCAL:1):후타나리 == 0 && TALENT:(LOCAL:1):처녀 == 0 && TALENT:(LOCAL:1):재생처녀 == 0 && TALENT:(MASTER):남자 == 0 && TALENT:(MASTER):후타나리 == 1 &&TALENT:(MASTER):처녀 == 0 && TALENT:(MASTER):재생처녀 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;双女→双女
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,14) && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 0 && TALENT:(LOCAL:1):후타나리 == 1 && TALENT:(LOCAL:1):처녀 == 0 && TALENT:(LOCAL:1):재생처녀 == 0 && TALENT:(MASTER):남자 == 0 && TALENT:(MASTER):후타나리 == 1 &&TALENT:(MASTER):처녀 == 0 && TALENT:(MASTER):재생처녀 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;男 →双女 
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,15) && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 1 && TALENT:(LOCAL:1):오토코노코 == 0 && TALENT:(MASTER):남자 == 0 && TALENT:(MASTER):후타나리 == 1 &&TALENT:(MASTER):처녀 == 0 && TALENT:(MASTER):재생처녀 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;男娘→双女
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,16) && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 1 && TALENT:(LOCAL:1):오토코노코 == 1 && TALENT:(MASTER):남자 == 0 && TALENT:(MASTER):후타나리 == 1 &&TALENT:(MASTER):처녀 == 0 && TALENT:(MASTER):재생처녀 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				ELSE
					CLEARBIT FLAG:밀려넘어짐이벤트, 40
				ENDIF
				IF GETBIT(FLAG:밀려넘어짐이벤트, 40)
					SETCOLOR COLOR("pink")
					PRINTFORMW 욕정을 참을 수 없어진 %조사처리(CALLNAME:(LOCAL:1),"는")% %조사처리(CALLNAME:MASTER,"를")% 밀어 넘어뜨리고 덮쳤다！
					RESETCOLOR
					PRINTL 
					PRINTFORMW 당황한 %CALLNAME:MASTER%의 제지는 욕정으로 가득찬 %CALLNAME:(LOCAL:1)%에게는 유혹하는 소리로만 들렸고,
					PRINTFORMW 억지로 주어지는 쾌감에 %CALLNAME:MASTER%의 몸이 튀어 오를 때마다 조금씩 달콤한 울림이 울려퍼졌다…
					CALL 성욕처리, LOCAL:1 , MASTER ,  1
				ENDIF
			ENDIF

		ENDIF

		IF CFLAG:(LOCAL:1):상태이상 > 0
			;기력0と発情しているときは、ステート経過ターンが増えない
			SIF !(FLAG:무후후전개 && (BASE:(ARG:1):기력 == 0 || 위험일(LOCAL:1) >= 2))
				CFLAG:(LOCAL:1):상태이상경과턴수 += FLAG:미조우걸음수/2
			;バッド스테이터스・セービング
			CALL BADSTATUS_SAVING,LOCAL:1
			;毒なら데미지
			SIF CFLAG:(LOCAL:1):상태이상 == GET_STATE_NUM("POISON") && FLAG:미조우걸음수 % 4 == 0
				CALL VAR_HP,LOCAL:1,-MAX(MAXBASE:(LOCAL:1):ＭＰ/16,1),3
			;麻痺ならMP減少
			SIF CFLAG:(LOCAL:1):상태이상 == GET_STATE_NUM("PALYZE") && FLAG:미조우걸음수 % 4 == 0
				CALL VAR_MP,LOCAL:1,-MAX(MAXBASE:(LOCAL:1):ＭＰ/16,1),3
			CFLAG:(LOCAL:1):상태이상경과턴수 -= FLAG:미조우걸음수/2
		ENDIF
	ENDIF
NEXT


;移動後の던전이벤트呼び出し
LOCAL = 0
SELECTCASE DA:(FLAG:현X):(FLAG:현Y)
	CASE -9
		CALL DUNGEON_TERMINAL
	CASE -19
		CALL FOUNTAIN_OF_TRISH
	CASE -29
		CALL DUNGEON_ELEVATOR
	CASEELSE
		CALLFORM EVENT_ENTER_DUNGEON_{FLAG:현던전},ARG
ENDSELECT

;遭遇체크を行うかどうか
LOCAL = 0
SIF RESULT || FLAG:인카운트하지않는다 || FLAG:탈출
	LOCAL = 1

;遭遇체크
;遭遇したら２マス눈の移動はキャンセル
IF LOCAL == 0
	;-- 던전32:不思議な던전 --------
	;遭遇チェックのタイミングで敵シンボルの移動などの処理を行う
	IF FLAG:지형자동생성・FOE플래그 == 1
		CALL SEF_SYMBOL_CHARA_ACTION
	ENDIF
	;-- 던전32:不思議な던전 --------
	LOCAL:3 = FLAG:인카운트율보정 + 100
	SIF EQUIP:MASTER:에너미호이호이 && NUM_SUMMONER()
		LOCAL:3 *= 2
	SIF EQUIP:MASTER:에너미바이바이 && NUM_SUMMONER()
		LOCAL:3 /= 2
;---- EDIT 042 ADD START -------------------------
	SIF EQUIP:MASTER:저주의레드카펫
		LOCAL:3 = -100
;---- EDIT 042 ADD END -------------------------
	$ENCOUNT_START1
	SIF RAND:100 <= LOCAL:3
		CALLFORM CHECK_ENCOUNT_{FLAG:현던전}
	IF RESULT == 1
		LOCAL:1 = 1
;---- EDIT 004 MOD START -------------------------
;		IF FLAG:에스트마
		IF FLAG:에스트마 || ( EQUIP:MASTER:캡스・락 && NUM_SUMMONER() )
			LOCAL:30 = 0
;---- EDIT 004 MOD END ---------------------------
			LOCAL:1 = 0
			LOCAL:2 = 0
			;아군합계LV及び아군합계人数をカウント
			FOR LOCAL, 1, 7
;---- EDIT 004 MOD START -------------------------
;				SIF POS(LOCAL) >= 0
				IF POS(LOCAL) >= 0
					LOCAL:2 += BASE:POS(LOCAL):LV
					LOCAL:30 += 1
				ENDIF
;---- EDIT 004 MOD END ---------------------------
			NEXT
			FOR LOCAL, 7, 17
				SIF POS(LOCAL) <= 0
					CONTINUE
				LOCALS = 포지션{LOCAL}
;---- EDIT 004 ADD START -------------------------
				;CHK:에스트마 (式: 적LV < 아군합계LV / 6);LOCAL:30にパーティ人数が入っているはずなのでそれを参照する様に변경
				IF FLAG:에스트마 && ( BASE:POS(LOCAL):LV < (LOCAL:2 / LOCAL:30) )
					CALL 캐릭터삭제(POS(LOCAL))
					CONTINUE
				ENDIF
				;CHK:캡스・락 (式: 적LV < 主人LV - 12)
				IF ( EQUIP:MASTER:캡스・락 && NUM_SUMMONER() ) && ( BASE:POS(LOCAL):LV <= BASE:MASTER:LV - 12 )
					CALL 캐릭터삭제(POS(LOCAL))
					CONTINUE
				ENDIF
				;그외
				LOCAL:1 = 1
;---- EDIT 004 ADD END ---------------------------
			NEXT
		ENDIF
		FLAG:미조우걸음수 = 0
		IF LOCAL:1 > 0
			LOCAL:99 = 1
			PRINTW 악마와 조우했다！
			CALL BATTLE_START
		ENDIF
	ENDIF
	LOCAL:3 -= 100
	SIF LOCAL:3 > 0
		GOTO ENCOUNT_START1
ENDIF

;월령の変化とオートマップ
CALL MOVE_MOON
CALL AUTOMAP

;２回目の移動
;１回目の移動時に遭遇していたら２回目の移動はしない
SIF LOCAL:99 == 1
	RETURN 1

;FORCEMOVEを呼び出した場合はRUN중단フラグがオンになっているので、その場合は0に戻して２回目の移動はしない
IF GETBIT(FLAG:233,0) == 1
	CLEARBIT FLAG:233,0
	RETURN 1
ENDIF

SELECTCASE ARG
	CASE 8
		FLAG:현Y -= 1
	CASE 4
		FLAG:현X -= 1
	CASE 6
		FLAG:현X += 1
	CASE 2
		FLAG:현Y += 1
ENDSELECT

;ＭＡＧ소비
CALL CONSUME_MAG

;ガリバーマジック
IF EQUIP:MASTER:걸리버・매직 == 1 && !FLAG:COMP사용불능
	FOR LOCAL,1,7
		LOCALS = 포지션{LOCAL}
		IF FLAG:LOCALS > -1 && TALENT:(FLAG:LOCALS):서머너 && (TALENT:(FLAG:LOCALS):이능자 == 0 && TALENT:(FLAG:LOCALS):페르소나구사자 == 0 && CFLAG:(FLAG:LOCALS):악마변신 == 0 && TALENT:(FLAG:LOCALS):달인 == 0)
			SELECTCASE GET_STATE(CFLAG:(FLAG:LOCALS):상태이상)
				CASE "DYING","STONE","FLY","PALYZE","BIND","CHARM","SLEEP","PANIC"
					CONTINUE
				CASEELSE
					CALL VAR_HP,FLAG:LOCALS,1,3
			ENDSELECT
		ENDIF
	NEXT
ENDIF

;なんでここでAUTOMAP読んでるんだろ？
CALL AUTOMAP
;毒などの체크
FOR LOCAL,1,7
	LOCALS = 포지션{LOCAL}
	IF FLAG:LOCALS > -1
		LOCAL:1 = FLAG:LOCALS
		IF FLAG:무후후전개
	
			;一歩ごとに체력が5회복する（최대値は기력の現在値）
			SIF BASE:(LOCAL:1):체력 < BASE:(LOCAL:1):기력
				BASE:(LOCAL:1):체력 += 5
			
			;CFLAG:던전내발정용욕정치が15000以下の場合
			IF CFLAG:(LOCAL:1):던전내발정용욕정치 < 15000
				;정액の箇所ひとつに付き욕정が정액중독ＬＶ分増える
				CFLAG:(LOCAL:1):던전내발정용욕정치 += GET_STAIN("질내" , "정액" , LOCAL:1) * ABL:(LOCAL:1):정액중독
				CFLAG:(LOCAL:1):던전내발정용욕정치 += GET_STAIN("바기나" , "정액" , LOCAL:1) * ABL:(LOCAL:1):정액중독
				CFLAG:(LOCAL:1):던전내발정용욕정치 += GET_STAIN("입" , "정액" , LOCAL:1) * ABL:(LOCAL:1):정액중독
				CFLAG:(LOCAL:1):던전내발정용욕정치 += GET_STAIN("손" , "정액" , LOCAL:1) * ABL:(LOCAL:1):정액중독
				CFLAG:(LOCAL:1):던전내발정용욕정치 += GET_STAIN("가슴" , "정액" , LOCAL:1) * ABL:(LOCAL:1):정액중독
				CFLAG:(LOCAL:1):던전내발정용욕정치 += GET_STAIN("애널" , "정액" , LOCAL:1) * ABL:(LOCAL:1):정액중독
				CFLAG:(LOCAL:1):던전내발정용욕정치 += GET_STAIN("머리카락" , "정액" , LOCAL:1) * ABL:(LOCAL:1):정액중독

				;アソコと유두が노출していると노출증ＬＶ分욕정が増える
				SIF TEQUIP:(LOCAL:1):유두노출 == -1
					CFLAG:(LOCAL:1):던전내발정용욕정치 += ABL:(LOCAL:1):노출증
				SIF TEQUIP:(LOCAL:1):음순노출 == -1
					CFLAG:(LOCAL:1):던전내발정용욕정치 += ABL:(LOCAL:1):노출증

				SIF 위험일(LOCAL:1) == 2
					CFLAG:(LOCAL:1):던전내발정용욕정치 += 2 * ABL:(LOCAL:1):욕망
				;CFLAG:던전내발정용욕정치の上限は15000
				SIF CFLAG:(LOCAL:1):던전내발정용욕정치 > 15000
					CFLAG:(LOCAL:1):던전내발정용욕정치 = 15000
			ENDIF
			
			;질내が정액で불결ている場合は10％の확률で바기나に불결が付く
			IF GET_STAIN("질내" , "정액" , LOCAL:1) && GET_STAIN("바기나" , "정액" , LOCAL:1) == 0 && RAND:100 < 10
				SETCOLOR COLOR("pink")
				PRINTFORMW %CALLNAME:(LOCAL:1)% 보지에 쏟아진 정액이 흘러나왔다…
				RESETCOLOR
				CALL SET_STAIN("바기나" , "정액" , LOCAL:1)
				;三分の一の確立で질내の불결소거
				SIF RAND:3 == 0
					STAIN:(LOCAL:1):질내 = 0
			ENDIF
		
			;욕정一定値以下で発情終了
			IF  CFLAG:(LOCAL:1):던전내발정용욕정치 < 2000 && CFLAG:(LOCAL:1):던전내발정
				CFLAG:(LOCAL:1):던전내발정 = 0
				PRINTFORMW %조사처리(CALLNAME:(LOCAL:1),"는")% 침착해졌다
			ENDIF
	
			;욕정が10000以上になると発情
			IF (!TALENT:(LOCAL:1):남자 || TALENT:(LOCAL:1):오토코노코) && !CFLAG:(LOCAL:1):던전내발정 && CFLAG:(LOCAL:1):던전내발정용욕정치 >= 10000
				CFLAG:(LOCAL:1):던전내발정 = 1
				CALL SET_STAIN("질내" , "애액" , LOCAL:1)
				CALL SET_STAIN("바기나" , "애액" , LOCAL:1)
				SETCOLOR COLOR("pink")
				PRINTFORMW %조사처리(CALLNAME:(LOCAL:1),"는")% 머릿속이 핑크색으로 물들었다
				RESETCOLOR
			;発情상태の時に30％の확률でHAPPYになる
			ELSEIF RAND:100 < 30 && CFLAG:(LOCAL:1):던전내발정 && CFLAG:(LOCAL:1):상태이상 != GET_STATE_NUM("HAPPY")
				CFLAG:(LOCAL:1):상태이상 = GET_STATE_NUM("HAPPY")
			ENDIF
			;素質『발정가능』を持っていると魅了상태時に10％の확률で発情する
			IF TALENT:(LOCAL:1):남자 == 0 && CFLAG:(LOCAL:1):상태이상 == GET_STATE_NUM("CHARM") && TALENT:(LOCAL:1):발정가능 && CFLAG:(LOCAL:1):던전내발정 == 0 && RAND:100 < 10
				CFLAG:(LOCAL:1):던전내발정 = 1
				CALL SET_STAIN("질내" , "애액" , LOCAL:1)
				CALL SET_STAIN("바기나" , "애액" , LOCAL:1)
				SETCOLOR COLOR("pink")
				PRINTFORMW %조사처리(CALLNAME:(LOCAL:1),"는")% 머릿속이 핑크색으로 물들었다
				RESETCOLOR
			ENDIF

			;당신밀려넘어짐이벤트　仲魔が発情상태の時に指定확률で당신を押し倒す
			;설정と조건に該当したら FLAG:밀려넘어짐이벤트, 40 を立てて本処理を実行
			;↓はテスト用、これにすると押し倒し祭り
			;IF GETBIT(FLAG:밀려넘어짐이벤트,0) && RAND:100 < FLAG:밀려넘어짐이벤트발생률 && CFLAG:(LOCAL:1):던전내발정 == 0
			IF GETBIT(FLAG:밀려넘어짐이벤트,0) && RAND:100 < FLAG:밀려넘어짐이벤트발생률 && CFLAG:(LOCAL:1):던전내발정
				CLEARBIT FLAG:밀려넘어짐이벤트, 40
				;女 → 男
				IF     GETBIT(FLAG:밀려넘어짐이벤트,1)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 0 && TALENT:(LOCAL:1):후타나리 == 0 &&TALENT:(LOCAL:1):처녀 == 0 && TALENT:(LOCAL:1):재생처녀 == 0 && TALENT:(MASTER):남자 == 1 && TALENT:(MASTER):오토코노코 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;双女→ 男
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,2)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 0 && TALENT:(LOCAL:1):후타나리 == 1 && TALENT:(LOCAL:1):처녀 == 0 && TALENT:(LOCAL:1):재생처녀 == 0 && TALENT:(MASTER):남자 == 1 && TALENT:(MASTER):오토코노코 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;男 → 男
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,3)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 1 && TALENT:(LOCAL:1):오토코노코 == 0 && TALENT:(MASTER):남자 == 1 && TALENT:(MASTER):오토코노코 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;男娘→ 男 
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,4)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 1 && TALENT:(LOCAL:1):오토코노코 == 1 && TALENT:(MASTER):남자 == 1 && TALENT:(MASTER):오토코노코 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;女 → 女
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,5)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 0 && TALENT:(LOCAL:1):후타나리 == 0 && TALENT:(LOCAL:1):처녀 == 0 && TALENT:(LOCAL:1):재생처녀 == 0 && TALENT:(MASTER):남자 == 0 && TALENT:(MASTER):후타나리 == 0 &&TALENT:(MASTER):처녀 == 0 && TALENT:(MASTER):재생처녀 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;双女→ 女
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,6)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 0 && TALENT:(LOCAL:1):후타나리 == 1 && TALENT:(LOCAL:1):처녀 == 0 && TALENT:(LOCAL:1):재생처녀 == 0 && TALENT:(MASTER):남자 == 0 && TALENT:(MASTER):후타나리 == 0 &&TALENT:(MASTER):처녀 == 0 && TALENT:(MASTER):재생처녀 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;男 → 女
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,7)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 1 && TALENT:(LOCAL:1):오토코노코 == 0 && TALENT:(MASTER):남자 == 0 && TALENT:(MASTER):후타나리 == 0 &&TALENT:(MASTER):처녀 == 0 && TALENT:(MASTER):재생처녀 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;男娘→ 女
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,8)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 1 && TALENT:(LOCAL:1):오토코노코 == 1 && TALENT:(MASTER):남자 == 0 && TALENT:(MASTER):후타나리 == 0 &&TALENT:(MASTER):처녀 == 0 && TALENT:(MASTER):재생처녀 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;女 →男娘
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,9)  && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 0 && TALENT:(LOCAL:1):후타나리 == 0 && TALENT:(LOCAL:1):처녀 == 0 && TALENT:(LOCAL:1):재생처녀 == 0 && TALENT:(MASTER):남자 == 1 && TALENT:(MASTER):오토코노코 == 1
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;双女→男娘
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,10) && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 0 && TALENT:(LOCAL:1):후타나리 == 1 && TALENT:(LOCAL:1):처녀 == 0 && TALENT:(LOCAL:1):재생처녀 == 0 && TALENT:(MASTER):남자 == 1 && TALENT:(MASTER):오토코노코 == 1
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;男 →男娘 
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,11) && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 1 && TALENT:(LOCAL:1):오토코노코 == 0 && TALENT:(MASTER):남자 == 1 && TALENT:(MASTER):오토코노코 == 1
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;男娘→男娘
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,12) && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 1 && TALENT:(LOCAL:1):오토코노코 == 1 && TALENT:(MASTER):남자 == 1 && TALENT:(MASTER):오토코노코 == 1
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;女 →双女 
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,13) && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 0 && TALENT:(LOCAL:1):후타나리 == 0 && TALENT:(LOCAL:1):처녀 == 0 && TALENT:(LOCAL:1):재생처녀 == 0 && TALENT:(MASTER):남자 == 0 && TALENT:(MASTER):후타나리 == 1 &&TALENT:(MASTER):처녀 == 0 && TALENT:(MASTER):재생처녀 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;双女→双女
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,14) && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 0 && TALENT:(LOCAL:1):후타나리 == 1 && TALENT:(LOCAL:1):처녀 == 0 && TALENT:(LOCAL:1):재생처녀 == 0 && TALENT:(MASTER):남자 == 0 && TALENT:(MASTER):후타나리 == 1 &&TALENT:(MASTER):처녀 == 0 && TALENT:(MASTER):재생처녀 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;男 →双女 
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,15) && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 1 && TALENT:(LOCAL:1):오토코노코 == 0 && TALENT:(MASTER):남자 == 0 && TALENT:(MASTER):후타나리 == 1 &&TALENT:(MASTER):처녀 == 0 && TALENT:(MASTER):재생처녀 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				;男娘→双女
				ELSEIF GETBIT(FLAG:밀려넘어짐이벤트,16) && LOCAL:1 != MASTER && TALENT:(LOCAL:1):남자 == 1 && TALENT:(LOCAL:1):오토코노코 == 1 && TALENT:(MASTER):남자 == 0 && TALENT:(MASTER):후타나리 == 1 &&TALENT:(MASTER):처녀 == 0 && TALENT:(MASTER):재생처녀 == 0
					SETBIT FLAG:밀려넘어짐이벤트, 40
				ELSE
					CLEARBIT FLAG:밀려넘어짐이벤트, 40
				ENDIF
				IF GETBIT(FLAG:밀려넘어짐이벤트, 40)
					SETCOLOR COLOR("pink")
					PRINTFORMW 욕정을 참을 수 없어진 %조사처리(CALLNAME:(LOCAL:1),"는")% %조사처리(CALLNAME:MASTER,"를")% 밀어 넘어뜨리고 덮쳤다！
					RESETCOLOR
					PRINTL 
					PRINTFORMW 당황한 %CALLNAME:MASTER%의 제지는 욕정으로 가득찬 %CALLNAME:(LOCAL:1)%에게는 유혹하는 소리로만 들렸고,
					PRINTFORMW 억지로 주어지는 쾌감에 %CALLNAME:MASTER%의 몸이 튀어 오를 때마다 조금씩 달콤한 울림이 울려퍼졌다…
					CALL 성욕처리, LOCAL:1 , MASTER ,  1
				ENDIF
			ENDIF

		ENDIF

		IF CFLAG:(LOCAL:1):상태이상 > 0
			;기력0と発情しているときは、ステート経過ターンが増えない
			SIF !(FLAG:무후후전개 && (BASE:(ARG:1):기력 == 0 || 위험일(LOCAL:1) >= 2))
				CFLAG:(LOCAL:1):상태이상경과턴수 += FLAG:미조우걸음수/2
			;バッド스테이터스・セービング
			CALL BADSTATUS_SAVING,LOCAL:1
			;毒なら데미지
			SIF CFLAG:(LOCAL:1):상태이상 == GET_STATE_NUM("POISON") && FLAG:미조우걸음수 % 4 == 0
				CALL VAR_HP,LOCAL:1,-MAX(MAXBASE:(LOCAL:1):ＭＰ/16,1),3
			;麻痺ならMP減少
			SIF CFLAG:(LOCAL:1):상태이상 == GET_STATE_NUM("PALYZE") && FLAG:미조우걸음수 % 4 == 0
				CALL VAR_MP,LOCAL:1,-MAX(MAXBASE:(LOCAL:1):ＭＰ/16,1),3
			CFLAG:(LOCAL:1):상태이상경과턴수 -= FLAG:미조우걸음수/2
		ENDIF
	ENDIF
NEXT

LOCAL = 0
;移動後の던전이벤트呼び出し
SELECTCASE DA:(FLAG:현X):(FLAG:현Y)
	CASE -9
		CALL DUNGEON_TERMINAL
	CASE -19
		CALL FOUNTAIN_OF_TRISH
	CASE -29
		CALL DUNGEON_ELEVATOR
	CASEELSE
		CALLFORM EVENT_ENTER_DUNGEON_{FLAG:현던전},ARG
ENDSELECT

;遭遇체크を行うかどうか
SIF RESULT || FLAG:인카운트하지않는다 || FLAG:탈출
	LOCAL = 1

;遭遇체크
IF LOCAL == 0
	;-- 던전32:不思議な던전 --------
	;遭遇チェックのタイミングで敵シンボルの移動などの処理を行う
	IF FLAG:지형자동생성・FOE플래그 == 1
		CALL SEF_SYMBOL_CHARA_ACTION
	ENDIF
	;-- 던전32:不思議な던전 --------
	LOCAL:3 = FLAG:인카운트율보정 + 100
	SIF EQUIP:MASTER:에너미호이호이 && NUM_SUMMONER()
		LOCAL:3 *= 2
	SIF EQUIP:MASTER:에너미바이바이 && NUM_SUMMONER()
		LOCAL:3 /= 2
;---- EDIT 042 ADD START -------------------------
	SIF EQUIP:MASTER:저주의레드카펫
		LOCAL:3 = -100
;---- EDIT 042 ADD END -------------------------
	$ENCOUNT_START2
	SIF RAND:100 <= LOCAL:3
		CALLFORM CHECK_ENCOUNT_{FLAG:현던전}
	IF RESULT == 1
		LOCAL:1 = 1
;---- EDIT 004 MOD START -------------------------
;		IF FLAG:에스트마
		IF FLAG:에스트마 || ( EQUIP:MASTER:캡스・락 && NUM_SUMMONER() )
			LOCAL:30 = 0
;---- EDIT 004 MOD END ---------------------------
			LOCAL:1 = 0
			LOCAL:2 = 0
			;아군합계LV及び아군합계人数をカウント
			FOR LOCAL, 1, 7
;---- EDIT 004 MOD START -------------------------
;				SIF POS(LOCAL) >= 0
				IF POS(LOCAL) >= 0
					LOCAL:2 += BASE:POS(LOCAL):LV
					LOCAL:30 += 1
				ENDIF
;---- EDIT 004 MOD END ---------------------------
			NEXT
			FOR LOCAL, 7, 17
				SIF POS(LOCAL) <= 0
					CONTINUE
				LOCALS = 포지션{LOCAL}
;---- EDIT 004 ADD START -------------------------
				;CHK:에스트마 (式: 적LV < 아군합계LV / 6);LOCAL:30にパーティ人数が入っているはずなのでそれを参照する様に변경
				IF FLAG:에스트마 && ( BASE:POS(LOCAL):LV < (LOCAL:2 / LOCAL:30) )
					CALL 캐릭터삭제(POS(LOCAL))
					CONTINUE
				ENDIF
				;CHK:캡스・락 (式: 적LV < 主人LV - 12)
				IF ( EQUIP:MASTER:캡스・락 && NUM_SUMMONER() ) && ( BASE:POS(LOCAL):LV <= BASE:MASTER:LV - 12 )
					CALL 캐릭터삭제(POS(LOCAL))
					CONTINUE
				ENDIF
				;그외
				LOCAL:1 = 1
;---- EDIT 004 ADD END ---------------------------
			NEXT
		ENDIF
		FLAG:미조우걸음수 = 0
		IF LOCAL:1 > 0
			PRINTW 악마와 조우했다！
			CALL BATTLE_START
		ENDIF
	ENDIF
	LOCAL:3 -= 100
	SIF LOCAL:3 > 0
		GOTO ENCOUNT_START2
ENDIF

;월령の変化とオートマップ
CALL MOVE_MOON
CALL AUTOMAP

RETURN 1


;=====================================================================
;オートマッピング登録処理
;=====================================================================
@AUTOMAP
IF DA:(FLAG:현X):(FLAG:현Y) == -1 && (EQUIP:MASTER:다크스캐너 == 0 || NUM_SUMMONER() == 0) && FLAG:라이트마 == 0
	;CALL SET_FLOOR_ANALYZE(MAX(GET_FLOOR_ANALYZE_T(FLAG:현X+1, FLAG:현Y) ,1), FLAG:현던전, FLAG:현M, FLAG:현X+1, FLAG:현Y)
	;CALL SET_FLOOR_ANALYZE(MAX(GET_FLOOR_ANALYZE_T(FLAG:현X-1, FLAG:현Y) ,1), FLAG:현던전, FLAG:현M, FLAG:현X-1, FLAG:현Y)
	;CALL SET_FLOOR_ANALYZE(MAX(GET_FLOOR_ANALYZE_T(FLAG:현X, FLAG:현Y+1) ,1), FLAG:현던전, FLAG:현M, FLAG:현X, FLAG:현Y+1)
	;CALL SET_FLOOR_ANALYZE(MAX(GET_FLOOR_ANALYZE_T(FLAG:현X, FLAG:현Y-1) ,1), FLAG:현던전, FLAG:현M, FLAG:현X, FLAG:현Y-1)
	;TA:((FLAG:현M*100+FLAG:현던전)):(FLAG:현X+1):(FLAG:현Y) = MAX(TA:((FLAG:현M*100+FLAG:현던전)):(FLAG:현X+1):(FLAG:현Y), 1)
	;TA:((FLAG:현M*100+FLAG:현던전)):(FLAG:현X-1):(FLAG:현Y) = MAX(TA:((FLAG:현M*100+FLAG:현던전)):(FLAG:현X-1):(FLAG:현Y), 1)
	;TA:((FLAG:현M*100+FLAG:현던전)):(FLAG:현X):(FLAG:현Y+1) = MAX(TA:((FLAG:현M*100+FLAG:현던전)):(FLAG:현X):(FLAG:현Y+1), 1)
	;TA:((FLAG:현M*100+FLAG:현던전)):(FLAG:현X):(FLAG:현Y-1) = MAX(TA:((FLAG:현M*100+FLAG:현던전)):(FLAG:현X):(FLAG:현Y-1), 1)
	GOTO DARK
ENDIF
;CALLFORM GET_DUNGEON_NAME_{FLAG:현던전}
;CALLF DPOINT( , , 0 , 0 , FLAG:현M , RESULTS)
CALLF DPOINT( , , 0 , 0 , FLAG:현M , @"던전%TOSTR(FLAG:현던전,"00")%")

FOR LOCAL,0,5
	SIF (FLAG:현X+LOCAL-2) < 0 || (FLAG:현X+LOCAL-2) >= FLAG:최대X
		CONTINUE
	FOR LOCAL:1,0,5
		SIF (FLAG:현Y+LOCAL:1-2) < 0 || (FLAG:현Y+LOCAL:1-2) >= FLAG:최대Y
			CONTINUE
		;IF TA:((FLAG:현M*100+FLAG:현던전)):(FLAG:현X+LOCAL-2):(FLAG:현Y+LOCAL:1-2) == 0
		;IF GET_FLOOR_ANALYZE_T(FLAG:현X+LOCAL-2, FLAG:현Y+LOCAL:1-2) == 0
		IF DPOINT( , , (FLAG:현X+LOCAL-2) , (FLAG:현Y+LOCAL:1-2)) == 0
			SELECTCASE LOCAL
				CASE 0
					SELECTCASE LOCAL:1
						CASE 0
							CALL CAN_SEE_THROUGH,(FLAG:현X-1),(FLAG:현Y-1)
							SIF RESULT == 0
								CONTINUE
							;SIF DA:(FLAG:현X-1):(FLAG:현Y-1) % 10 == 0 || DA:(FLAG:현X-1):(FLAG:현Y-1) % 10 == 2
								;CONTINUE
;						CASE 1
;							SIF (DA:(FLAG:현X-1):(FLAG:현Y-1) % 10 == 0 || DA:(FLAG:현X-1):(FLAG:현Y-1) % 10 == 2) && (DA:(FLAG:현X-1):(FLAG:현Y) == 0 || DA:(FLAG:현X-1):(FLAG:현Y) == 2)
;								CONTINUE
						CASE 1,2,3
							CALL CAN_SEE_THROUGH,(FLAG:현X-1),(FLAG:현Y)
							SIF RESULT == 0
								CONTINUE
						;	SIF (DA:(FLAG:현X-1):(FLAG:현Y) % 10 == 0 || DA:(FLAG:현X-1):(FLAG:현Y) % 10 == 2)
						;		CONTINUE
;						CASE 3
;							SIF (DA:(FLAG:현X-1):(FLAG:현Y+1) == 0 || DA:(FLAG:현X-1):(FLAG:현Y+1) == 2) && (DA:(FLAG:현X-1):(FLAG:현Y) == 0 || DA:(FLAG:현X-1):(FLAG:현Y) == 2)
;								CONTINUE
						CASE 4
							CALL CAN_SEE_THROUGH,(FLAG:현X-1),(FLAG:현Y+1)
							SIF RESULT == 0
								CONTINUE
;							SIF DA:(FLAG:현X-1):(FLAG:현Y+1) % 10 == 0 || DA:(FLAG:현X-1):(FLAG:현Y+1) % 10 == 2
;								CONTINUE
						
					ENDSELECT
				CASE 1,2,3
					SELECTCASE LOCAL:1
						CASE 0
							CALL CAN_SEE_THROUGH,(FLAG:현X),(FLAG:현Y-1)
							SIF RESULT == 0
								CONTINUE
;							SIF (DA:(FLAG:현X-1):(FLAG:현Y-1) == 0 || DA:(FLAG:현X-1):(FLAG:현Y-1) == 2) && (DA:(FLAG:현X):(FLAG:현Y-1) == 0 || DA:(FLAG:현X):(FLAG:현Y-1) == 2)
						;	SIF (DA:(FLAG:현X):(FLAG:현Y-1) % 10 == 0 || DA:(FLAG:현X):(FLAG:현Y-1) % 10 == 2)
						;		CONTINUE
						CASE 4
;							SIF (DA:(FLAG:현X-1):(FLAG:현Y+1) == 0 || DA:(FLAG:현X-1):(FLAG:현Y+1) == 2) && (DA:(FLAG:현X):(FLAG:현Y+1) == 0 || DA:(FLAG:현X):(FLAG:현Y+1) == 2)
							CALL CAN_SEE_THROUGH,(FLAG:현X),(FLAG:현Y+1)
							SIF RESULT == 0
								CONTINUE
;							SIF (DA:(FLAG:현X):(FLAG:현Y+1) % 10 == 0 || DA:(FLAG:현X):(FLAG:현Y+1) % 10 == 2)
;								CONTINUE
					ENDSELECT
;				CASE 2
;					SELECTCASE LOCAL:1
;						CASE 0
;							SIF (DA:(FLAG:현X):(FLAG:현Y-1) == 0 || DA:(FLAG:현X):(FLAG:현Y-1) == 2)
;								CONTINUE
;						CASE 4
;							SIF (DA:(FLAG:현X):(FLAG:현Y+1) == 0 || DA:(FLAG:현X):(FLAG:현Y+1) == 2)
;								CONTINUE
;					ENDSELECT
;				CASE 3
;					SELECTCASE LOCAL:1
;						CASE 0
;							SIF (DA:(FLAG:현X+1):(FLAG:현Y-1) == 0 || DA:(FLAG:현X+1):(FLAG:현Y-1) == 2) && (DA:(FLAG:현X):(FLAG:현Y-1) == 0 || DA:(FLAG:현X):(FLAG:현Y-1) == 2)
;								CONTINUE
;						CASE 4
;							SIF (DA:(FLAG:현X+1):(FLAG:현Y+1) == 0 || DA:(FLAG:현X+1):(FLAG:현Y+1) == 2) && (DA:(FLAG:현X):(FLAG:현Y+1) == 0 || DA:(FLAG:현X):(FLAG:현Y+1) == 2)
;								CONTINUE
;					ENDSELECT
				CASE 4
					SELECTCASE LOCAL:1
						CASE 0
							CALL CAN_SEE_THROUGH,(FLAG:현X+1),(FLAG:현Y-1)
							SIF RESULT == 0
								CONTINUE
							;SIF DA:(FLAG:현X+1):(FLAG:현Y-1) % 10 == 0 || DA:(FLAG:현X+1):(FLAG:현Y-1) % 10 == 2
							;	CONTINUE
;						CASE 1
;							SIF (DA:(FLAG:현X+1):(FLAG:현Y-1) == 0 || DA:(FLAG:현X+1):(FLAG:현Y-1) == 2) && (DA:(FLAG:현X+1):(FLAG:현Y) == 0 || DA:(FLAG:현X+1):(FLAG:현Y) == 2)
;								CONTINUE
						CASE 1,2,3
							CALL CAN_SEE_THROUGH,(FLAG:현X+1),(FLAG:현Y)
							SIF RESULT == 0
								CONTINUE
							;SIF (DA:(FLAG:현X+1):(FLAG:현Y) % 10 == 0 || DA:(FLAG:현X+1):(FLAG:현Y) % 10 == 2)
							;	CONTINUE
;						CASE 3
;							SIF (DA:(FLAG:현X+1):(FLAG:현Y+1) == 0 || DA:(FLAG:현X+1):(FLAG:현Y+1) == 2) && (DA:(FLAG:현X+1):(FLAG:현Y) == 0 || DA:(FLAG:현X+1):(FLAG:현Y) == 2)
;								CONTINUE
						CASE 4
							CALL CAN_SEE_THROUGH,(FLAG:현X+1),(FLAG:현Y+1)
							SIF RESULT == 0
								CONTINUE
						;	SIF DA:(FLAG:현X+1):(FLAG:현Y+1) % 10 == 0 || DA:(FLAG:현X+1):(FLAG:현Y+1) % 10 == 2
						;		CONTINUE
						
					ENDSELECT
				
			ENDSELECT
			;TA:(FLAG:현M*100+FLAG:현던전):(FLAG:현X+LOCAL-2):(FLAG:현Y+LOCAL:1-2) = 1
			
			;CALL SET_FLOOR_ANALYZE(1, FLAG:현던전, FLAG:현M, FLAG:현X+LOCAL-2, FLAG:현Y+LOCAL:1-2)
			CALLF DPOINT( "=" , 1)
			;SIF DPOINT( "=" , 1)
			;	CONTINUE
		ENDIF
			
	NEXT
NEXT
$DARK
;CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X, FLAG:현Y)
CALLF DPOINT( "=" , 2 , FLAG:현X , FLAG:현Y)

;=====================================================================
;타일 건너편을 투과할 수 있는지 처리
;=====================================================================
@CAN_SEE_THROUGH,ARG,ARG:1
TRYCCALLFORM CAN_SEE_THROUGH_{FLAG:현던전}_{DA:ARG:(ARG:1)%10},DA:ARG:(ARG:1),ARG,ARG:1
	RETURN RESULT
CATCH
	SIF DA:ARG:(ARG:1) % 10 == 0 || DA:ARG:(ARG:1) % 10 == 2
		RETURN 0
	SIF DA:ARG:(ARG:1) == -1 && (EQUIP:MASTER:다크스캐너 == 0 || NUM_SUMMONER() == 0) && FLAG:라이트마 == 0
		RETURN 0
ENDCATCH
RETURN 1

;=====================================================================
;COMP起動
;=====================================================================
@COMMAND_COMP_FIELD
SIF NUM_SUMMONER(1)
	PRINTL [0] 소환
PRINTL [1] 귀환
PRINTL [2] 동료마 삭제
SIF NUM_SUMMONER()
	PRINTL [3] ２신 합체
IF FLAG:DEBUG
	SIF FLAG:현던전 != [[던전:타르타로스]]
		PRINTL [4] 맵 이동
ELSE
	SIF EQUIP:MASTER:허니・비 && NUM_SUMMONER() && FLAG:현던전 != [[던전:타르타로스]]
		PRINTL [4] 맵 표시
ENDIF
SIF SOFT_ON("ＤＤＭ")
	PRINTL [7] ＤＤＭ
PRINTL [8] 능력치 강화
SIF SOFT_ON("삼히타")
	PRINTL [9] 만트라 습득
PRINTFORML \@(EQUIP:MASTER:백어퍼 && NUM_SUMMONER()) || FLAG:DEBUG ? [10] 세이브 # [10] 중단 세이브\@
PRINTL [11] 로드
PRINTL [12] 오토 리커버

;ゴリ押しでマガタマ체크
LOCAL:1 = 0
FOR LOCAL, 1, 7
	SIF POS(LOCAL) < 0
		CONTINUE
	SIF !TALENT:POS(LOCAL):인수라
		CONTINUE
	;行動可能なキャラでないとダメ
	CALL INPUTABLE_CHARA, POS(LOCAL)
	SIF !RESULT
		CONTINUE
	LOCAL:1 = 1
	BREAK
NEXT
SIF LOCAL:1
	PRINTL [13] 곡옥(플러그인)변경
SIF SOFT_ON("우파니샤드",3);054
	PRINTL [14] 식노 스킬 변경
SIF FLAG:레벨업시인터페이스설정 == 3
	PRINTL [20] 성장비율설정
;---- EDIT LINKUI ADD START ---------------------------
PRINTL [30] 링케이지 목록
;---- EDIT LINKUI ADD END ---------------------------
PRINTL [99] 옵션
PRINTL [100] 돌아간다

$INPUT_LOOP
INPUT
IF RESULT == 100
	RETURN 0
ELSEIF RESULT == 0 && NUM_SUMMONER(1)

	$CHOOSE_COMPANION_LOOP
	CALL CHOOSE_COMPANION,1
	IF RESULT == 1000
		RESTART
	ELSE
		LOCAL = RESULT
		CALL SHOW_NOW_FORMATION_P,0,2, 3
		PRINTL [0] ＣＡＮＣＥＬ [2000]ＡＬＬ ＣＡＮＣＥＬ
		PRINTL 어디에 소환하겠습니까?
		$INPUT_SUMMON_POSITION_LOOP
		INPUT
		LOCAL:1 = RESULT
		IF RESULT == 0
			GOTO CHOOSE_COMPANION_LOOP
		ELSEIF RESULT == 2000
			RETURN 0
		ELSEIF RESULT > 0 && RESULT < 7
			;---- EDIT 013 ADD START -------------------------
			IF POS(LOCAL:1) > 0 && CFLAG:POS(LOCAL:1):소속ＣＯＭＰ == -1 && FLAG:SHOP커맨드 == [[SHOP:탐색]] && !(LOCAL:1 < 4 && POS(LOCAL:1+3) == -1)
				PRINTFORML %조사처리(CALLNAME:POS(LOCAL:1),"는")% 자택 서버에 등록되어 있는 악마입니다
				PRINTL 던전에서는 자택 서버에 등록되어있는 악마를 파티에서 뺄 수 없습니다
				PRINTW 다른 포지션을 선택해서 소환해주세요
				CLEARLINE 3
				GOTO INPUT_SUMMON_POSITION_LOOP
			ENDIF
			;---- EDIT 013 ADD END   -------------------------
			CALL INSERT_POSITION,LOCAL:1,LOCAL
			IF RESULT > -1
				SELECTCASE FLAG:SHOP커맨드
					CASE [[SHOP:탐색]],[[SHOP:콜로세움참가]],[[SHOP:이벤트]],[[SHOP:의뢰청부]]
						IF CFLAG:(LOCAL):PT플래그 > 0 && ABL:(LOCAL):종족 != 0
							BASE:MASTER:ＭＡＧ -= MAXBASE:LOCAL:￥
						ENDIF
				ENDSELECT
			ENDIF
			
			
			GOTO CHOOSE_COMPANION_LOOP
		ELSE
			GOTO INPUT_SUMMON_POSITION_LOOP
		ENDIF
	ENDIF
ELSEIF RESULT == 1
	CALL SETUP_REMOVE
ELSEIF RESULT == 2
	CALL SETUP_PARTING
ELSEIF RESULT == 3 && NUM_SUMMONER()
	CALL FUSION_DOUBLE,2,1
	;末꼬리キャラが필터링플래그を持っていない場合（新キャラを作った場合）ソート実行
	;IF !CFLAG:(CHARANUM-1):필터링플래그
	;	FOR LOCAL:4, 0, CHARANUM - 1
	;		IF CFLAG:(LOCAL:4):필터링플래그
	;			FOR LOCAL:5, LOCAL:4, CHARANUM
	;				SIF CFLAG:(LOCAL:5):필터링플래그
	;					CONTINUE
	;				SIF TARGET == LOCAL:5
	;					TARGET = LOCAL:4
	;				SWAPCHARA LOCAL:4, LOCAL:5
	;				BREAK
	;			NEXT
	;		ENDIF
	;	NEXT
	;	;一応포지션復帰
	;	CALL REFRESH_POS
	;ENDIF
	
ELSEIF RESULT == 4 && ((EQUIP:MASTER:허니・비 && NUM_SUMMONER()) || FLAG:DEBUG) && FLAG:현던전 != [[던전:타르타로스]]
	CALL HONEY_BEE
ELSEIF RESULT == 7 && SOFT_ON("ＤＤＭ")
	CALL COMP_DDM
ELSEIF RESULT == 8
	$MAG_LOOP
	CALL SHOW_NOW_FORMATION_P,0,2
	PRINTL [0] ＣＡＮＣＥＬ [2000]ＡＬＬ ＣＡＮＣＥＬ
	PRINTL 누구를 강화하겠습니까?
	$INPUT_MAG_LOOP
	INPUT
	IF RESULT == 0
		RESTART
	ELSEIF RESULT == 2000
		RETURN 0
	ELSEIF RESULT < 1 || RESULT > 6 || POS(RESULT) < 1
		GOTO INPUT_MAG_LOOP
	ENDIF
	LOCAL:1 = CFLAG:POS(RESULT):능력강화횟수/3 + 1
	SELECTCASE FLAG:전투난이도
		CASE 1 TO 3
			LOCAL:10 = 250
		CASE 4,5,6
			LOCAL:10 = 100
	ENDSELECT
	SIF POS(RESULT) == 0
		LOCAL:10 *= 100
	IF BASE:POS(RESULT):ＭＡＧ < LOCAL:10*LOCAL:1*(LOCAL:1+1)
		PRINTW ＭＡＧ가 부족합니다
		CLEARLINE 2
		GOTO INPUT_MAG_LOOP
	ENDIF
	
	CALL ENHANCE_BASE,POS(RESULT)
	GOTO MAG_LOOP
	
ELSEIF RESULT == 9 && SOFT_ON("삼히타")
	CALL KARMAN
ELSEIF RESULT == 10
	IF (EQUIP:MASTER:백어퍼 && NUM_SUMMONER()) || FLAG:DEBUG
		CALL TITLE_SAVEGAME
	ELSE
		PRINTFORML 중단 세이브를 기록하고, 게임을 종료해도 되겠습니까?
		CALL INPUT_YN
		IF !RESULT
			LOADGLOBAL
			;GLOBALが0のとき、ここで初生成を行い
			;以降は데이터呼び出し時に生成をする
			SIF GLOBAL == 0
				GLOBAL = RAND:10000 + 1
			FLAG:임시세이브관리 = GLOBAL
			GLOBAL:1 = GLOBAL:1 % 10 + 10
			SAVEGLOBAL
			SAVEDATA 400, DISP_SAVETEXT()
			PRINTW 수고하셨습니다. Emuera를 종료합니다.
			PRINTW 그리고 중단 세이브는 로드하면 소거되니 주의하세요.
			PRINTW 쉬는 동안 악마에게 몸을 빼앗기지 않도록 조심하길……
			QUIT
		ELSE
			PRINTW 그럼 게임을 재개합니다
		ENDIF
	ENDIF
ELSEIF RESULT == 11
	CALL TITLE_LOADGAME
ELSEIF RESULT == 12
	CALL AUTO_RECOVER
ELSEIF RESULT == 13
	LOCAL:1 = 0
	FOR LOCAL, 1, 7
		SIF POS(LOCAL) < 0
			CONTINUE
		SIF !TALENT:POS(LOCAL):인수라
			CONTINUE
		;行動可能なキャラでないとダメ
		CALL INPUTABLE_CHARA, POS(LOCAL)
		SIF !RESULT
			CONTINUE
		LOCAL:1 = 1
		BREAK
	NEXT
	IF !LOCAL:1
		PRINTFORMW  플러그인을 변경할 수 있는 캐릭터가 없습니다
		RESTART
	ENDIF
	LOCAL:2 = LINECOUNT
	$MAGATAMA_LOOP
	CLEARLINE LINECOUNT - LOCAL:2
	CALL SHOW_NOW_FORMATION_P,0,2
	PRINTL [0] ＣＡＮＣＥＬ [2000]ＡＬＬ ＣＡＮＣＥＬ
	PRINTL 누구의 플러그인을 변경하겠습니까?
	CALL INPUTINT(0,1,2,3,4,5,6,2000)
	IF RESULT == 0
		RESTART
	ELSEIF RESULT == 2000
		RETURN 0
	ELSE
		LOCAL = POS(RESULT)
		SIF LOCAL < 0
			GOTO MAGATAMA_LOOP
		IF !TALENT:LOCAL:인수라
			GOTO MAGATAMA_LOOP
		ENDIF
		CALL INPUTABLE_CHARA, LOCAL
		IF !RESULT
			PRINTFORMW %조사처리(CALLNAME:LOCAL,"는")% 사용할 수 있는 상태가 아닙니다
			GOTO MAGATAMA_LOOP
		ENDIF
		CALL CHANGE_PLUGIN_SOFT, LOCAL
		GOTO MAGATAMA_LOOP
	ENDIF
ELSEIF RESULT == 14 && SOFT_ON("우파니샤드",3);054
	CALL SET_KARMANS_SKILL
ELSEIF RESULT == 20 && FLAG:레벨업시인터페이스설정 == 3
		SWAP LOCAL,FLAG:SHOP커맨드
		FLAG:SHOP커맨드 = 40032
		CALL LVUP_AUTOIF2_SETUP
		SWAP LOCAL,FLAG:SHOP커맨드
;---- EDIT LINKUI ADD START ---------------------------
ELSEIF RESULT == 30
	CALL SHOW_LINKAGE
;---- EDIT LINKUI ADD END ---------------------------
ELSEIF RESULT == 99
	CALL SHOP_COM_400
ELSE
	GOTO INPUT_LOOP
ENDIF
CALL REFRESH_FORMATION
RESTART

;=====================================================================
;아이템사용
;=====================================================================
@COMMAND_ITEM_FIELD
DRAWLINE
PRINTL [1]아이템 사용
PRINTL [2]소지품 확인
PRINTL
PRINTL [0]돌아간다

CALL INPUTINT(0,1,2)
SELECTCASE RESULT
	CASE 0
		RETURN 0
	CASE 2
		CALL SHOP_COM_112
		RESTART
ENDSELECT

$ITEM_LIST
FOR LOCAL,1001,2000
	TRYCCALLFORM SKILL_ACTIONABLE_FIELD_{LOCAL+2000}
		SIF RESULT == 0 || ITEM:LOCAL < 1
		;非전투時に使えないor一個も持っていない場合無視
			CONTINUE
	CATCH
		;未実装아이템は無視
		CONTINUE
	ENDCATCH
			TRYCCALLFORM 최대소지수_{LOCAL+2000}
				;PRINTFORMC [{LOCAL}] %ITEMNAME:LOCAL,20,LEFT% \@(ITEM:LOCAL < 10) ? " " # \@{ITEM:LOCAL}/{RESULT,2}個　
				;PRINTFORMC [{LOCAL}] %ITEMNAME:LOCAL,20,LEFT% {ITEM:LOCAL}/{RESULT,2}個　
				PRINTFORMC [{LOCAL}] %ITEMNAME:LOCAL,(ITEM:LOCAL < 10) ? 21 # 20,LEFT% {ITEM:LOCAL}/{RESULT,2}개　
			CATCH
				PRINTFORMC [{LOCAL}] %ITEMNAME:LOCAL,20,LEFT% {ITEM:LOCAL}/99개　
			ENDCATCH
NEXT
PRINTL
DRAWLINE
PRINTL [0] 돌아간다    [2000] 메뉴에서 나간다


$INPUT_LOOP
INPUT
IF RESULT == 0 || RESULT == 2000
	;連続사용に関わるので寝かせとく
	LOCAL:3 = 0
	LOCAL:2 = 0
	IF RESULT == 0
		RESTART
	ELSE
		RETURN 0
	ENDIF
ELSEIF RESULT >= 2000
	GOTO INPUT_LOOP
ELSE
	;1~6を選ぶことで1체아이템は連続사용できる
	IF RESULT > 0 && RESULT < 7 && LOCAL:3 >= 3000 && (LOCAL:2 < 7 && LOCAL:2 > 0)
		SIF POS(RESULT) == -1
			GOTO INPUT_LOOP
		LOCAL:2 = RESULT
		TRYCALLFORM SKILL_ACTIONABLE_FIELD_{LOCAL:3}
		SIF RESULT == 0 || ITEM:(LOCAL:3-2000) < 1
			GOTO INPUT_LOOP
		LOCAL = LOCAL:3
	ELSE
		LOCAL = RESULT+2000
		LOCAL:3 = LOCAL
		TRYCCALLFORM SKILL_ACTIONABLE_FIELD_{RESULT+2000}
			SIF RESULT == 0 || ITEM:(LOCAL-2000) < 1
				GOTO INPUT_LOOP
		CATCH
			GOTO INPUT_LOOP
		ENDCATCH
		SIF FLAG:스킬속성표시설정 == 1
			CALL SKILL_EXPLAIN_PERFORMANCE, LOCAL, MASTER
		TRYCALLFORM SKILL_EXPLAIN_{LOCAL}
	;	CALLFORM SKILL_SPHERE_{LOCAL}

		CALL SELECT_SKILL_TARGET,LOCAL,MASTER
		SIF RESULT == -1
			RESTART
		
		LOCAL:2 = RESULT
		IF RESULT == 19
			PRINTL [1] 쓴다 [0] 그만둔다
			$INPUT_LOOP1
			INPUT
			IF RESULT == 1
			ELSEIF RESULT == 0
				RESTART
			ELSE
				GOTO INPUT_LOOP1
			ENDIF
			
		ENDIF
	ENDIF
	CALLFORM ACTION_FIELD_{LOCAL},0,LOCAL:2
	;회복아이템を使うことが多いだろうのでここでステ確認できるように
	CALL SHOW_NOW_FORMATION_P, 0, 2
	GOTO ITEM_LIST
;	IF RESULT == 1
	;1체눈標の아이템
;		CALL SHOW_NOW_FORMATION_P,0,2
;		PRINTL [0]やめる
;		$INPUT_LOOP2
;		INPUT
;		IF RESULT == 0
;			RESTART
;		ELSEIF RESULT < 1 || RESULT > 6
;			GOTO INPUT_LOOP2
;		ELSE
;			LOCALS = 포지션{RESULT}
;			SIF FLAG:LOCALS == -1
;				GOTO INPUT_LOOP2
;			CALLFORM ACTION_FIELD_{LOCAL},0,FLAG:LOCALS
;		ENDIF
;		RESTART
;	ELSEIF RESULT == 2
;		CALL SHOW_NOW_FORMATION_P,0,2
;		PRINTL [17] 前列 [18] 後列
;		PRINTL [0] やめる
;		$INPUT_LOOP3
;		INPUT
;		IF RESULT == 0
;			RESTART
;		ELSEIF RESULT != 17 && RESULT != 18
;			GOTO INPUT_LOOP3
;		ELSE
;			CALLFORM ACTION_FIELD_{LOCAL},0,RESULT
;		ENDIF
;		RESTART
;	ELSE
;		CALL SHOW_NOW_FORMATION_P,0,2
;		PRINTL [1] 使う [0] やめる
;		$INPUT_LOOP4
;		INPUT
;		IF RESULT == 0
;			RESTART
;		ELSEIF RESULT != 1 && RESULT != 0
;			GOTO INPUT_LOOP4
;		ELSE
;			CALLFORM ACTION_FIELD_{LOCAL},0,19
;		ENDIF
;		RESTART
;	ENDIF
	
ENDIF

CALL FIGHT_IT_OUT
SIF FLAG:패배플래그 == 1
	CALL DEADEND
SIF FLAG:탈출
	RETURN 1


;=====================================================================
;魔法・特技사용
;=====================================================================
@COMMAND_MAGIC_FIELD_LIST,ARG
IF ARG == 2
	CALL INPUT_CHARA_LIST("누구의 마법을 씁니까？", "CASTING_COMMAND_MAGIC_FIELD_LIST")
ELSE
	CALL INPUT_CHARA_LIST("누구의 특기를 씁니까？", "CASTING_COMMAND_MAGIC_FIELD_LIST")
ENDIF
IF RESULT == 1000
	RETURN 0
ENDIF
CALL COMMAND_MAGIC_FIELD, ARG, RESULT
IF RESULT == 0
	RESTART
ELSEIF RESULT == -1
	RESTART
ELSE
	RETURN 1
ENDIF

@CASTING_COMMAND_MAGIC_FIELD_LIST(ARG:0)
;PTに居ない人間は無理
SIF CFLAG:(ARG:0):PT플래그 == 1 && (ABL:(ARG:0):종족 == 0 || ABL:(ARG:0):종족 > 45) && ABL:(ARG:0):종족 != 73
	RETURN 0
;PTに居ない악마もCOMP使える인간が居ないと無理
SIF (CFLAG:(ARG:0):PT플래그 == 1 && NUM_SUMMONER(1) == 0) || CFLAG:(ARG:0):전투참가불가능 > 0
	RETURN 0
SIF CFLAG:(ARG:0):노역플래그 == 3
	RETURN 0
SIF TALENT:(ARG:0):비전투원
	RETURN 0
SIF CFLAG:(ARG:0):소속ＣＯＭＰ == -1 && CFLAG:(ARG:0):PT플래그 != 2
	RETURN 0
SIF CFLAG:(ARG:0):이자리에없는플래그 == 1
	RETURN 0
RETURN 1


@COMMAND_MAGIC_FIELD, ARG, CHARA, ARG:2
#DIM CHARA
#DIM LINE, 2
#DIM SKILL, 42
#DIM USE_CONTINUE
$SKILLSTART
VARSET SKILL
CALL INPUTABLE_CHARA, CHARA
IF !RESULT
	PRINTFORMW %조사처리(NAME:CHARA,"는")% \@ ARG == 1 ? 기술 # 마법 \@을 쓸 수 있는 상태가 아니다.
	CLEARLINE 2
	RETURN -1
ENDIF

U = CHARA
LOCAL:1 = 0
IF (TALENT:CHARA:데빌시프터 !& TALENT:CHARA:식노) || CFLAG:CHARA:악마변신
	FOR LOCAL, 1, 42
		LOCAL = LOCAL == FLAG:이능자스킬수 + 1 ? 21 # LOCAL
		;스킬番号
		LOCAL:1 = ABL:CHARA:@"\@ LOCAL > 20 ? 장비 # \@스킬{LOCAL > 20 ? LOCAL - 20 # LOCAL}"
		SIF !LOCAL:1 && LOCAL > 20
			BREAK
		SIF !LOCAL:1
			CONTINUE
		RESULT = 0
		TRYCALLFORM SKILL_ACTIONABLE_FIELD_{LOCAL:1}
		SIF !RESULT	;非전투時に使えない場合無視
			CONTINUE
		CALLFORM SKILL_DECIDE_TYPE_{LOCAL:1}
		SIF RESULT != ARG	;特技の場合無視
			CONTINUE
		SKILL:LOCAL = LOCAL:1
	NEXT
ENDIF

SIF TALENT:CHARA:데빌시프터 || TALENT:CHARA:식노 || TALENT:CHARA:악마빙의자 > 1
	SKILL:0 = 1
SIF TALENT:CHARA:페르소나구사자 && EQUIP:CHARA:소지페르소나1
	SKILL:0 = 1
IF MATCH(SKILL, 0) == VARSIZE("SKILL")
	PRINTFORMW %조사처리(NAME:CHARA,"는")% 사용 가능한 \@ ARG == 1 ? 기술 # 마법 \@을 가지고 있지 않다.
	CLEARLINE 2
	RETURN -1
ENDIF
LINE = LINECOUNT

$PRINT_SKILLLIST
CLEARLINE LINECOUNT - LINE
CALL SHOW_NOW_FORMATION_P, 0, 2, , 1
PRINTFORML %CALLNAME:CHARA%
IF FLAG:커스텀게임화면
	PRINTFORML ＨＰ[{BASE:CHARA:ＨＰ,5}/{MAXBASE:CHARA:ＨＰ,5}]
	PRINTFORML ＭＰ[{BASE:CHARA:ＭＰ,5}/{MAXBASE:CHARA:ＭＰ,5}]
ELSE
	PRINTFORML ＨＰ[{BASE:CHARA:ＨＰ,4}/{MAXBASE:CHARA:ＨＰ,4}]
	PRINTFORML ＭＰ[{BASE:CHARA:ＭＰ,4}/{MAXBASE:CHARA:ＭＰ,4}]
ENDIF
DRAWLINE
LOCAL:2 = 0	;스킬数カウント用
FOR LOCAL, 1, 42
	SIF !SKILL:LOCAL
		CONTINUE
	CALLFORM SKILL_NAME_{SKILL:LOCAL}, CHARA
	CALLFORM SKILL_COSTTYPE_{SKILL:LOCAL}, CHARA
	LOCAL:1 = RESULT	;コスト타입
	CALLFORM SKILL_COST_{SKILL:LOCAL}, CHARA
	;/////////////////////////////////////////////
	SIF LOCAL:1 == 2
		RESULT = RESULT * MAXBASE:ARG:ＨＰ / 100
	CALL COST_CUT, RESULT, SKILL:LOCAL, CHARA
	;//////////////////////////////////////////////
	IF GETBIT (FLAG:커스텀게임화면,1)
		PRINTFORM [{LOCAL, 2}] %RESULTS, 38, LEFT%{RESULT, 3} \@ LOCAL:1 == 2 ? Ｈ # Ｍ \@Ｐ　　\@ LOCAL:2++ & 1 ? \n # \@
		;PRINTFORM [{LOCAL, 2}] %RESULTS, 38, LEFT%{LOCAL:1 == 2 ? RESULT * MAXBASE:ARG:ＨＰ / 100 # RESULT, 3} \@ LOCAL:1 == 2 ? Ｈ # Ｍ \@Ｐ　　\@ LOCAL:2++ & 1 ? \n # \@
	ELSE
		PRINTFORM [{LOCAL, 2}] %RESULTS, 20, LEFT%{RESULT, 3} \@ LOCAL:1 == 2 ? Ｈ # Ｍ \@Ｐ　　\@ LOCAL:2++ & 1 ? \n # \@
		;PRINTFORM [{LOCAL, 2}] %RESULTS, 20, LEFT%{LOCAL:1 == 2 ? RESULT * MAXBASE:ARG:ＨＰ / 100 # RESULT, 3}\@ LOCAL:1 == 2 ? Ｈ # Ｍ \@Ｐ　　\@ LOCAL:2++ & 1 ? \n # \@
	ENDIF
NEXT
PRINTL
IF TALENT:CHARA:데빌시프터 || TALENT:CHARA:식노 || TALENT:CHARA:악마빙의자 > 1
	DRAWLINE
	CALL SKILL_NAME_2310, CHARA
	PRINTFORM [{FLAG:스킬수 + 1, 2}] %RESULTS,20,LEFT%
	SIF CASTING_CHANGE_LINK_F(CHARA)
		PRINTFORM     　　　　[{FLAG:스킬수 + 2, 2}] 변신악마변경　　현재：\@ FINDCHARA_ID(CFLAG:CHARA:링크악마) > 0 ? %CALLNAME:FINDCHARA_ID(CFLAG:CHARA:링크악마)% # %CSVCALLNAME((CFLAG:CHARA:초기링크악마),0)%（디폴트） \@
	PRINTL 
ENDIF
IF TALENT:CHARA:페르소나구사자 && EQUIP:CHARA:소지페르소나1
	LOCAL:1 = GETCOLOR()
	DRAWLINE
	PRINTL Ｐ-ＣＨＡＮＧＥ
	FOR LOCAL, 0, 4
		LOCALS = 소지페르소나{LOCAL}
		SIF (LOCAL == 0 && !EQUIP:CHARA:장비페르소나) || (LOCAL > 0 && EQUIP:CHARA:장비페르소나 == EQUIP:CHARA:LOCALS)
			SETCOLOR 0x66FFFF
		IF LOCAL == 0
			IF ABL:CHARA:초기페르소나
				PRINTFORMD [{FLAG:스킬수 + 1, 2}] 
				PRINTFORM %CSVCALLNAME(ABL:CHARA:초기페르소나, 0)%　
			ENDIF
		ELSE
			IF EQUIP:CHARA:LOCALS
				PRINTFORMD [{FLAG:스킬수+1 + LOCAL, 2}] 
				;新페르소나処理
				IF BATTLE_SETTING_IS_PERSONA_NEW_FUNCTION()
				
				;旧페르소나処理
				ELSE
					PRINTFORM %CSVCALLNAME(DITEMTYPE:(EQUIP:CHARA:LOCALS):페르소나("NO"), 0)%　
				ENDIF
			ENDIF
		ENDIF
		SETCOLOR LOCAL:1
	NEXT
	PRINTL 
ENDIF
DRAWLINE
PRINTFORM [0] 돌아간다\@ ARG:2 == 1? # %" " * 18%[2000] 메뉴에서 \@
PRINTFORML \@ ARG == 1 ? %" " * 12%[9999] 마법을본다 # %" " * 12%[9999] 특기를본다\@

LINE:1 = LINECOUNT
$INPUT_LOOP
CLEARLINE LINECOUNT - LINE:1
INPUT
IF !RESULT
	RETURN ARG:2 != 0
ELSEIF RESULT == 9999
	IF ARG == 1
		ARG = 2
	ELSE
		ARG = 1
	ENDIF
	GOTO SKILLSTART
ELSEIF RESULT == 2000 && !ARG:2
	RETURN 1
ELSEIF RESULT == FLAG:스킬수 + 1 && (TALENT:CHARA:데빌시프터 ||  TALENT:CHARA:식노 || TALENT:CHARA:악마빙의자 > 1)
	CALL ACTION_2310, CHARA
	RESTART
ELSEIF RESULT == FLAG:스킬수 + 2 && CASTING_CHANGE_LINK_F(CHARA)
	CALL ACTION_2311, CHARA
	RESTART
ELSEIF INRANGE(RESULT, FLAG:스킬수 + 1, FLAG:스킬수 + 4) && TALENT:CHARA:페르소나구사자
	IF RESULT == FLAG:스킬수 + 1
		SIF !ABL:CHARA:초기페르소나
			GOTO INPUT_LOOP
		EQUIP:CHARA:장비페르소나 = 0
	ELSE
		LOCALS = 소지페르소나{RESULT - FLAG:스킬수 - 1}
		SIF !EQUIP:CHARA:LOCALS
			GOTO INPUT_LOOP
		EQUIP:CHARA:장비페르소나 = EQUIP:CHARA:LOCALS
	ENDIF
	CALL SYNC_STATUS(CHARA)
	RESTART
ELSEIF INRANGE(RESULT, 1, 42) && SKILL:RESULT
;ここはあまり自信が無いのでアレしてたらごめんなさい
	LOCAL = SKILL:RESULT	;選択스킬
	LOCAL:1 = 0				;GOTOフラグ
	RESULT = 0
	TRYCALLFORM SKILL_ACTIONABLE_FIELD_{LOCAL}
	LOCAL:1 |= !RESULT			;非전투時に使えない場合無視
	CALLFORM SKILL_DECIDE_TYPE_{LOCAL}
	LOCAL:1 |=  RESULT != ARG	;特技の場合無視
	CALL CHECK_ACTIONABLE, CHARA, LOCAL
	SIF LOCAL:1 || !RESULT		;사용不能なら無視
		GOTO INPUT_LOOP
	
	SIF FLAG:스킬속성표시설정
		CALL SKILL_EXPLAIN_PERFORMANCE, LOCAL, CHARA
	TRYCALLFORM SKILL_EXPLAIN_{LOCAL}
	CALL SELECT_SKILL_TARGET, LOCAL, CHARA
	SIF RESULT < 0
		RESTART
	LOCAL:1 = RESULT	;타겟
	IF RESULT == 19
		CALL INPUT_YN, "사용한다", "그만둔다"
		SIF RESULT
			RESTART
	ENDIF
	
	CALL PAY_COST, CHARA, LOCAL
	CALLFORM ACTION_FIELD_{LOCAL}, CHARA, LOCAL:1
ELSE
	GOTO INPUT_LOOP
ENDIF

CALL FIGHT_IT_OUT
SIF FLAG:패배플래그 == 1
	CALL DEADEND
SIF FLAG:탈출
	RETURN 1
;리캄도라などで行動不能になった場合、終了
CALL INPUTABLE_CHARA, CHARA
SIF !RESULT
	RETURN 1
DRAWLINE
GOTO PRINT_SKILLLIST

;=====================================================================
;무후후전개時用コマンド
;=====================================================================
@DUNGEON_MUFUFU,ARG
DRAWLINE
PRINTL [1] 갈아입기
PRINTL [2] 성욕처리
PRINTL [3] 휴식（결계석 필요）
;---- EDIT 041 ADD START   -------------------------
IF FLAG:조교난이도 < 3
	PRINT [4] 조교（결계석 필요
	SIF FLAG:MAG소비율 > 0
		SETCOLOR 404040
	SIF FLAG:조교난이도 == 1
		PRINT 、또는 안전한 장소
	RESETCOLOR
	PRINTL ）
ELSE
	SETCOLOR 404040
	PRINT [-]---
	RESETCOLOR
ENDIF
;---- EDIT 041 ADD END   -------------------------
PRINTL [100]돌아간다
CALL INPUTINT , 1, 2, 3, 4, 100
IF RESULT == 100
	RETURN 0
ELSEIF RESULT == 1
	CALL SHOW_NOW_FORMATION_P, 0 , 2
	PRINTL [9] 돌아간다
	$LOOP_KIGAE
	CALL INPUTINT , 1 , 2 , 3 , 4 , 5 , 6, 9
	LOCAL = POS(RESULT)
	IF RESULT == 9
		RETURN 0
	ELSEIF LOCAL == -1
		CLEARLINE 1
		GOTO LOOP_KIGAE
	ELSEIF CFLAG:LOCAL:전투참가불가능 == -1
		PRINTW 거절당했다
		CLEARLINE 1
		GOTO LOOP_KIGAE
	ENDIF
	CALL ACTIONABLE_CHARA,LOCAL
	IF RESULT == 0
		PRINTW 옷을 갈아입을 수 있는 상태가 아니다
		CLEARLINE 1
		GOTO LOOP_KIGAE
	ENDIF
	CALL CLOTHES_CHANGE,LOCAL , 1
	
	RESTART
ELSEIF RESULT == 2
	CALL SHOW_NOW_FORMATION_P, 0 , 2
	PRINTL [9] 돌아간다
	$LOOP_SELECT
	CALL INPUTINT , 1 , 2 , 3 , 4 , 5 , 6, 9
	LOCAL = POS(RESULT)
	IF RESULT == 9
		RETURN 0
	ELSEIF LOCAL == -1
		CLEARLINE 1
		GOTO LOOP_SELECT
	ELSE
		CALL ACTIONABLE_CHARA,LOCAL
		IF RESULT == 0
			PRINTW 그런 일을 할 수 있는 상태가 아니다
			CLEARLINE 2
			GOTO LOOP_SELECT
		ENDIF
		IF CFLAG:LOCAL:전투참가불가능 == -1 && LOCAL != MASTER
			IF 위험일(LOCAL) == 2
				PRINTW 참으려 하는 것 같다…
			ELSE
				PRINTW 거부당했다
			ENDIF
			CLEARLINE 2
			GOTO LOOP_SELECT
		;체력が최저でも100ないとダメ
		ELSEIF BASE:LOCAL:체력 < 100
			PRINTW 지쳐있다
			CLEARLINE 2
			GOTO LOOP_SELECT
		ENDIF
	ENDIF
	;プレイ選択
	PRINTL 어떻게 하겠습니까?
	PRINTL 
	PRINTFORM %CALLNAME:LOCAL%　　
	SELECTCASE 위험일(LOCAL)
	CASE 1
		SETCOLOR 0xCC33FF
			CALL HEARTB
		PRINTFORM 위험일
			CALL HEARTB
		RESETCOLOR
	CASE 2
		SETCOLOR 0xCC33FF
			CALL HEARTB
		PRINTFORM 발정중
			CALL HEARTB
		RESETCOLOR
	CASE 3,-2
		SETCOLOR 0xCC33FF
			CALL HEARTB
		PRINTFORM 만월발정중
			CALL HEARTB
		RESETCOLOR
	ENDSELECT
	PRINTL 
	$LOOP_SEIYOKUSYORI
	CALL INPUT_SELECT,1,"동료마와 섹스한다",2,"동료마에게 봉사하도록 시킨다",3,"그 장소에서 자위한다",4,"그늘에서 자위하고 온다",5,"불결을 털어낸다",6,"그만둔다"
	
	
	RESULT:1 = RESULT
	LOCAL:1 = -1
	SELECTCASE RESULT
		CASE 1 , 2
			
			CALL SHOW_NOW_FORMATION_P, 0 , 2
			$LOOP_SELECT_2
			CALL INPUTINT , 1 , 2 , 3 , 4 , 5 , 6
			LOCAL:1 = POS(RESULT)
			IF GROUPMATCH(LOCAL:1 , -1 , LOCAL)
				CLEARLINE 1
				GOTO LOOP_SELECT
			ELSE
				;女は매각出来ないと無理だが、男だと誘う側が見た눈女なら飛びつく
				IF CFLAG:(LOCAL:1):매각가능 == 0 && !(!IS_LOOKSLIKE_MALE(LOCAL) && IS_MALE(LOCAL:1)) && LOCAL:1 != MASTER
					IF 위험일(LOCAL:1) == 2
						PRINTW 참으려 하는 것 같다…
					ELSE
						PRINTW 거부당했다
					ENDIF
					CLEARLINE 2
					GOTO LOOP_SELECT_2
				;二人とも見た눈男の場合、抱く側にＢＬ내성無いと駄눈
				ELSEIF GROUPMATCH ( 1 , IS_LOOKSLIKE_MALE(LOCAL) , IS_LOOKSLIKE_MALE(LOCAL:1) ) == 2 && ABL:LOCAL:ＢＬ끼 == 0
					PRINTW 남색 취향은 없는 것 같다…
					CLEARLINE 2
					GOTO LOOP_SELECT_2
					
				;체력が최저でも100ないとダメ
				ELSEIF BASE:(LOCAL:1):체력 < 100
					PRINTW 지쳐있다
					CLEARLINE 2
					GOTO LOOP_SELECT_2
				ENDIF
			ENDIF
			IF RESULT:1 == 1
				PRINTFORML %조사처리(CALLNAME:LOCAL,"는")% %조사처리(CALLNAME:(LOCAL:1),"를")% 끌어안았다
			ELSE
				PRINTFORML %조사처리(CALLNAME:(LOCAL:1),"는")% %CALLNAME:LOCAL%에게 봉사하기 시작했다…
			ENDIF
		CASE 3
			;PRINTFORML %조사처리(CALLNAME:LOCAL,"는")% 그 자리에서 자신의 몸을 더듬기 시작했다…
		CASE 4
			PRINTFORML %조사처리(CALLNAME:LOCAL,"는")% 안절부절하면서 그 자리를 떠났다
		CASE 5
			PRINTFORML %조사처리(CALLNAME:LOCAL,"는")% 몸의 불결을 털어냈다
		CASE 6
			RETURN 0
	ENDSELECT
	CALL 성욕처리, LOCAL , LOCAL:1 ,  RESULT:1
	
	RESTART
;휴식
;아이템:結界石を一つ소비して체력･기력を회복する
ELSEIF RESULT == 3
	PRINTFORML 「결계석」을 하나 사용해서 휴식 하시겠습니까？　소지 수：{ITEM:결계석}
	CALL INPUT_YN, "휴식한다", "그만둔다"
	SELECTCASE RESULT
		CASE 0
			IF ITEM:결계석 == 0
				PRINTFORMW 결계석을 가지고 있지 않습니다
				RESTART
			ENDIF
			PRINTFORMW %CALLNAME:MASTER%은 간이적인 결계를 펼치고 휴식했다.
			FOR LOCAL,1,7
				LOCALS = 포지션{LOCAL}
				IF FLAG:LOCALS > -1
					LOCAL:1 = FLAG:LOCALS
					BASE:(LOCAL:1):체력 = MAXBASE:(LOCAL:1):체력
					BASE:(LOCAL:1):기력 = MAXBASE:(LOCAL:1):기력
				ENDIF
				;불결も落す
				CALL 성욕처리, LOCAL:1 , -1 , 5
				STAIN:(LOCAL:1):질내 = 0
				;욕정をに
				CFLAG:(LOCAL:1):던전내발정용욕정치 = 0
			NEXT
			ITEM:결계석 -= 1
		CASE 1
			RESTART
	ENDSELECT
;---- EDIT 041 ADD START   -------------------------
;던전내조교
;아이템:結界石を一つ소비してパーティメンツの一人に던전내조교を開始する。조교難易度がイージーならMAG소비율０の場所でも代替可能とする。ハードは選択不可。
;ただし行った場合、一日に複数回탐색可能でも탐색횟수1回行ったように疲れるものとする
ELSEIF RESULT == 4
	;조교難易度ハード(以上)ならそもそも不可
	IF FLAG:조교난이도 >= 3
		RESTART
	ELSEIF ITEM:결계석 <= 0 && FLAG:조교난이도 > 1
		PRINTFORMW 결계석을 가지고 있지 않습니다
		RESTART
	ELSEIF ITEM:결계석 <= 0 && FLAG:MAG소비율 > 0 && FLAG:조교난이도 == 1
		PRINTFORMW 결계석을 가지고 있지 않으며、안전한 장소도 아닙니다
		RESTART
	;탐색횟수が一日に可能な횟수に余裕がなければダメ
	ELSEIF (FLAG:던전탐색완료) >= 1+(TALENT:MASTER:절륜 || TALENT:MASTER:수수께끼의매력 || TALENT:MASTER:금단의지식 || BASE:MASTER:LV >= 50)+(BASE:MASTER:LV >= 100)
		PRINTFORMW 탐색중에는 조교를 행할 여유가 없습니다
		RESTART
	ENDIF

	SIF (FLAG:조교난이도 > 1) || (FLAG:MAG소비율 > 0 && FLAG:조교난이도 == 1)
		PRINTFORM 결계석 하나와 
	PRINTFORMW 하루에 탐색할 수 있는 횟수를 사용해 조교를 실행합니다(체력・기력을 회복합니다)

	CALL SHOW_NOW_FORMATION_P, 0 , 2
	PRINTL [9] 돌아간다
	$LOOP_SELECTAA
	CALL INPUTINT , 1 , 2 , 3 , 4 , 5 , 6, 9
	LOCAL = POS(RESULT)
	IF RESULT == 9
		RETURN 0
	ELSEIF LOCAL == -1
		CLEARLINE 1
		GOTO LOOP_SELECTAA
	ELSE
		CALL ACTIONABLE_CHARA,LOCAL
		IF RESULT == 0
			PRINTW 그런 일을 할 수 있는 상태가 아니다
			CLEARLINE 2
			GOTO LOOP_SELECTAA
		ENDIF
		;行動不能だったりマスターならそもそも選択できない
		IF LOCAL == MASTER
			PRINTL 
			CLEARLINE 2
			GOTO LOOP_SELECTAA
		ELSEIF CFLAG:LOCAL:전투참가불가능 == -1 && LOCAL != MASTER
			PRINTL 
			CLEARLINE 2
			GOTO LOOP_SELECTAA
		;조교によって신뢰を失う相手やゲスト참가、あと반발각인3持つのも選べない
		ELSEIF !(CFLAG:LOCAL:전투참가불가능 == 0) || CFLAG:LOCAL:게스트가입플래그 == 1 || MARK:LOCAL:반발각인 >= 3 || TALENT:LOCAL:맹우
			PRINTW 거부당했다
			CLEARLINE 2
			GOTO LOOP_SELECTAA
		;체력が최저でも500ないとダメ(조교できる체력조건)
		ELSEIF BASE:LOCAL:체력 < 500
			PRINTW 지쳐있다
			CLEARLINE 2
			GOTO LOOP_SELECTAA
		ENDIF
		FLAG:던전내조교 = 1
		TARGET = LOCAL
		FLAG:던전탐색완료 += 1
		SIF (FLAG:조교난이도 > 1) || (FLAG:MAG소비율 > 0 && FLAG:조교난이도 == 1)
			ITEM:결계석 -= 1
	ENDIF

;---- EDIT 041 ADD END   -------------------------
ENDIF


;---- EDIT 016 ADD START -------------------------
;=====================================================================
;汎用적配置処理
;	#던전毎に定義が필요な関数(実際動かしてるところは에코빌딩などをみてください)
;		@CLASS_NUM_X 			적の出てくる종족数。1~3くらいを권장す
;		@CLASS_NUM_COMMON,ARG	적の종류数の기본的な数値を返す
;		@ENEMY_NUM_X,ARG		적の総数。종족数も送るので1~10の間で설정を
;						 	 	なお、1~10の間に自動的に丸めるので설정段階では10超えてもいいです
;		@ENEMY_NUM_COMMON,ARG	적の総数の기본的な数値を返す
;		@ENEMY_X				적の内容、RESULTが적のキャラ番号、RESULT:1が적のLVとなります
;		@ENEMYSET_X				上記のセット版、RESULT:偶数、RESULT:奇数が番号/LVとなります。組み合わせを固定で組みたい場合はこちら
;		@SET_ENEMY_STATUS_X		적스테이터스の特別変化。던전毎に能力をある程度変える場合はここでどうぞ
;=====================================================================
@ENEMY_TABLE
#DIM CLASS_NUM, 1
#DIM ENEMY_NUM, 1
#DIM MAXENEMY, 1
#DIM MINENEMY, 1
#DIM ENEMY, 10
#DIM ENEMYLV, 10
VARSET RESULT
VARSET ENEMY, -1
;最初に종족数を取得
TRYCCALLFORM CLASS_NUM_{FLAG:현던전}
	CLASS_NUM = RESULT
CATCH
	;一応、定義ファイルがない場合、디폴트の数値を代入
	SELECTCASE RAND:100
		CASE IS < 40
			CLASS_NUM = 1
		CASE IS < 80
			CLASS_NUM = 2
		CASEELSE
			CLASS_NUM = 3
	ENDSELECT
ENDCATCH
;적の総数を取得
TRYCCALLFORM ENEMY_NUM_{FLAG:현던전}, CLASS_NUM
	ENEMY_NUM = LIMIT(RESULT, CLASS_NUM, 10)
CATCH
	ENEMY_NUM = LIMIT(RESULT, CLASS_NUM*2, CLASS_NUM*4)
ENDCATCH
LOCAL = 0
;組み合わせ配置なら、それに
TRYCCALLFORM CALLFORM ENEMYSET_{FLAG:현던전}, CLASS_NUM
	FOR LOCAL, 0, CLASS_NUM+1
		ENEMY:LOCAL = RESULT:(LOCAL*2)
		ENEMYLV:LOCAL = RESULT:(LOCAL*2+1)
	NEXT
CATCH
	;組み合わせが랜덤ならこっち
;---- EDIT 053 MOD --- LOCAL:1を使って無限ループ対策、1000回繰り返すと出るように
	LOCAL:1 = 0
	WHILE LOCAL < CLASS_NUM && LOCAL:1 < 1000
		CALLFORM ENEMY_{FLAG:현던전}, CLASS_NUM
		;同一の적が来ないようにする
		SIF MATCH(ENEMY, RESULT)
			CONTINUE
		ENEMY:LOCAL = RESULT
		ENEMYLV:LOCAL = RESULT:1
		LOCAL += 1
		LOCAL:1 ++
	WEND
ENDCATCH
LOCAL = 0
;LOCAL:7~16に7~16を入れる
FOR LOCAL, 7, 17
	LOCAL:LOCAL = LOCAL
NEXT
;LOCAL:7~16をシャッフル
FOR LOCAL, 7, 17
	SWAP LOCAL:LOCAL, LOCAL:RAND(7, 17)
NEXT

;実際の配置
FOR LOCAL, 0, ENEMY_NUM
	LOCAL:1 = LOCAL:(LOCAL + 7)
	SIF POS(LOCAL:1) >= 0
		CONTINUE
	LOCAL:2 = LOCAL < CLASS_NUM ? LOCAL # RAND:CLASS_NUM
	CALL SET_ENEMY, LOCAL:1, ENEMY:(LOCAL:2), ENEMYLV:(LOCAL:2)
	;ここで스테이터스変化させる場合の関数を呼ぶ
	TRYCALLFORM SET_ENEMY_STATUS_{FLAG:현던전}, CHARANUM - 1
NEXT
;ミタマコイコイ
IF EQUIP:MASTER:미타마코이코이 && 10 > LOCAL && GET_SUMMONER_MLV() > 2 && RAND:100 < GET_SUMMONER_MLV() - 2
	CALLFORM ENEMY_{FLAG:현던전}, CLASS_NUM
	FOR LOCAL:1,7,17
		SIF POS(LOCAL:1) >= 0
			CONTINUE
		CALL SET_ENEMY, LOCAL:1, 1301 + RAND:4, ENEMYLV:(RAND:CLASS_NUM)
		BREAK
	NEXT
ENDIF

;東方MODEX虹追加分。
;ミタマコイコイは戦闘開始時、空きがある場合、サマナーレベル-2%の確率で1匹だけ御霊が追加で配置される機能。
;豪徳寺ミケのスキルは一律2％で同様の処理を行う様に。
FOR LOCAL:1,1,7
	LOCALS = 포지션{LOCAL:1}
	IF FLAG:LOCALS > -1 && GET_STATE(CFLAG:(FLAG:LOCALS):상태이상) != "DYING" && HAVE_PU_SKILL(POS(LOCAL:1),"招符「弾災招福」")
		IF RAND:100 < 2
				CALLFORM ENEMY_{FLAG:현던전}, CLASS_NUM
			FOR LOCAL:1,7,17
				SIF POS(LOCAL:1) >= 0
					CONTINUE
				CALL SET_ENEMY, LOCAL:1, 1301 + RAND:4, ENEMYLV:(RAND:CLASS_NUM)
				BREAK
			NEXT
		ENDIF
	ENDIF
NEXT

IF EQUIP:MASTER:미타마코이코이 && 10 > LOCAL && GET_SUMMONER_MLV() > 2 && RAND:100 < GET_SUMMONER_MLV() - 2
	CALLFORM ENEMY_{FLAG:현던전}, CLASS_NUM
	FOR LOCAL:1,7,17
		SIF POS(LOCAL:1) >= 0
			CONTINUE
		CALL SET_ENEMY, LOCAL:1, 1301 + RAND:4, ENEMYLV:(RAND:CLASS_NUM)
		BREAK
	NEXT
ENDIF
;---- EDIT 016 ADD END   -------------------------
;---- EDIT 017 ADD START -------------------------
@CLASS_NUM_COMMON, ARGS
#FUNCTION
SELECTCASE ARGS
	CASE "初級"
		SELECTCASE RAND:100
			CASE IS < 40
				RETURNF 1
			CASE IS < 95
				RETURNF 2
			CASEELSE
				RETURNF 3
		ENDSELECT
	CASE "中級"
		SELECTCASE RAND:100
			CASE IS < 40
				RETURNF 1
			CASE IS < 90
				RETURNF 2
			CASEELSE
				RETURNF 3
		ENDSELECT
	CASE "上級"
		SELECTCASE RAND:100
			CASE IS < 35
				RETURNF 1
			CASE IS < 90
				RETURNF 2
			CASEELSE
				RETURNF 3
		ENDSELECT
	CASE "最上級"
		SELECTCASE RAND:100
			CASE IS < 30
				RETURNF 1
			CASE IS < 90
				RETURNF 2
			CASEELSE
				RETURNF 3
		ENDSELECT
ENDSELECT
@ENEMY_NUM_COMMON, ARGS, ARG
#FUNCTION
SELECTCASE ARGS
	CASE "初級"
		RETURNF RAND(ARG, ARG*2+1)
	CASE "中級"
		RETURNF RAND(ARG, ARG*3+1)
	CASE "上級"
		RETURNF RAND(ARG, ARG*4+1)
	CASE "最上級"
		RETURNF RAND(ARG*2, ARG*4+1)
ENDSELECT
;---- EDIT 017 ADD END   -------------------------
;=====================================================================
;宝箱発見処理
;=====================================================================
@GET_TREASURE,ARG,ARG:1,ARG:2,ARG:3,ARG:4 = -1
PRINTL 상자가 놓여있다。 
CALL INPUT_YN,"연다","열지 않는다"

IF RESULT == 0
	CALL CHECK_ITEMMAX,ARG
	IF RESULT == 0
		PRINTFORMW %조사처리(ITEMNAME:ARG,"를")% {ARG:1}개 손에 넣었다
		CALL GET_ITEM,ARG,ARG:1
		DA:(FLAG:현X):(FLAG:현Y) = 1
		IF ARG:4 >= 0
			SETBIT 던전플래그:(ARG:2):(ARG:3), ARG:4
		ELSE
			던전플래그:(ARG:2):(ARG:3) = 1
		ENDIF
		RETURN 1
	ELSE
		PRINTFORMW %조사처리(ITEMNAME:ARG,"를")% {ARG:1}개 발견했지만 들고 갈 수 없었다
		RETURN 0
	ENDIF
ELSEIF RESULT == 1
	RETURN 0
ENDIF

;=====================================================================
;お金発見処理
;=====================================================================
@GET_TREASURE_MONEY,ARG,ARG:1,ARG:2,ARG:3,ARG:4 = -1
PRINTL 상자가 놓여있다。 
CALL INPUT_YN,"연다","열지 않는다"

IF RESULT == 0
	IF ARG == 0
		PRINTFORMW ￥{ARG:1} 손에 넣었다
		MONEY += ARG:1
		DA:(FLAG:현X):(FLAG:현Y) = 1
		IF ARG:4 >= 0
			SETBIT 던전플래그:(ARG:2):(ARG:3), ARG:4
		ELSE
			던전플래그:(ARG:2):(ARG:3) = 1
		ENDIF
		RETURN 1
	ELSE
		PRINTFORMW {ARG:1}마카를 손에 넣었다
		MONEY:1 += ARG:1
		DA:(FLAG:현X):(FLAG:현Y) = 1
		IF ARG:4 >= 0
			SETBIT 던전플래그:(ARG:2):(ARG:3), ARG:4
		ELSE
			던전플래그:(ARG:2):(ARG:3) = 1
		ENDIF
		RETURN 1
	ENDIF
ELSEIF RESULT == 1
	RETURN 0
ENDIF


;=====================================================================
;魔法の箱
;=====================================================================
@MAGIC_BOX, 월령조건 , 当たり아이템, 外れ아이템, ARG:1 , ARG:2, ARG:3, ARG:4 = -1
#DIM 월령조건
#DIM 当たり아이템
#DIM 外れ아이템
#LOCALSIZE 1
PRINTL 마법의 상자가 있다 
CALL INPUT_YN,"연다","열지 않는다"
IF FLAG:월령 != 월령조건
	SWAP 当たり아이템 , 外れ아이템
ENDIF
IF RESULT == 0
	CALL CHECK_ITEMMAX, 当たり아이템
	IF RESULT == 0
		PRINTFORMW %조사처리(ITEMNAME:当たり아이템,"를")% {ARG:1}개 손에 넣었다
		CALL GET_ITEM, 当たり아이템, ARG:1
		DA:(FLAG:현X):(FLAG:현Y) = 1
		IF ARG:4 >= 0
			SETBIT 던전플래그:(ARG:2):(ARG:3), ARG:4
		ELSE
			던전플래그:(ARG:2):(ARG:3) = 1
		ENDIF
		RETURN 1
	ELSE
		PRINTFORMW %조사처리(ITEMNAME:当たり아이템,"를")% {ARG:1}개 발견했지만 가져갈 수 없었다
		RETURN 0
	ENDIF
ELSEIF RESULT == 1
	RETURN 0
ENDIF

;=====================================================================
;ＭＡＧ発見処理
;=====================================================================
@GET_TREASURE_MAG,ARG,ARG:1,ARG:2,ARG:3,ARG:4 = -1
PRINTL 상자가 놓여있다。 
CALL INPUT_YN,"연다","열지 않는다"

IF RESULT == 0
	PRINTFORMW {ARG:1}ＭＡＧ를 손에 넣었다
	CALL CONTROL_MAG,MASTER,ARG:1
	DA:(FLAG:현X):(FLAG:현Y) = 1
	IF ARG:4 >= 0
		SETBIT 던전플래그:(ARG:2):(ARG:3), ARG:4
	ELSE
		던전플래그:(ARG:2):(ARG:3) = 1
	ENDIF
	RETURN 1
ELSEIF RESULT == 1
	RETURN 0
ENDIF


;=====================================================================
;罠箱発見処理
;=====================================================================
@GET_TREASURE_TRAP,ARGS,ARG,ARG:1 = 0,ARG:2,ARG:3,ARG:4 = -1
;ARGS = 덫の종류
;ARG 데미지量or확률
;ARG:1 バッド스테이터스の相性

PRINTL 상자가 놓여있다。 
CALL INPUT_YN,"연다","열지 않는다"

IF RESULT == 0
	PRINTFORMW 함정이다！
	DA:(FLAG:현X):(FLAG:현Y) = 1
	IF ARG:4 >= 0
		SETBIT 던전플래그:(ARG:2):(ARG:3), ARG:4
	ELSE
		던전플래그:(ARG:2):(ARG:3) = 1
	ENDIF
	LOCAL:1 = 0
	SELECTCASE ARGS
		CASE "ＨＰ"
			FOR LOCAL,1,7
				IF POS(LOCAL) > -1 && GET_STATE(CFLAG:(POS(LOCAL)):상태이상) != "DYING"
					IF RAND:2 && RAND:200 < MAXBASE:(POS(LOCAL)):지혜
						CONTINUE
					ELSEIF RAND:200 < MAXBASE:(POS(LOCAL)):운
						CONTINUE
					ENDIF
					PRINTFORML [{LOCAL}] %CALLNAME:POS(LOCAL)%　>>>>>>　{MAXBASE:(POS(LOCAL)):ＨＰ*ARG/100}데미지
					CALL VAR_HP,POS(LOCAL),-MAXBASE:(POS(LOCAL)):ＨＰ*ARG/100
					LOCAL:1 += 1
				ENDIF
			NEXT
			PRINTFORMW \@LOCAL:1 > 0 ? %CALLNAME:MASTER% 일행은 데미지를 받았다 # %CALLNAME:MASTER% 일행은 데미지를 회피했다\@
		CASE "ＭＰ"
			FOR LOCAL,1,7
				IF POS(LOCAL) > -1 && GET_STATE(CFLAG:(POS(LOCAL)):상태이상) != "DYING"
					IF RAND:2 && RAND:200 < MAXBASE:(POS(LOCAL)):지혜
						CONTINUE
					ELSEIF RAND:200 < MAXBASE:(POS(LOCAL)):운
						CONTINUE
					ENDIF
					PRINTFORML [{LOCAL}] %CALLNAME:POS(LOCAL)%　>>>>>>　{MAXBASE:(POS(LOCAL)):ＭＰ*ARG/100}ＭＰ데미지
					CALL VAR_MP,POS(LOCAL),-MAXBASE:(POS(LOCAL)):ＭＰ*ARG/100
					LOCAL:1 += 1
				ENDIF
			NEXT
			PRINTFORMW %CALLNAME:MASTER% 일행은 데미지를 받았다
		CASEELSE
			SIF GETNUM(BASE,ARGS) == -1 || GET_STATE_NUM(ARGS) < 0 || GET_STATE_NUM(ARGS) > FLAG:상태이상수
				RETURN 1
			LOCAL:1 = RAND:2
			FOR LOCAL,1,7
				IF POS(LOCAL) > -1 && CFLAG:(POS(LOCAL)):상태이상 < GET_STATE_NUM(ARGS)
					PRINTFORM [{LOCAL}] %CALLNAME:POS(LOCAL)%　>>>>>>　
					IF MAXBASE:POS(LOCAL):GET_TYPE(ARG:1) <= 0 || MAXBASE:POS(LOCAL):GET_TYPE(ARG:1) == 999 || MAXBASE:(POS(LOCAL)):ARGS == -100
						PRINTFORML BLOCK
					ELSEIF LOCAL:1 && RAND:200 < MAXBASE:(POS(LOCAL)):지혜 || LOCAL:1 == 0 & RAND:200 < MAXBASE:(POS(LOCAL)):운
						PRINTFORML MISS!
					ELSEIF RAND:100 < ARG * MAXBASE:(POS(LOCAL)):GET_TYPE(ARG:1) * (100 + MAXBASE:(POS(LOCAL)):ARGS) / 10000
						CFLAG:(POS(LOCAL)):상태이상 = GET_STATE_NUM(ARGS)
						PRINTFORML %ARGS%
					ELSE
						PRINTFORML MISS
					ENDIF
				ENDIF
			NEXT
			
	ENDSELECT
	RETURN 1
ELSEIF RESULT == 1
	RETURN 0
ENDIF

;=====================================================================
;出口処理
;=====================================================================
@DUNGEON_EXIT
PRINTL 출구가 있다. 밖으로 나가겠습니까? 
CALL INPUT_YN,"Yes","No"

IF RESULT == 0
	FLAG:탈출 = 1
	RETURN 999
ELSEIF RESULT == 1
	RETURN 0
ENDIF

;=====================================================================
;昇り階段処理
;=====================================================================
@DUNGEON_UPSTAIRS,ARG,ARG:1,ARG:2
PRINTL 올라가는 계단이 있다. 올라가겠습니까? 
CALL INPUT_YN,"Yes","No"

IF RESULT == 0
	FLAG:현M = ARG
	FLAG:현X = ARG:1
	FLAG:현Y = ARG:2
	;エストマの効果リセット挟みませてもらいます
	;CALL ENCOUNTER_CHANGER
	;-- タルタロスにF.O.E.『刈り取るもの』を追加するパッチ --------
	;地形自動生成・F.O.E.制御を利用している場合はフロア移動時にクリアを行う
	IF FLAG:지형자동생성・FOE플래그 == 1
		CALL CD_CLEAR_PARAMETERS		;地形自動生成・F.O.E.制御用の各種パラメータをクリアする
		CALL CD_CREAR_TIME_AND_TURN, 2	;現在フロアの経過時間・経過ターン数カウントをクリア
	ENDIF
	;-- タルタロスにF.O.E.『刈り取るもの』を追加するパッチ --------
	;現在のフロアデータを読み込み
	CALL MAKE_FLOOR, FLAG:현던전
	CALL AUTOMAP
	RETURN 1
ELSEIF RESULT == 1
	RETURN 0
ENDIF

;=====================================================================
;昇り階段処理ID版
;=====================================================================
@DUNGEON_UPSTAIRS_ID,ARG,ARG:1
PRINTL 올라가는 계단이 있다. 올라가겠습니까? 
CALL INPUT_YN,"Yes","No"

IF RESULT == 0
	FLAG:현M = ARG
	;エストマの効果リセット挟みませてもらいます
	;CALL ENCOUNTER_CHANGER
	;-- タルタロスにF.O.E.『刈り取るもの』を追加するパッチ --------
	;地形自動生成・F.O.E.制御を利用している場合はフロア移動時にクリアを行う
	IF FLAG:지형자동생성・FOE플래그 == 1
		CALL CD_CLEAR_PARAMETERS		;地形自動生成・F.O.E.制御用の各種パラメータをクリアする
		CALL CD_CREAR_TIME_AND_TURN, 2	;現在フロアの経過時間・経過ターン数カウントをクリア
	ENDIF
	;-- タルタロスにF.O.E.『刈り取るもの』を追加するパッチ --------
	;現在のフロアデータを読み込み
	CALL MAKE_FLOOR, FLAG:현던전
	;座標移動
	FLAG:현X = SEARCH_ID(ARG:1) /100
	FLAG:현Y = SEARCH_ID(ARG:1) %100
	CALL AUTOMAP
	RETURN 1
ELSEIF RESULT == 1
	RETURN 0
ENDIF

;=====================================================================
;下り階段処理
;=====================================================================
@DUNGEON_DOWNSTAIRS,ARG,ARG:1,ARG:2
PRINTL 내려가는 계단이 있다. 내려가겠습니까? 
CALL INPUT_YN,"Yes","No"

IF RESULT == 0
	FLAG:현M = ARG
	FLAG:현X = ARG:1
	FLAG:현Y = ARG:2
	;エストマの効果リセット挟みませてもらいます
	;CALL ENCOUNTER_CHANGER
	;-- タルタロスにF.O.E.『刈り取るもの』を追加するパッチ --------
	;地形自動生成・F.O.E.制御を利用している場合はフロア移動時にクリアを行う
	IF FLAG:지형자동생성・FOE플래그 == 1
		CALL CD_CLEAR_PARAMETERS		;地形自動生成・F.O.E.制御用の各種パラメータをクリアする
		CALL CD_CREAR_TIME_AND_TURN, 2	;現在フロアの経過時間・経過ターン数カウントをクリア
	ENDIF
	;-- タルタロスにF.O.E.『刈り取るもの』を追加するパッチ --------
	;現在のフロアデータを読み込み
	CALL MAKE_FLOOR, FLAG:현던전
	CALL AUTOMAP
	RETURN 1
ELSEIF RESULT == 1
	RETURN 0
ENDIF

;=====================================================================
;下り階段処理ID版
;=====================================================================
@DUNGEON_DOWNSTAIRS_ID,ARG,ARG:1
PRINTL 내려가는 계단이 있다. 내려가겠습니까? 
CALL INPUT_YN,"Yes","No"

IF RESULT == 0
	FLAG:현M = ARG
	;エストマの効果リセット挟みませてもらいます
	;CALL ENCOUNTER_CHANGER
	;-- タルタロスにF.O.E.『刈り取るもの』を追加するパッチ --------
	;地形自動生成・F.O.E.制御を利用している場合はフロア移動時にクリアを行う
	IF FLAG:지형자동생성・FOE플래그 == 1
		CALL CD_CLEAR_PARAMETERS		;地形自動生成・F.O.E.制御用の各種パラメータをクリアする
		CALL CD_CREAR_TIME_AND_TURN, 2	;現在フロアの経過時間・経過ターン数カウントをクリア
	ENDIF
	;-- タルタロスにF.O.E.『刈り取るもの』を追加するパッチ --------
	;現在のフロアデータを読み込み
	CALL MAKE_FLOOR, FLAG:현던전
	;座標移動
	FLAG:현X = SEARCH_ID(ARG:1) /100
	FLAG:현Y = SEARCH_ID(ARG:1) %100
	CALL AUTOMAP
	RETURN 1
ELSEIF RESULT == 1
	RETURN 0
ENDIF

;=====================================================================
;特定のマップの特定の座標へ移動
;=====================================================================
@DUNGEON_WORP,ARG,ARG:1,ARG:2
;---- D3D 054 START (ADD) ------------------------------
SIF FLAG:현M == ARG
	D3D_WORP = 1
;---- D3D 054 END   (ADD) ------------------------------
FLAG:현M = ARG
FLAG:현X = ARG:1
FLAG:현Y = ARG:2
;現在の플로어데이터を読み込み
CALL MAKE_FLOOR, FLAG:현던전
CALL AUTOMAP
;ランランンジョン用のRUN중단フラグ立て
SIF GETBIT(FLAG:232,0) == 1
	SETBIT FLAG:233,0
;移動後の던전이벤트呼び出し
CALLFORM EVENT_ENTER_DUNGEON_{FLAG:현던전},0

;=====================================================================
;特定のマップの特定の座標へ移動_ID
;=====================================================================
@DUNGEON_WORP_ID,ARG,ARG:1,ARG:2 = 0
;---- D3D 054 START (ADD) ------------------------------
SIF FLAG:현M == ARG
	D3D_WORP = 1
;---- D3D 054 END   (ADD) ------------------------------
FLAG:현M = ARG
;ランランンジョン用のRUN중단フラグ立て
SIF GETBIT(FLAG:232,0) == 1
	SETBIT FLAG:233,0
;現在の플로어데이터を読み込み
CALL MAKE_FLOOR, FLAG:현던전
	;座標移動
	FLAG:현X = SEARCH_ID(ARG:1) /100
	FLAG:현Y = SEARCH_ID(ARG:1) %100
	CALL AUTOMAP
;ARG:2 == 1 でなければ移動後の던전이벤트呼び出し
SIF ARG:2 == 0
	CALLFORM EVENT_ENTER_DUNGEON_{FLAG:현던전},0
	RETURN 1

;=====================================================================
;@DUNGEON_TERMINAL
;던전内ターミナル処理
;　LOCAL:0 = 繰り返し用変数
;　LOCAL:1 = 実行可否真偽値　[3]自室に戻る 
;　LOCAL:2 = 実行可否真偽値　[4]仲間入れ替え
;　LOCAL:3 = 実行可否真偽値　[5]벨벳룸
;　LOCAL:4 = 実行可否真偽値　[6]만트라취득
;=====================================================================
@DUNGEON_TERMINAL
	CUSTOMDRAWLINE =
	PRINTL ＞터미널이 있다。
	CALLFORM GET_DUNGEON_NAME_{FLAG:현던전}
	PRINTFORMW 목소리：이곳은 %RESULTS% 터미널입니다
	PRINTFORML 용무는 무엇입니까
	PRINTL [1] 세이브
	PRINTL [2] 인스톨 소프트를 변경
	IF !FLAG:탈출스킬금지
		PRINTL [3] 방으로 돌아간다
		LOCAL:1 = 1
	ENDIF
	IF TALENT:MASTER:서머너 > 1
		PRINTL [4] 동료 교체
		LOCAL:2 = 1
	ENDIF
	FOR LOCAL, 1 , 7
		SIF POS(LOCAL) < 0
			CONTINUE
		;SIF STRFLAG_EV("벨벳룸사용가능", , [[이벤트:페르소나]]) && TALENT:LOCAL:페르소나구사자 > 2 || ITEM:계약자의열쇠 || 이벤트플래그:9:0  || 이벤트플래그:12:0
		SIF TALENT:POS(LOCAL):페르소나구사자 && ( STRFLAG_EV("벨벳룸사용가능", , [[이벤트:페르소나]]) || ITEM:계약자의열쇠 || 이벤트플래그:9:0  || 이벤트플래그:12:0 )
			LOCAL:3 = 1
		SIF TALENT:POS(LOCAL):식노 == 1
			LOCAL:4 = 1
	NEXT
	SIF LOCAL:3 == 1
		PRINTL [5] 푸른 나비
;---- EDIT 050 MOD START   -----------------------
	SIF LOCAL:4 == 1
		PRINTL [6] 만트라 취득
;---- EDIT 050 MOD END   -------------------------		


	DRAWLINE
	PRINTL [0] 아무것도 하지 않는다

	CALL INPUTINT,0,1,2,(3*LOCAL:1),(4*LOCAL:2),(5*LOCAL:3),(6*LOCAL:4)

	SELECTCASE RESULT
		CASE 0
			RETURN 1
		CASE 1
			CALL TITLE_SAVEGAME
		CASE 2
			CALL SETUP_SOFT
		CASE 3 
			PRINTW 목소리：전송을 개시합니다
			PRINTFORMW %CALLNAME:MASTER% 일행은 방으로 귀환했다
			FLAG:탈출 = 1
			RETURN 1
		CASE 4 
			CALL RECONSTRUCTION
		CASE 5
			CALL VELVET_ROOM
;---- EDIT 050 MOD START   -----------------------
		CASE 6
			CALL KARMA_TERMINAL
;---- EDIT 050 MOD END   -------------------------	
	ENDSELECT
	RESTART

;=====================================================================
;エレベーター
;=====================================================================
@DUNGEON_ELEVATOR, ARG = -29
CUSTOMDRAWLINE =
PRINTL ＞엘리베이터가 있다.
VARSET RESULT, -1
VARSET RESULTS
LOCAL:1 = FLAG:현M
CALLFORM DUNGEON_ELEVATOR_{FLAG:현던전}, ARG
LOCAL:2 = RESULT
FOR LOCAL, 0, 25
	IF RESULT:LOCAL >= 0 && RESULT:LOCAL != LOCAL:1
		PRINTFORM [{LOCAL}] 
		IF !STRLENS(RESULTS:LOCAL)
			FLAG:현M = RESULT:LOCAL
			CALLFORM FLOORNAME_{FLAG:현던전}
			RESULT = LOCAL:2
		ELSE
			PRINTFORML %RESULTS:LOCAL%
		ENDIF
	ENDIF
NEXT
FLAG:현M = LOCAL:1
ARRAYSHIFT RESULT, 1, 0
PRINTL [100] 타지 않는다
$INPUT_LOOP
INPUT
IF RESULT == 100
	RETURN 1
ELSEIF RESULT < 0 || RESULT >= VARSIZE("RESULT")
	GOTO INPUT_LOOP
ELSEIF RESULT:(RESULT+1) >= 0 && RESULT:LOCAL != LOCAL:1
	CALL DUNGEON_WORP_ID, RESULT:(RESULT+1), ARG, 1
ELSE
	GOTO INPUT_LOOP
ENDIF

;=====================================================================
;트리슈の泉
;メインはアガスティアの木サービスのほう
;세이브ポイント欲しいって意見があったけど、デザイン上、기본的にはD内세이브もできないほうがいいよなぁとおもうので
;折衷案として有料세이브ポイントをつくることに
;가격はARGが初回で、세이브した횟수だけARG:1が加算されていく
;1回目だけは安くつかえるけど、次からすげーぼったくられるとかそういうのをできるように
;
;新版
;가격は主人の레벨と同じ레벨のフラット스테이터스の악마を基準とし
;その악마の최대ＨＰ分회복で,매각기본額の1/12,최대ＭＰ分회복で、1/2,스테이터스はそれに＋α
;세이브は기본金額の1/2
;これに조교보정をかけていく
;ただし、両方共、一回の던전アタック内で複数回利用する場合、가격が上昇していく
;
;회복の泉サービスはどーかなーとおもったけど、ぼったくっとけばいいかなぁと
;記憶の泉の요정にしてもよかったんだけど、うーん
;가격はHP5、MP1につき1마카、상태이상は死亡が20、毒なんかが5
;それに레벨보정が主人の레벨/4+1だけかかる
;また、상태이상はさらに대상自身の레벨/8+1の보정がかかる
;主人の레벨5で、MP100회복なら、200마카
;主人の레벨20で、MP300회복なら、1800마카
;主人の레벨40で、MP600회복なら、6600마카
;던전内収入減ってるし、これ使って黒字でメリットってのは考えにくいというか、普通利用したくない金額にはなってるとは思う
;ただ、長い던전突貫とか、ボス戦強行突破する際においてあると金で色々解決できる的なそういう손段にしたい感じ
;
;性的なサービスは트리슈を金で買う
;不在フラグたてて、던전内で트리슈조교
;함락度に応じて、値引きが発生する…みたいなのを考えてるけど
;트리슈に払う礼金と、割引率で悩む。あと、奴隷として획득できちゃうかどうか
;てか、트리슈の衣装ってそういうお店って感じだよねあれ
;=====================================================================
@FOUNTAIN_OF_TRISH
#DIM 기본가격, 1
#DIM 가격보정, 1
#DIM 트리슈, 1
#LOCALSIZE 10
;기본가격は악마の基礎매각額と同じ
기본가격 = BASE:MASTER:LV * (5 + BASE:MASTER:LV / 2) * 5 / 4
;이용횟수に応じて増加
FOR LOCAL, 1, FLAG:트리슈의샘이용횟수
	기본가격 = 기본가격 * 150 / 100
NEXT
CUSTOMDRAWLINE = 
IF FLAG:트리슈조교 == -1
	PRINTW ＞회복의 샘이다
	PRINTW ＞샘에는 아무도 없고, 간판만 있다
	PRINTW ＞「일신상의 일로, 휴업 중」
	PRINTW ＞「후임이 올 때까지 wait!」
	RETURN 0
ELSEIF FLAG:트리슈조교 == -2
	PRINTW ＞회복의 샘이다
	PRINTL 
	PRINTL 회복엘프:
	PRINTW 「여기는, 회복의 샘입니다~」
ELSEIF FLAG:트리슈의샘이용횟수
	PRINTW ＞회복의 샘이다
	PRINTL 
	PRINTL 트리슈:
	PRINTW 「문 밖은 Dangerous!  주의는 일초 상처는 일생!」
	PRINTW 「그러니까 내가 여기 있어」
	PRINTW 「째째하게 굴지 말고, 자꾸자꾸 Recover and Save！」
ELSE
	PRINTW ＞샘이 있고, 그곳에 요정 같은 것이 있다…
	PRINTL 
	PRINTL 요정:
	PRINTW 「저쪽 세상은 Give and take!」
	PRINTW 「랄까 Oh!　혹시 처음?」
	PRINTW 「그럼, 자기소개. 나는 트리슈」
	PRINTW 「이 회복의 샘을 지키는 요정」
	PRINTW 「너희들의 상처받은 몸을 치료해 줘」
	PRINTW 「아, 이 아가스티아의 나무에서 부업도 시작했어」
	PRINTW 「너희들의 소중한 Memory의 Save도 해준다고」
	PRINTW 「물론 공짜는 아니야. 저쪽 세상은 Give and take!」
	PRINTW 「돈만 있으면 몇번이던 Recover and Save!」
	FLAG:트리슈의샘이용횟수 = 1
ENDIF
IF FLAG:트리슈조교 == -2
	PRINTL 「뭘 하겠습니까~」
ELSE
	PRINTL 「그래서, 용무는 뭐야~?」
ENDIF
$START
PRINTL [0] 회복한다
PRINTL [1] 세이브한다
PRINTL [2] 성적인 서비스
트리슈 = GETCHARA([[キャラ:트리슈(샘)]])
SIF 트리슈 > -1 && 함락(트리슈) >= 2
	PRINTL [3] 트리슈를 테이크 아웃한다
PRINTL [9] 별거 없다
IF FLAG:트리슈조교 != -2
	;---- EDIT 003 ADD START -------------------------
	;가격を大幅改訂
	;트리슈の상태による보정
	가격보정 = 10000
	IF 트리슈 >= 0
		가격보정 -= 함락(트리슈) * 1000
		가격보정 -= MARK:트리슈:굴복각인 * 500
		가격보정 -= MARK:트리슈:고통각인 * 250
		가격보정 -= MARK:트리슈:쾌락각인 * 250
		가격보정 -= MIN(2000, TALENT:MASTER:수수께끼의매력 * 500 + ABL:트리슈:순종 * 30, ABL:트리슈:욕망 * 30, ABL:트리슈:봉사정신 * 50, ABL:트리슈:노출증 * 30, ABL:트리슈:마조끼 * 50, ABL:트리슈:정액중독 * 50, ABL:트리슈:섹스중독 * 50)
		LOCAL:4 = (EXP:트리슈:절정경험 + EXP:트리슈:고통쾌락경험 * 5 + EXP:트리슈:가학쾌락경험 * 5 + EXP:트리슈:애정경험 * 10 + EXP:트리슈:봉사쾌락경험 * 5 + EXP:트리슈:정액경험 * 3) / 500
		WHILE LOCAL:4 > 0
			TIMES 가격보정,0.99
			LOCAL:4--
		WEND
		가격보정 = MAX(2500, 가격보정) * MAX(MARK:트리슈:반발각인 * 3, 1)
	ELSE
		CALL ADD_NEW_COMPANION, [[キャラ:트리슈(샘)]], 200
		트리슈 = GETCHARA([[キャラ:트리슈(샘)]])
		SIF BASE:트리슈:LV < 15
			BASE:트리슈:LV = 15
		CFLAG:트리슈:이자리에없는플래그 = 1
	ENDIF
	;---- EDIT 003 ADD END   -------------------------
ELSE
	가격보정 = 5000
ENDIF
CALL INPUTINT(0, 1, 2, (트리슈 > -1 && 함락(트리슈) >= 2) * 3, 9)
IF RESULT == 0
	;ＨＰ/ＭＰの가격決定 
	;ＭＰの가격決定 
	VARSET LOCAL
	FOR LOCAL, 0, CHARANUM
		;HPの합계量を記録
		LOCAL:1 += MAXBASE:LOCAL:ＨＰ - BASE:LOCAL:ＨＰ
		;MPの합계量を記録
		LOCAL:2 += MAXBASE:LOCAL:ＭＰ - BASE:LOCAL:ＭＰ
		SIF GET_STATE(CFLAG:LOCAL:상태이상) == "DYING"
			LOCAL:3 += 50 * BASE:LOCAL:LV / 8 + 1
		SIF GET_STATE(CFLAG:LOCAL:상태이상) == "STONE"
			LOCAL:3 += 25 * BASE:LOCAL:LV / 8 + 1
		SIF GET_STATE(CFLAG:LOCAL:상태이상) == "FLY"
			LOCAL:3 += 15 * BASE:LOCAL:LV / 8 + 1
		SIF GET_STATE(CFLAG:LOCAL:상태이상) == "CURSE"
			LOCAL:3 += 15 * BASE:LOCAL:LV / 8 + 1
		SIF GET_STATE(CFLAG:LOCAL:상태이상) == "CHARM"
			LOCAL:3 += 10 * BASE:LOCAL:LV / 8 + 1
		SIF GET_STATE(CFLAG:LOCAL:상태이상) == "POISON"
			LOCAL:3 += 10 * BASE:LOCAL:LV / 8 + 1
		SIF GET_STATE(CFLAG:LOCAL:상태이상) == "PALYZE"
			LOCAL:3 += 10 * BASE:LOCAL:LV / 8 + 1
		SIF GET_STATE(CFLAG:LOCAL:상태이상) == "SLEEP"
			LOCAL:3 += 5 * BASE:LOCAL:LV / 8 + 1
		SIF GET_STATE(CFLAG:LOCAL:상태이상) == "PANIC"
			LOCAL:3 += 5 * BASE:LOCAL:LV / 8 + 1
		SIF GET_STATE(CFLAG:LOCAL:상태이상) == "HAPPY"
			LOCAL:3 += 5 * BASE:LOCAL:LV / 8 + 1
	NEXT
	LOCAL:4 = 0
	;フラットの場合のステ
	LOCAL:5 = (18 + BASE:MASTER:LV * 3 / 2) / 6
	;HPはフラットステ악마全쾌で基準値の1/12
	LOCAL:4 += LOCAL:1 * 100 / ((BASE:MASTER:LV + LOCAL:5*9 + 5) * (100+BASE:MASTER:LV*3) / 100) / 12
	;MPはフラットステ악마全쾌で基準値の1/2
	LOCAL:4 += LOCAL:2 * 100 / (((BASE:MASTER:LV+LOCAL:5/2+LOCAL:5*3/2)*2 + 5) * (100+BASE:MASTER:LV) /100) / 2
	;상태이상は100%で基準値の1倍
	LOCAL:4 += LOCAL:3
	LOCAL:5 = 기본가격 * LOCAL:4 * 가격보정 / 10000 / 100
	IF LOCAL:1 + LOCAL:2 + LOCAL:3 == 0
		IF FLAG:트리슈조교 == -2
			PRINTL 회복엘프
			PRINTW 「모두 건강해요~」
		ELSE
			PRINTL 트리슈:
			PRINTW 「좋아~, 그럼 아픈거 아픈거～♪」
			PRINTW 「…가 아니라, 모두 건강하잖아!」
			PRINTW 「이러면, 회복 못 한다고~!!」
		ENDIF
	ELSE
		IF FLAG:트리슈조교 == -2
			PRINTL 회복엘프:
			PRINTW 「이번 회복 비용입니다…에…」
			PRINTFORML 「{LOCAL:5}마카가 필요합니다만, 괜찮나요~？」
		ELSE
			PRINTL 트리슈:
			PRINTW 「OK！　그럼, 이번 회복 비용은…음음…」
			PRINTFORML 「{LOCAL:5}마카가 필요한데 회복할래？」
		ENDIF
		CALL INPUT_YN
		IF RESULT == 0
			IF MONEY:1 >= LOCAL:5
				IF FLAG:트리슈조교 == -2
					PRINTL 회복엘프:
					PRINTW 「네~, 그럼 편하게 있으세요」
				ELSE
					PRINTL 트리슈:
					PRINTW 「그럼, 간다～♪」
					PRINTW 「아픈거 아픈거 날아가라～！」
					PRINTW 「삐로로로～♪」
				ENDIF
				PRINTL 
				PRINTFORMW %CALLNAME:MASTER% 일행은 회복되었다
				MONEY:1 -= LOCAL:5
				FOR LOCAL, 0, CHARANUM
					CALL HEALTH_CHARA, LOCAL
				NEXT
				FLAG:트리슈의샘이용횟수 += 1
			ELSE
				IF FLAG:트리슈조교 == -2
					PRINTL 회복엘프:
					PRINTW 「어라. 돈이 부족한거 같네요~」
				ELSE
					PRINTL 트리슈:
					PRINTW 「좋아~, 그럼 아픈거 아픈거～♪」
					PRINTW 「…가 아니라, 돈이 부족하잖아！」
					PRINTW 「돈이나 벌고 와！！」
				ENDIF
			ENDIF
		ELSE
			IF FLAG:트리슈조교 == -2
				PRINTL 회복엘프:
				PRINTW 「그렇습니까~」
				PRINTW 「치료받고 싶으면 언제든지 와주세요~」	
			ELSE
				PRINTL 트리슈:
				PRINTW 「쳇, 괜히 참기나 하고. 죽어도 난 몰라」
				PRINTW 「랄까, 죽어버려라~ 구두쇠！」
			ENDIF
		ENDIF
	ENDIF
ELSEIF RESULT == 1
	;---- EDIT 003 ADD START -------------------------
	;式변경
	LOCAL:1 = MAX(기본가격 * 가격보정 / 10000 / 2, 100)
	IF FLAG:트리슈조교 == -2
		PRINTL 회복엘프:
		PRINTW 「이번 세이브 비용입니다…에…」
		PRINTFORML 「{LOCAL:1}마카 필요합니다만, 세이브합니까？」
	ELSE
		PRINTL 트리슈:
		PRINTW 「OK！　그럼, 이번 세이브 비용은…음음…」
		PRINTFORML 「{LOCAL:1}마카가 필요한데 세이브 할래？」
	ENDIF
	;---- EDIT 003 ADD END   -------------------------
	CALL INPUT_YN
	IF RESULT == 0
		IF MONEY:1 >= LOCAL:1
			IF FLAG:트리슈조교 == -2
				PRINTL 회복엘프:
				PRINTW 「그럼, 이 나무에 말을 걸어주세요~」
				PRINTW 「괜찮습니다. 아무도 보지 않으니까 부끄러거나 하지 않으니까요」
			ELSE
				PRINTL 트리슈:
				PRINTW 「OK、그럼, 이 아가스티아의 나무에 말을 거는거야」
				PRINTW 「그리고 Memory를 Save！」
			ENDIF
			MONEY:1 -= LOCAL:1
			FLAG:트리슈의샘이용횟수 += 1
			CALL TITLE_SAVEGAME
		ELSE
			IF FLAG:트리슈조교 == -2
				PRINTL 회복엘프:
				PRINTW 「어라. 돈이 부족한거 같네요~」
			ELSE
				PRINTL 트리슈:
				PRINTW 「좋~아, 그럼 이 아가스티아의 나무에～」
				PRINTW 「…가 아니라, 돈이 부족하잖아！」
				PRINTW 「돈이나 벌고 와！！」
			ENDIF
		ENDIF
	ELSE
		IF FLAG:트리슈조교 == -2
			PRINTL 회복엘프:
			PRINTW 「그렇습니까~」
			PRINTW 「세이브하고 싶으면 언제든지 와주세요~」	
		ELSE
			PRINTL 트리슈:
			PRINTW 「쳇, 괜히 참기나 하고. 죽어도 난 몰라」
			PRINTW 「랄까, 죽어버려라~ 구두쇠！」
		ENDIF
	ENDIF
ELSEIF RESULT == 2
	IF FLAG:트리슈조교 == -2
		PRINTL 회복엘프:
		PRINTW 「에, 여기는 그런 건 하지 않아요~」
		PRINTW 「랄까, 이거 성희롱 아닙니까~？」
		PRINTW 「고소할겁니다~？」	
		GOTO START
	ENDIF
	IF FLAG:트리슈조교
		PRINTL 트리슈:
		PRINTW 「Powerful하네」
		PRINTW 「하지만, 나는 Tired!」
		PRINTW 「나중에, 다시 서비스 해줄게」
		PRINTL 「그래서, 다른 용무는 없어？」
		GOTO START
	ENDIF
	PRINTL 트리슈:
	PRINTW 「나랑 좋은 거 하고 싶어？」
	IF FLAG:트리슈조교 == -3
		PRINTW 「그럼 비용은 LOVE로 충분해！」
		BASE:트리슈:ＭＡＧ = MAXBASE:MASTER:ＭＡＧ / 50
	ELSE
		PRINTW 「이 세상의 모든 것은, Give and take！」
		PRINTW 「네가 나에게서 뭔가를 얻고 싶다면, 어떻게 하면 좋은지 알고 있겠지？」
		$HOW_MUCH
		PRINTW 「그럼、How much?」
		CALL INPUT_MANY(0, MONEY:1)
		LOCAL:1 = RESULT
		;---- EDIT 003 ADD START -------------------------
		;충성도を記録する形に변경と式변경
		SELECTCASE LOCAL:1 * 10000 / 가격보정
			CASE IS < 100
				PRINTL 트리슈:
				PRINTW 「Really！？　겨우 그거！？」
				PRINTW 「인색해！　그걸로 나를 상대할수 있을거라 생각했어?！？」
				PRINTW 「한번 죽고、다시 한번해！」
				GOTO START
			CASE IS < 500
				PRINTW 「으~응、뭐 그럭저럭 합격인가」
				PRINTW 「그래도、더 가득 내는 편이 Happy해진다고」
				PRINTL 「어차피、돈은 돌고 도는 것、인색하게 굴지말고 좋게 생각하자！」
				CALL INPUT_YN("상관하지 않고 지불한다", "금액을 바꾼다")
				IF RESULT == 0
					PRINTL 트리슈:
					PRINTW 「체엣、알았어」
					PRINTW 「그럼、조금만 take해줄게」
					PRINTW 「마음껏 즐기라고」
				ELSE
					PRINTL 트리슈:
					GOTO HOW_MUCH
				ENDIF
				BASE:트리슈:ＭＡＧ = MAXBASE:MASTER:ＭＡＧ / 200
				TALENT:트리슈:반항적 = 1
				TALENT:트리슈:솔직함 = 0
				TALENT:트리슈:건방짐 = 1 
				TALENT:트리슈:프라이드낮음 = 0
				TALENT:트리슈:일선을넘지않음 = 1
				TALENT:트리슈:무관심 = 1
				TALENT:트리슈:호기심 = 0
				TALENT:트리슈:남성혐오 = 1
				TALENT:트리슈:여성혐오 = 1
				TALENT:트리슈:억압 = 1
				TALENT:트리슈:해방 = 0
				TALENT:트리슈:약점 = 0
				TALENT:트리슈:망신 = 0
				TALENT:트리슈:헌신적 = 0
				TALENT:트리슈:불결무시 = 0
				TALENT:트리슈:쾌감에솔직 = 0
			CASE  IS < 1000
				PRINTL 트리슈:
				PRINTW 「그럼、한마디 더」
				PRINTW 「그렇게하면、나도 잔뜩 받아서 Happy!」
				PRINTW 「그리고、내가 노력하니까、너도 Happy！」
				PRINTW 「즉、두사람 모두 Happy！」
				PRINTW 「앞으로 조금 더하는 걸로、이렇게 좋은 일은 없다고 생각해」
				CALL INPUT_YN("상관하지 않고 지불한다", "금액을 바꾼다")
				IF RESULT == 0
					PRINTL 트리슈:
					PRINTW 「우웅、알았어」
					PRINTL 「제대로 Give 받을 테니까
					PRINTW 　책임지고、내가 Happy 하게 해줄게」
				ELSE
					PRINTL 트리슈:
					GOTO HOW_MUCH
				ENDIF
				BASE:트리슈:ＭＡＧ = MAXBASE:MASTER:ＭＡＧ / 100
				BASE:트리슈:충성도 = MIN(500, BASE:트리슈:충성도)
				TALENT:트리슈:반항적 = 0
				TALENT:트리슈:솔직함 = 0
				TALENT:트리슈:건방짐 = 1 
				TALENT:트리슈:프라이드낮음 = 0
				TALENT:트리슈:일선을넘지않음 = 0
				TALENT:트리슈:무관심 = 1
				TALENT:트리슈:호기심 = 0
				TALENT:트리슈:남성혐오 = 0
				TALENT:트리슈:여성혐오 = 0
				TALENT:트리슈:억압 = 0
				TALENT:트리슈:해방 = 0
				TALENT:트리슈:약점 = 0
				TALENT:트리슈:망신 = 0
				TALENT:트리슈:헌신적 = 0
				TALENT:트리슈:불결무시 = 0
				TALENT:트리슈:쾌감에솔직 = 0
			CASE  IS < 3000
				PRINTL 트리슈:
				PRINTW 「이렇게나 많이 준다니 Excellent！」
				PRINTW 「나도 너를 위해서 힘내야지」
				PRINTW 「자자, 빨리 지불을 하자고！」
				CALL INPUT_YN("지불한다", "역시 그만둔다")
				IF RESULT == 0
					PRINTL 트리슈:
					PRINTW 「그럼, 내가 너를 Paradice에 데려가 줄게！」
				ELSE
					PRINTL 트리슈:
					PRINTW 「Oh…、값을 깎는 것 같은건 그만두자고」
					PRINTW 「얼마를 내도 후회하지 않게 해줄테니까」」
					GOTO HOW_MUCH
				ENDIF
				TALENT:트리슈:반항적 = 0
				TALENT:트리슈:솔직함 = 1
				TALENT:트리슈:건방짐 = 0 
				TALENT:트리슈:프라이드낮음 = 0
				TALENT:트리슈:일선을넘지않음 = 0
				TALENT:트리슈:무관심 = 0
				TALENT:트리슈:호기심 = 0
				TALENT:트리슈:남성혐오 = 0
				TALENT:트리슈:여성혐오 = 0
				TALENT:트리슈:억압 = 0
				TALENT:트리슈:해방 = 0
				TALENT:트리슈:약점 = 0
				TALENT:트리슈:망신 = 0
				TALENT:트리슈:헌신적 = 1
				TALENT:트리슈:불결무시 = 0
				TALENT:트리슈:쾌감에솔직 = 0
			CASE  IS < 10000
				PRINTL 트리슈:
				PRINTW 「Oh…사랑해…」
				PRINTW 「그러니까아 빨리 나를 엉망진창으로 만들어 줘？」
				PRINTL 
				PRINTFORMW ＞트리슈는 눈동자를 적시면서 %조사처리(CALLNAME:MASTER,"를")% 바라보고 있다
				CALL INPUT_YN("엉망진창으로 만든다", "다시 생각한다")
				IF RESULT == 0
					PRINTL 트리슈:
					PRINTW 「아아…, 이대로 둘이서 Paradice에 가자…」
				ELSE
					PRINTL 트리슈:
					PRINTW 「에…, 나를 가지고 논거야？」
					PRINTW 「농담이지？　네가 그런 식으로 나를 배신하지 않는다고 믿고 있어」
					GOTO HOW_MUCH
				ENDIF
				BASE:트리슈:ＭＡＧ = MAXBASE:MASTER:ＭＡＧ / 50
				BASE:트리슈:충성도 = MIN(2000, BASE:트리슈:충성도)
				TALENT:트리슈:반항적 = 0
				TALENT:트리슈:솔직함 = 1
				TALENT:트리슈:건방짐 = 0 
				TALENT:트리슈:프라이드낮음 = 1
				TALENT:트리슈:일선을넘지않음 = 0
				TALENT:트리슈:무관심 = 0
				TALENT:트리슈:호기심 = 0
				TALENT:트리슈:남성혐오 = 0
				TALENT:트리슈:여성혐오 = 0
				TALENT:트리슈:억압 = 0
				TALENT:트리슈:해방 = 1
				TALENT:트리슈:약점 = 0
				TALENT:트리슈:망신 = 0
				TALENT:트리슈:헌신적 = 1
				TALENT:트리슈:불결무시 = 1
				TALENT:트리슈:쾌감에솔직 = 1
			CASEELSE
				PRINTL 트리슈:
				PRINTW 「……！」
				PRINTW 「아아, 더 이상 참을 수 없어!」
				PRINTW 「너의 Love에 지지 않을 정도로, 나의 Love보여 줄게！」
				PRINTL 
				PRINTW ＞트리슈에게 쓰러뜨려졌다！
				PRINTL 
				BASE:트리슈:ＭＡＧ = MAXBASE:MASTER:ＭＡＧ / 25
				BASE:트리슈:충성도 = MIN(5000, BASE:트리슈:충성도)
				CFLAG:트리슈:상성치1 = 200
				TALENT:트리슈:반항적 = 0
				TALENT:트리슈:솔직함 = 1
				TALENT:트리슈:건방짐 = 0 
				TALENT:트리슈:프라이드낮음 = 1
				TALENT:트리슈:일선을넘지않음 = 0
				TALENT:트리슈:무관심 = 0
				TALENT:트리슈:호기심 = 1
				TALENT:트리슈:남성혐오 = 0
				TALENT:트리슈:여성혐오 = 0
				TALENT:트리슈:억압 = 0
				TALENT:트리슈:해방 = 1
				TALENT:트리슈:약점 = 1
				TALENT:트리슈:망신 = 1
				TALENT:트리슈:헌신적 = 1
				TALENT:트리슈:불결무시 = 1
				TALENT:트리슈:쾌감에솔직 = 1
		ENDSELECT
		;---- EDIT 003 ADD END   -------------------------
		MONEY:1 -= LOCAL:1
	ENDIF
	;조수は使えない
	ASSI = -1
	TARGET = 트리슈
	BASE:트리슈:체력 = MAXBASE:트리슈:체력
	BASE:트리슈:기력 = MAXBASE:트리슈:기력
	CFLAG:트리슈:스트레스치 = 0
	CFLAG:트리슈:자궁내피임결계 = 1
	CFLAG:트리슈:이자리에없는플래그 = 1
	FLAG:트리슈조교 = 1
	FLAG:던전내조교 = 1
	RETURN 1
;---- EDIT 003 ADD START -------------------------
;take outの位置を변경
ELSEIF RESULT == 3 && 트리슈 > -1 && 함락(트리슈) >= 2
	PRINTL 트리슈:
	PRINTW 「에, 나를 take out하고 싶어?？」
	PRINTW 「나는 이 샘의 요정이라서, 요정계에 돌아갈건데」
	PRINTW 「……진심이야？」
	PRINTW 「그렇다면……나도 정직히 말해서 더 이상 요정계 같은 건 아무래도 좋으니까」
	PRINTW 「그런 것 보다, 무엇보다도, 너의 옆에서, 너와 enjoy하는 쪽이 소중해！」
	PRINTW 「그러니까, 공손히 나를 너에게 give!」
	PRINTW 「앞으로도 잘 부탁해！」
	TALENT:트리슈:반항적 = 1
	TALENT:트리슈:솔직함 = 0
	TALENT:트리슈:건방짐 = 1 
	TALENT:트리슈:프라이드낮음 = 0
	TALENT:트리슈:일선을넘지않음 = 0
	TALENT:트리슈:무관심 = 0
	TALENT:트리슈:호기심 = 0
	TALENT:트리슈:남성혐오 = 0
	TALENT:트리슈:여성혐오 = 0
	TALENT:트리슈:억압 = 0
	TALENT:트리슈:해방 = 0
	TALENT:트리슈:약점 = 0
	TALENT:트리슈:망신 = 0
	TALENT:트리슈:헌신적 = 0
	TALENT:트리슈:불결무시 = 0
	TALENT:트리슈:쾌감에솔직 = 0
	PRINTL 
	PRINTW ＞트리슈를 손에 넣었다
	IF GETCHARA(4568) == -1
		NO:(트리슈) = 4568
		CFLAG:트리슈:이자리에없는플래그 = 0
	ELSE
		CALL 캐릭터삭제((트리슈))
	ENDIF
	FLAG:트리슈조교 = -1
	RETURN 0
;---- EDIT 003 ADD END   -------------------------
ELSEIF RESULT == 9
	IF FLAG:트리슈조교 == -2
		PRINTL 회복엘프:
		PRINTW 「다시 와주세요~」	
	ELSE
		PRINTL 트리슈:
		PRINTW 「그럼, 또 봐！」
		PRINTW 「기다릴테니까。Bye-bye！」
	ENDIF
	RETURN 1
ENDIF
PRINTL 
IF FLAG:트리슈조교 == -2
	PRINTL 회복엘프:
	PRINTL 「뭘 합니까아？」
ELSE
	PRINTL 트리슈:
	PRINTL 「그러면, 다른 용무가 있는 걸까？」
ENDIF
GOTO START
;=====================================================================
;SHOP
;書式はARGが1の時は마카払い、0の時は\払いで
;以降は아이템名・가격の順番で書いていく
;CALL DUNGEON_SHOP(1, "마석", 500)
;これなら、마석を500마카で売ってる店になります
;가격が0の時はITEM.CSVの値段にします
;=====================================================================
@DUNGEON_SHOP(ARG, ARGS:1 = "", ARG:1 = 0, ARGS:2 = "", ARG:2 = 0, ARGS:3 = "", ARG:3 = 0, ARGS:4 = "", ARG:4 = 0, ARGS:5 = "", ARG:5 = 0, ARGS:6 = "", ARG:6 = 0, ARGS:7 = "", ARG:7 = 0, ARGS:8 = "", ARG:8 = 0, ARGS:9 = "", ARG:9 = 0, ARGS:10 = "", ARG:10 = 0, ARGS:11 = "", ARG:11 = 0, ARGS:12 = "", ARG:12 = 0, ARGS:13 = "", ARG:13 = 0, ARGS:14 = "", ARG:14 = 0, ARGS:15 = "", ARG:15 = 0, ARGS:16 = "", ARG:16 = 0, ARGS:17 = "", ARG:17 = 0, ARGS:18 = "", ARG:18 = 0, ARGS:19 = "", ARG:19 = 0)
#DIM PRICE, 20
#DIMS BUYITEM, 1
#DIMS BUYITEMNAME, 1
#LOCALSIZE 2
#LOCALSSIZE 5
IF ARG == 3
	LOCALS = 코인
ELSEIF ARG == 1
	LOCALS = 마카
ELSE
	LOCALS = ￥
ENDIF
DRAWLINE
PRINTFORML 무엇을 구입합니까？		소지%LOCALS% {MONEY:ARG}
DRAWLINE
;---- EDIT 052 ADD START 存在しない아이템名はリストに出ないように-------------------------
LOCAL = 0
LOCAL:1 = 0
WHILE 1
	PRICE:(LOCAL+1) = ARG:(LOCAL+1) ? ARG:(LOCAL+1) # ITEMPRICE:(GETNUM(ITEM, ARGS:(LOCAL+1)))
	LOCALS:1 = {PRICE:(LOCAL+1),5}%LOCALS%
	IF GETNUM(ITEM, ARGS:(LOCAL+1)) >= 10000 && GETNUM(ITEM, ARGS:(LOCAL+1)) <= 15000
		CALLFORM SKILL_NAME_{GETNUM(ITEM, ARGS:(LOCAL+1)) - 10000}
		BUYITEMNAME = 【%RESULTS%】
	ELSE
		BUYITEMNAME = %ARGS:(LOCAL+1)%
	ENDIF
	IF GETNUM(ITEM, ARGS:(LOCAL+1)) >= 0
		PRINTFORM [{LOCAL,2}] %BUYITEMNAME, 24, LEFT% %@"{PRICE:(LOCAL+1),5}%LOCALS%", 9%　　
		LOCAL:1++
	ELSE
		PRICE:(LOCAL+1) = 0
	ENDIF
	LOCAL += 1
	SIF !(LOCAL:1 & 1)
		PRINTL 
	SIF STRLENS(ARGS:(LOCAL+1)) == 0
		BREAK
WEND
SIF LOCAL:1 & 1
	PRINTL 
;---- EDIT 052 ADD END   -------------------------
$INPUT_LOOP
DRAWLINE
PRINTFORML [100] 돌아간다
INPUT
IF RESULT == 100
	RETURN -1
ELSEIF RESULT < 0 || RESULT > 19 || PRICE:(RESULT+1) == 0
	GOTO INPUT_LOOP
ELSE
	CALL DUNGEON_BUY, GETNUM(ITEM, ARGS:(RESULT+1)), PRICE:(RESULT + 1), ARG
	RESTART
ENDIF


;ARGは아이템番号、ARG:1は가격、ARG:2は1で마카払い
@DUNGEON_BUY, ARG, ARG:1, ARG:2
IF ARG >= 2000 && ARG < 5500
	CALL 장비설명, ARG
	LOCAL = 999
ELSEIF ARG >= 5500 && ARG < 6000
	CALLFORM 장비해설_{ARG}
	LOCAL = 999
ELSE
	RESULT = 999
	TRYCALLFORM 최대소지수_{ARG+2000}
	LOCAL = RESULT
	PRINTFORML %ITEMNAME:ARG,20,LEFT%   소지수：{ITEM:ARG}/{LOCAL}
	SIF FLAG:스킬속성표시설정 == 1
		CALL SKILL_EXPLAIN_PERFORMANCE, ARG + 2000, -1
	TRYCALLFORM SKILL_EXPLAIN_{ARG+2000}
	DRAWLINE
ENDIF
IF ITEM:ARG >= LOCAL
	PRINTW 더 이상 가질 수 없습니다
ELSE
	IF MONEY:(ARG:2) < ARG:1
		PRINTW 돈이 부족합니다
	ELSE
		PRINTFORML 얼마나 구입하겠습니까？ (현재 {ITEM:ARG}개 소지)
		CALL INPUT_MANY(0, MIN(MONEY:(ARG:2)/ARG:1, LOCAL - ITEM:ARG))
		IF RESULT
			MONEY:(ARG:2) -= (RESULT * ARG:1)
			IF RESULT == 1
				PRINTFORMW ＜%조사처리(ITEMNAME:ARG,"를")% 구입했습니다＞
			ELSE
				PRINTFORMW ＜%조사처리(ITEMNAME:ARG,"를")% {RESULT}개 구입했습니다＞
			ENDIF
			CALL GET_ITEM, ARG, RESULT
		ENDIF
	ENDIF
ENDIF
RETURN 0
;文字列版
@DUNGEON_SHOPS(ARG, ARGS)
#DIM PRICE, 20
#DIMS BUYITEM, 1
#DIMS BUYITEMNAME, 1
#DIMS ITEMLIST , 20
#DIMS PRELIST , 40
#LOCALSIZE 2
#LOCALSSIZE 5
VARSET PRICE , 0
VARSET ITEMLIST , ""
SPLIT ARGS , "," , PRELIST
FOR LOCAL , 0 , 20
	SIF PRELIST:(LOCAL*2) == ""
		BREAK
	ITEMLIST:LOCAL = %PRELIST:(LOCAL*2)%
	PRICE:LOCAL = TOINT(PRELIST:(LOCAL*2+1)) != 0 ? TOINT(PRELIST:(LOCAL*2+1)) # ITEMPRICE:(ITEMLIST:LOCAL)
NEXT
IF ARG == 3
	LOCALS = 코인
ELSEIF ARG == 1
	LOCALS = 마카
ELSE
	LOCALS = ￥
ENDIF
DRAWLINE
PRINTFORML 무엇을 구입합니까？		소지%LOCALS% {MONEY:ARG}
DRAWLINE
;---- EDIT 052 ADD START 存在しない아이템名はリストに出ないように-------------------------
LOCAL = 0
LOCAL:1 = 0
WHILE 1
	LOCALS:1 = {PRICE:LOCAL,5}%LOCALS%
	IF GETNUM(ITEM, ITEMLIST:LOCAL) >= 10000 && GETNUM(ITEM, ITEMLIST:LOCAL) <= 15000
		CALLFORM SKILL_NAME_{GETNUM(ITEM,  ITEMLIST:LOCAL) - 10000}
		BUYITEMNAME = 【%RESULTS%】
	ELSE
		BUYITEMNAME = %ITEMLIST:LOCAL%
	ENDIF
	IF GETNUM(ITEM, ITEMLIST:LOCAL) >= 0
		PRINTFORM [{LOCAL,2}] %BUYITEMNAME, 24, LEFT% %@"{PRICE:LOCAL,5}%LOCALS%", 9%　　
		LOCAL:1++
	ELSE
		PRICE:LOCAL = 0
	ENDIF
	LOCAL += 1
	SIF LOCAL:1 % 2 == 0
		PRINTL 
	SIF ITEMLIST:LOCAL == ""
		BREAK
WEND
SIF LOCAL:1 & 1
	PRINTL 
;---- EDIT 052 ADD END   -------------------------
$INPUT_LOOP
DRAWLINE
PRINTFORML [100] 돌아간다
INPUT
IF RESULT == 100
	RETURN -1
ELSEIF RESULT < 0 || RESULT > 19 || PRICE:RESULT == 0
	GOTO INPUT_LOOP
ELSE
	CALL DUNGEON_BUY, GETNUM(ITEM, ITEMLIST:RESULT), PRICE:RESULT, ARG
	RESTART
ENDIF

;=====================================================================
;扉への進入
;=====================================================================
@DUNGEON_DOOR,ARG
IF ARG > 0
	;TA:(FLAG:현M*100+FLAG:현던전):(FLAG:현X):(FLAG:현Y) = 2
	CALL SET_FLOOR_ANALYZE(2, FLAG:현던전, FLAG:현M, FLAG:현X, FLAG:현Y)
	CALL WALK_DUNGEON,ARG
ENDIF

;=====================================================================
;トラップ：ＨＰ데미지
;=====================================================================
@DUNGEON_TRAP_HP,ARG
SIF FLAG:리프트마
	RETURN 1
LOCAL:1 = 0
FOR LOCAL,1,7
	IF POS(LOCAL) > -1 && GET_STATE(CFLAG:(POS(LOCAL)):상태이상) != "DYING"
		IF RAND:2 && RAND:100 < MAXBASE:(POS(LOCAL)):지혜
			CONTINUE
		ELSEIF RAND:100 < MAXBASE:(POS(LOCAL)):운
			CONTINUE
		ENDIF
		CALL VAR_HP,POS(LOCAL),-MAXBASE:(POS(LOCAL)):ＨＰ*ARG/100
		LOCAL:1 += 1
	ENDIF
NEXT
PRINTFORMW %CALLNAME:MASTER% 일행은 데미지를 받았다
RETURN 1

;=====================================================================
;トラップ：ＭＰ데미지
;=====================================================================
@DUNGEON_TRAP_MP,ARG
SIF FLAG:리프트마
	RETURN 1
LOCAL:1 = 0
FOR LOCAL,1,7
	IF POS(LOCAL) > -1 && GET_STATE(CFLAG:(POS(LOCAL)):상태이상) != "DYING"
		IF RAND:2 && RAND:100 < MAXBASE:(POS(LOCAL)):지혜
			CONTINUE
		ELSEIF RAND:100 < MAXBASE:(POS(LOCAL)):운
			CONTINUE
		ENDIF
		CALL VAR_MP,POS(LOCAL),-MAXBASE:(POS(LOCAL)):ＭＰ*ARG/100
		LOCAL:1 += 1
	ENDIF
NEXT
PRINTFORMW %CALLNAME:MASTER% 일행은 마력을 빼앗겼다
RETURN 1

;=====================================================================
;トラップ：毒
;=====================================================================
@DUNGEON_TRAP_POISON,ARG,ARG:1 = 8
SIF FLAG:리프트마
	RETURN 1
LOCAL:1 = 0
FOR LOCAL,1,7
	IF POS(LOCAL) > -1 && CFLAG:(POS(LOCAL)):상태이상 < GET_STATE_NUM("POISON")
		SIF MAXBASE:POS(LOCAL):GET_TYPE(ARG:1) == 999 || MAXBASE:POS(LOCAL):GET_TYPE(ARG:1) < 1 || (100+MAXBASE:POS(LOCAL):POISON) < 1
			CONTINUE
		IF RAND:2 && RAND:100 < MAXBASE:(POS(LOCAL)):지혜
			CONTINUE
		ELSEIF RAND:100 < MAXBASE:(POS(LOCAL)):운
			CONTINUE
		ENDIF
		IF RAND:100 < ARG * MAXBASE:(POS(LOCAL)):GET_TYPE(ARG:1) * (100+MAXBASE:POS(LOCAL):POISON) / 10000
			CFLAG:(POS(LOCAL)):상태이상 = GET_STATE_NUM("POISON")
			LOCAL:1 += 1
		ENDIF
	ENDIF
NEXT
PRINTFORMW %CALLNAME:MASTER% 일행은 독에 걸렸다
RETURN 1

;=====================================================================
;トラップ：バッド스테이터스
;=====================================================================
@DUNGEON_TRAP_BADSTATE,ARG,ARG:1,ARG:2 = -1
;ARG:0　バステの종류
;ARG:1　付く확률
;ARG:2　バステの相性

;相性に설정がなければ디폴트の相性をつける
;※DYINGは파마
IF ARG:2 == -1
	SELECTCASE ARG
		CASE 1,3,4,10
			ARG:2 = 9
		CASE 2
			ARG:2 = 6
		CASE 5
			ARG:2 = 5
		CASE 6,7,8,9,11
			ARG:2 = 8
		CASE 12,14
			ARG:2 = 11
		CASE 13,16,17
			ARG:2 = 17
		CASE 15,20
			ARG:2 = 10
		CASE 18
			ARG:2 = 4
		CASE 19
			ARG:2 = 7
	ENDSELECT
ENDIF
SIF FLAG:리프트마 || ARG:2 == -1
	RETURN 1
LOCAL:1 = 0
FOR LOCAL,1,7
	IF POS(LOCAL) > -1
		SIF MAXBASE:POS(LOCAL):GET_TYPE(ARG:2) == 999 || MAXBASE:POS(LOCAL):GET_TYPE(ARG:2) < 1 || (100+MAXBASE:POS(LOCAL):GET_STATE(ARG)) < 1
			CONTINUE
		IF RAND:2 && RAND:100 < MAXBASE:(POS(LOCAL)):지혜
			CONTINUE
		ELSEIF RAND:100 < MAXBASE:(POS(LOCAL)):운
			CONTINUE
		ENDIF
		IF RAND:100 < ARG:1 * MAXBASE:(POS(LOCAL)):GET_TYPE(ARG:2) * (100+MAXBASE:POS(LOCAL):GET_STATE(ARG)) / 10000
			CFLAG:(POS(LOCAL)):상태이상 = ARG
			LOCAL:1 += 1
		ENDIF
	ENDIF
NEXT
PRINTFORMW %CALLNAME:MASTER% 일행은 %GET_STATE(ARG)%에 걸렸다
RETURN 1

;=======================================================================
;指定したマスに進入可能か・기본
;=======================================================================
@CAN_ENTER,ARG,ARG:1
;マップの最小・최대範囲超えてたら無理
SIF ARG < 0 || ARG > FLAG:최대X || ARG:1 < 0 || ARG:1 > FLAG:최대Y
	RETURN 0
;とりあえず壁は無理
SIF DA:ARG:(ARG:1) % 10 == 0
	RETURN 0
RETURN 1

;===================================================================
;ＭＡＧ소비処理
;===================================================================
@CONSUME_MAG
FOR LOCAL:1,1,7
	LOCALS = 포지션{LOCAL:1}
	IF FLAG:LOCALS > -1
		;LOCALに소비する人の番号を突っ込む
		LOCAL = FLAG:LOCALS
		;CPが0なら飛ばす
		SIF BASE:LOCAL:CP == 0
			CONTINUE
		;종족が인간でも飛ばす
		SIF ABL:LOCAL:종족 == 0
			CONTINUE
		;---- EDIT 042 ADD START -------------------------
		;呪いのレッドカーペット起動中なら飛ばす
		SIF EQUIP:MASTER:저주의레드카펫
			CONTINUE
		;---- EDIT 042 ADD END -------------------------
		IF CFLAG:LOCAL:ＭＡＧ자기소비 == 1
			;自己消費がＯＮなら自分のＭＡＧを見る
			IF BASE:LOCAL:ＭＡＧ == 0
				;ＭＡＧが空の場合主人を見る
				IF BASE:MASTER:ＭＡＧ == 0
					;主人のも空ならダメージ処理
					CALL VAR_HP,LOCAL,-(MAXBASE:LOCAL:ＨＰ/10),0
					CALL VAR_MP,LOCAL,-(MAXBASE:LOCAL:ＭＰ/10),0
				ELSE
					CALL CONTROL_MAG, MASTER, -MAXBASE:LOCAL:CP * FLAG:MAG소비율 / 100
				ENDIF
			ELSE
				;空でなければ自分で消費
				CALL CONTROL_MAG,LOCAL, -MAXBASE:LOCAL:CP * FLAG:MAG소비율 / 100
			ENDIF
		ELSE
			;自己消費がＯＦＦなら主人のＭＡＧを見る
			IF BASE:MASTER:ＭＡＧ == 0
				;主人のＭＡＧが空の場合自分のＭＡＧを見る
				IF BASE:LOCAL:ＭＡＧ == 0
					;主人のも空ならダメージ処理
					CALL VAR_HP,LOCAL,-(MAXBASE:LOCAL:ＨＰ/10),0
					CALL VAR_MP,LOCAL,-(MAXBASE:LOCAL:ＭＰ/10),0
				ELSE
					CALL CONTROL_MAG, LOCAL,-MAXBASE:LOCAL:CP * FLAG:MAG소비율 / 100
				ENDIF
			ELSE
				;空でなければ主人で消費
				CALL CONTROL_MAG,MASTER,-MAXBASE:LOCAL:CP  * FLAG:MAG소비율 / 100
			ENDIF
		ENDIF
	ENDIF
NEXT

;===================================================================
;ＭＡＧ소비切り替え
;===================================================================
@SWITCH_MAG

$PRINT_LIST
DRAWLINE
FOR LOCAL,1,7
	LOCALS = 포지션{LOCAL}
	SIF FLAG:LOCALS < 1
		CONTINUE
	PRINTFORM [{LOCAL}]　
	CALL ARRANGE_CHARALIST_2,FLAG:LOCALS
	CALL ARRANGE_CHARALIFE, FLAG:LOCALS
	PRINTFORM 　MAG:[{BASE:(FLAG:LOCALS):ＭＡＧ,8}/{MAXBASE:(FLAG:LOCALS):ＭＡＧ,8}] \@ CFLAG:(FLAG:LOCALS):ＭＡＧ자기소비 ? 자기소비 # 주인소비 \@
NEXT
PRINTL

DRAWLINE
PRINTFORML ＭＡＧ소비를 바꾸고 싶은 캐릭터를 선택해주세요
DRAWLINE

PRINTLC [1000]돌아간다

$INPUT_LOOP_1
INPUT
LOCALS = 포지션{RESULT}
IF RESULT == 1000
	RETURN 0
ELSEIF RESULT < 1 || RESULT > 6 || FLAG:LOCALS < 1
	GOTO INPUT_LOOP_1
ELSE
	IF CFLAG:(FLAG:LOCALS):ＭＡＧ자기소비 == 0
		CFLAG:(FLAG:LOCALS):ＭＡＧ자기소비 = 1
	ELSE
		CFLAG:(FLAG:LOCALS):ＭＡＧ자기소비 = 0
	ENDIF
ENDIF
RESTART


;===================================================================
;ID捜査
;===================================================================
@SEARCH_ID(ARG)
#FUNCTION
FOR LOCAL,0,FLAG:최대X
	FOR LOCAL:1,0,FLAG:최대Y
		IF DA:(LOCAL):(LOCAL:1) == ARG
			RETURNF LOCAL*100+LOCAL:1
		ENDIF
	NEXT
NEXT
RETURNF LOCAL*100+LOCAL:1


;===================================================================
;에스트마・리베라마等の効힘
;　COMPの기능でデフォで인카운트율変動とかあるといいかも
;===================================================================
@ENCOUNTER_CHANGER
	FLAG:인카운트율보정 = 0
	FLAG:에스트마 = 0
	FLAG:라이트마 = 0
	FLAG:리프트마 = 0
RETURN 1


;===================================================================
;월령変化
;===================================================================
@MOON
IF FLAG:월령벡터 == 0
	FLAG:월령 ++
ELSE
	FLAG:월령 --
ENDIF
SIF FLAG:월령 > 8
	FLAG:월령 = 8
SIF FLAG:월령 < 0
	FLAG:월령 = 0
SIF FLAG:월령 == 8
	FLAG:월령벡터 = 1
SIF FLAG:월령 == 0
	FLAG:월령벡터 = 0

IF FLAG:월령 == 0 && FLAG:SHOP커맨드 == [[SHOP:탐색]]
	SIF FLAG:인카운트율보정 || FLAG:에스트마
		PRINTW 적의 기색이 원래대로 돌아왔다。
	FLAG:인카운트율보정 = 0
	FLAG:에스트마 = 0
	FLAG:라이트마 = 0
	FLAG:리프트마 = 0
	CALL 술에서깸()
	TRYCALLFORM EVENT_NEWMOON_DUNGEON{FLAG:현던전}
ENDIF

;===================================================================
;월령歩き
;===================================================================
@MOVE_MOON,ARG
LOCAL += 1
IF LOCAL >= 16 * FLAG:월령진행률 / 100
	LOCAL = 0
	CALL MOON
ENDIF

;===================================================================
;ＤＤＭ
;自宅のサーバーに악마を転送する
;===================================================================
@COMP_DDM
CALL INPUT_CHARA_LIST("자택서버에 전송시킬 악마를 선택해주세요", "CASTING_COMP_DDM", "UP_PRINT_COMP_DDM")
IF RESULT == 1000
	RETURN 0
ELSE
	;---- EDIT 013 ADD START -------------------------
	IF CFLAG:RESULT:PT플래그 == 2
		PRINTFORML %조사처리(CALLNAME:RESULT,"는")% 전투에 참가하고 있는 멤버입니다
		PRINTFORML 자택 서버에 전송시켜도 이대로 전투에
		PRINTFORML 참가를 계속 시킬지 선택해주세요
		LOCAL = RESULT
		CALL INPUT_SELECT(1, "계속 참가시킨다", 2, "멤버에서 빼고 전송시킨다", 9, "전송을 그만둔다")
		IF RESULT == 9
			RESTART
		ELSEIF RESULT == 2
			CALL REMOVE_POSITION, CPOS(LOCAL)
			PRINTFORMW %조사처리(CALLNAME:LOCAL,"를")% 전투 멤버에서 빼고 자택 서버에 전송시켰습니다
		ENDIF
		RESULT = LOCAL
	ENDIF
	;---- EDIT 013 ADD END -------------------------
	CFLAG:RESULT:소속ＣＯＭＰ = -1
	;---- EDIT 012 MOD START ------------------------
	;送った악마がリストから消えるようにリスト構築からやり直させる
	RESTART
	;GOTO PRINT_LIST
	;---- EDIT 012 MOD END   ------------------------
ENDIF

@CASTING_COMP_DDM(ARG)
SIF ARG == MASTER
	RETURN 0
SIF (ABL:ARG:종족 == 0 || ABL:ARG:종족 > 45)
	RETURN 0
SIF CFLAG:ARG:이자리에없는플래그 == 1
	RETURN 0
;---- EDIT 012 MOD START ------------------------
;第一引数がLOCALだったのをARGに修正
SIF CFLAG:ARG:용량미사용
	RETURN 0
SIF CFLAG:ARG:소속ＣＯＭＰ == -1
	RETURN 0
;---- EDIT 012 MOD END   ------------------------
RETURN 1

@UP_PRINT_COMP_DDM
PRINTFORML 자택서버에 전송시킬 악마를 선택해주세요　\@ A > 리스트표시수() ? ＜page.{P + 1}/{A / 리스트표시수() + 1}＞ # \@　ＣＯＭＰ：{NUM_NAKAMA()+소프트용량()}/{FLAG:ＣＯＭＰ용량}


;---- EDIT 021 ADD START -------------------------

;=================================================
;   sub DG_GET_TILE
;=================================================
;   タイル文字取得
;-------------------------------------------------
; Input:
;  ARG:0				X座標
;  ARG:1				Y座標
;  ARG:2				M番号
;  ARG:3				던전番号
; Output:
;  RESULTS				タイル文字
;-------------------------------------------------
@DG_GET_TILE(ARG:0, ARG:1, ARG:2, ARG:3)
#DIM LX
#DIM LY
#DIM LM
#DIM LD
#DIM TILE_VAL
#DIMS KEY
#LOCALSSIZE 1

LX = ARG:0
LY = ARG:1
LM = ARG:2
LD = ARG:3
LOCALS =
KEY =
TILE_VAL = DA:LX:LY


IF (TILE_VAL % 10) == -1
	KEY = D
ELSE
	KEY = {TILE_VAL % 10}
ENDIF
TRYCCALLFORM TILE_MARK_COMMON_{LD}_%KEY%, TILE_VAL, LX, LY
	SIF RESULT == 1
		GOTO NO_COMMON
	LOCALS = %RESULTS%
CATCH
	$NO_COMMON
	TRYCCALLFORM TILE_MARK_ID_{LD}_{LM}_% \@TILE_VAL < 0 ? m # \@%{ABS(TILE_VAL)}
		LOCALS = %RESULTS%
	CATCH
		;- DG:タイル標準文字
		CALL DG_BASE_TILE(LX, LY, LM, LD)
		LOCALS = %RESULTS%
	ENDCATCH
ENDCATCH

;-- 던전32:不思議な던전 --------
;動的に特殊タイルを設定する	※シンボルエンカウントなどの『移動するオブジェクト』対応
;　※M番号、X座標、Y座標を関数名ではなく引数で渡すことでシンボルエンカウントなどの『移動するオブジェクト』の描画に対応可能とする
IF FLAG:지형자동생성・FOE플래그 == 1
	CALL SEF_TILE_MARK_DYBANUC, LX, LY
	LOCALS = %RESULTS%
ENDIF
;-- 던전32:不思議な던전 --------

;---- EDIT 051 MOD  -------------------------
IF GETCOLOR() == GETDEFCOLOR()
	SELECTCASE LOCALS
		CASE "■"
			SETCOLOR GETDEFCOLOR()
		CASE "□"
			IF DA:LX:LY < 0
				SETCOLOR 0x333344
			ELSE
				SETCOLOR 0x777766
			ENDIF
		;KR판 임의수정, 원본명 CASE 추가
		CASE "扉", "문"
			SETCOLOR 0x8888aa
		CASE "宝", "보"
			SETCOLOR 0xffdd99
		CASE "罠", "덫"
			SETCOLOR 0xbb0033
		CASE "昇", "降", "승", "강"
			SETCOLOR 0x44aa00
		CASE "Ｔ", "ｔ", "！"
			SETCOLOR 0xaa44ff
		CASE "Ｒ", "Ｃ"
			SETCOLOR 0x77bbff
		CASE "↑", "→", "↓", "←", "Ｅ", "出", "출"
			SETCOLOR 0xff7700
		CASEELSE
	ENDSELECT
ENDIF

RESULTS = %LOCALS%


;=================================================
;   sub DG_BASE_TILE
;=================================================
;   タイル標準文字
;-------------------------------------------------
; Input:
;  ARG:0				X座標
;  ARG:1				Y座標
;  ARG:2				M番号
;  ARG:3				던전番号
; Output:
;  RESULTS				タイル標準文字
;-------------------------------------------------
@DG_BASE_TILE(ARG:0, ARG:1, ARG:2, ARG:3)
#DIM LX
#DIM LY
#DIM LM
#DIM LD
#DIM TILE_VAL
#LOCALSSIZE 1

LX = ARG:0
LY = ARG:1
LM = ARG:2
LD = ARG:3
LOCALS=
TILE_VAL = DA:LX:LY

SELECTCASE TILE_VAL % 10
	CASE 0
		LOCALS = ■
	CASE 1
		LOCALS = □
	CASE 2
		LOCALS = 문
	CASE 3
		LOCALS = 보
	CASE 4
		LOCALS = ！
	CASE 5
		IF GET_FLOOR_ANALYZE_T(LX, LY) == 2
			LOCALS = 덫
		ELSE
			LOCALS = □
		ENDIF
	CASE 6
		LOCALS = 승
	CASE 7
		LOCALS = 강
	CASE 8
		LOCALS = 출
	CASE -1 
		LOCALS = □
	CASE -9
		SELECTCASE -TILE_VAL / 10
			CASE 0
				LOCALS = Ｔ
			CASE 1
				LOCALS = Ｒ
			CASE 2
				LOCALS = Ｅ
		ENDSELECT
	CASEELSE
		TRYCCALLFORM TILE_MARK_{LD}_{LM}_{LX}_{LY}
			LOCALS = %RESULTS%
		CATCH
			LOCALS = ■
		ENDCATCH
ENDSELECT

RESULTS = %LOCALS%

;---- EDIT 021 ADD END   -------------------------
;---- EDIT 050 ADD START -------------------------
@KARMA_TERMINAL
	CUSTOMDRAWLINE =
	
	PRINTL 식노를 셋팅을 진행합니다
	PRINTL 실행 내용을 선택해 주세요.
	
	DRAWLINE
	
	PRINTL [1]스킬세트
	PRINTL [2]스테이터스세트
	PRINTL [3]만트라취득
	
	DRAWLINE
	PRINTL [0]아무것도안한다

	CALL INPUTINT,0,1,2,3

	SELECTCASE RESULT
		CASE 0
			RETURN 1
		CASE 1
			CALL SET_KARMANS_SKILL
		CASE 2
			CALL SET_KARMANS_STATUS
		CASE 3
			CALL KARMAN
	ENDSELECT
	RESTART
		
;---- EDIT 050 ADD END -------------------------	
;---- EDIT 029 ADD START -------------------------
@KARMAN
	LOCAL:1 = 0
	FOR LOCAL, 1, 7
		SIF POS(LOCAL) < 0
			CONTINUE
		SIF !TALENT:POS(LOCAL):식노
			CONTINUE
		;行動可能なキャラでないとダメ
		CALL INPUTABLE_CHARA, POS(LOCAL)
		SIF !RESULT
			CONTINUE
		LOCAL:1 = 1
		BREAK
	NEXT
	IF !LOCAL:1
		PRINTW 만트라를 습득 가능한 캐릭터가 없습니다
		RETURN 0
	ENDIF
	LOCAL:2 = LINECOUNT
	$MANTRA_LOOP
	CLEARLINE LINECOUNT - LOCAL:2
	CALL SHOW_NOW_FORMATION_P,0,2
;---- EDIT 050 MOD START -------------------------
;RESTAT選べる意味がなさそうなのでコメントアウト
;	PRINTL [0] ＣＡＮＣＥＬ [2000]ＡＬＬ ＣＡＮＣＥＬ
	PRINTL [0] 돌아간다
	PRINTL 누구에게 만트라를 습득시키겠습니까?
;	CALL INPUTINT(0,1,2,3,4,5,6,2000)
	CALL INPUTINT(0,1,2,3,4,5,6)
	IF RESULT == 0
;		RESTART
;	ELSEIF RESULT == 2000
		RETURN 0
;---- EDIT 050 MOD END -------------------------
	ELSE
		LOCAL = POS(RESULT)
		SIF LOCAL < 0
			GOTO MANTRA_LOOP
		IF !TALENT:LOCAL:식노
			PRINTFORMW %조사처리(CALLNAME:LOCAL,"는")% 식노가 아닙니다
			GOTO MANTRA_LOOP
		ENDIF
		CALL INPUTABLE_CHARA, LOCAL
		IF !RESULT
			PRINTFORMW %조사처리(CALLNAME:LOCAL,"는")% 만트라를 습득할 수 있는 상태가 아닙니다
			GOTO MANTRA_LOOP
		ENDIF
		CALL DOWNLOAD_MANTRA, 7, 7, LOCAL
		GOTO MANTRA_LOOP
	ENDIF
;---- EDIT 029 ADD END   -------------------------

;---- EDIT 050 ADD START -------------------------
@SET_KARMANS_SKILL

	LOCAL:1 = LINECOUNT
	$MANTRA_LOOP
	CLEARLINE LINECOUNT - LOCAL:1
	CALL SHOW_NOW_FORMATION_P,0,2
	PRINTL [0] 돌아간다
	PRINTL 누구의 소지스킬을 변경할까？
	CALL INPUTINT(0,1,2,3,4,5,6)
	IF RESULT == 0
		RETURN 0
	ELSE
		LOCAL = POS(RESULT)
		SIF LOCAL < 0
			GOTO MANTRA_LOOP
		IF !TALENT:LOCAL:식노
			PRINTFORMW %조사처리(CALLNAME:LOCAL,"는")% 식노가 아닙니다
			GOTO MANTRA_LOOP
		ENDIF
		CALL INPUTABLE_CHARA, LOCAL
		IF !RESULT
			PRINTFORMW %조사처리(CALLNAME:LOCAL,"는")% 스킬을 셋팅할 수 있는 상태가 아닙니다
			GOTO MANTRA_LOOP
		ENDIF
		CALL SET_MANTRA_SKILL,LOCAL
		GOTO MANTRA_LOOP
	ENDIF
	
@SET_KARMANS_STATUS

	LOCAL:1 = LINECOUNT
	$MANTRA_LOOP
	CLEARLINE LINECOUNT - LOCAL:1
	CALL SHOW_NOW_FORMATION_P,0,2
	PRINTL [0] 돌아간다
	PRINTL 누구의 스테이터스배분을 변경할까？
	CALL INPUTINT(0,1,2,3,4,5,6)
	IF RESULT == 0
		RETURN 0	
	ELSE
		LOCAL = POS(RESULT)
		SIF LOCAL < 0
			GOTO MANTRA_LOOP
		IF !TALENT:LOCAL:식노
			PRINTFORMW %조사처리(CALLNAME:LOCAL,"는")% 식노가 아닙니다
			GOTO MANTRA_LOOP
		ENDIF
		CALL INPUTABLE_CHARA, LOCAL
		IF !RESULT
			PRINTFORMW %조사처리(CALLNAME:LOCAL,"는")% 스킬을 셋팅할 수 있는 상태가 아닙니다
			GOTO MANTRA_LOOP
		ENDIF
		CALL MANTRA_BASESTATUS,LOCAL
		GOTO MANTRA_LOOP
	ENDIF

;---- EDIT 050 ADD END -------------------------