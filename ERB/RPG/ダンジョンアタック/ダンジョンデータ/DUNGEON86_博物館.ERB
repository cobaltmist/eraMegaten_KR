
;=======================================================================
;박물관
;ボス・단탈리안
;던전ナンバー86　ＭＡＰ0~3
;던전플래그:86:0 던전進行フラグ　1,ダンタリアン撃破
;던전플래그:86:1 スタート時이벤트
;던전플래그:86:2 
;=======================================================================

;=======================================================================
;攻略조건
;=======================================================================
@PREREQUISITE_DUNGEON_86
IF  던전플래그:78:0 > 0 & !던전플래그:86:0
	RETURN 1
ENDIF

;=======================================================================
;던전名
;=======================================================================
@GET_DUNGEON_NAME_86
RESULTS = 박물관

;=======================================================================
;플로어名표시
;=======================================================================
@FLOORNAME_86
PRINT 박물관
SELECTCASE FLAG:현M
	CASE 0
		PRINTL １Ｆ
	CASE 1
		PRINTL ２Ｆ
	CASE 2
		PRINTL ３Ｆ
	CASE 3
		PRINTL ４Ｆ
ENDSELECT


;=======================================================================
;特殊タイル표시
;=======================================================================
@TILE_MARK_COMMON_86_1, ARG , ARG:1 , ARG:2
SELECTCASE ARG / 10
	CASE 11 , 21 , 31 , 41 , 51 , 61 , 71 , 81
		RESULTS = 穴
	CASEELSE
		RETURN 1
ENDSELECT

;=======================================================================
;スタート地点입력
;=======================================================================
@START_DUNGEON_86,ARG
FLAG:현M = 0
FLAG:현X = 3
FLAG:현Y = 11
;CALL AUTOMAP
;=======================================================================
;攻略開始時の이벤트
;=======================================================================
@EVENT_DUNGEON_START_86
IF 던전플래그:86:1 == 0
CALL MESSAGE_WINDOW_D, "", "＞박물관을 점거한 악마를 쓰러뜨리라는 의뢰를 받은 당신은 박물관에 왔다"
CALL MESSAGE_WINDOW_D, "", "＞박물관 내에서 기묘한 느낌이 난다"
CALL MESSAGE_WINDOW_D, "", "＞악마의 소굴이 되었다는 말은 사실 같다"
던전플래그:86:1 = 1
ENDIF
;=======================================================================
;指定したマスに進入가능か
;=======================================================================
@CAN_ENTER_86,ARG,ARG:1
CALL CAN_ENTER,ARG,ARG:1
RETURN RESULT

;=======================================================================
;플로어데이터
;=======================================================================
@MAKE_FLOOR_86
SELECTCASE FLAG:현M
	CASE 0
	;１階
		FLAG:최대X = 15
		FLAG:최대Y = 14
;								 012345678901234
		CALL MAKE_FLOOR_LINE, 0,"               "
		CALL MAKE_FLOOR_LINE, 1," $ $ 6211111   "
		CALL MAKE_FLOOR_LINE, 2," 11a       2   "
		CALL MAKE_FLOOR_LINE, 3," 2   111111111 "
		CALL MAKE_FLOOR_LINE, 4," 11111   1   1 "
		CALL MAKE_FLOOR_LINE, 5," 111112# 1   1 "
		CALL MAKE_FLOOR_LINE, 6," 111     1   1 "
		CALL MAKE_FLOOR_LINE, 7," 111 $11111$ 1 "
		CALL MAKE_FLOOR_LINE, 8,"   2         1 "
		CALL MAKE_FLOOR_LINE, 9," 11111 1b11 11 "
		CALL MAKE_FLOOR_LINE,10," 11111 1  1213 "
		CALL MAKE_FLOOR_LINE,11," 11c11 $ $1    "
		CALL MAKE_FLOOR_LINE,12,"   2           "
		CALL MAKE_FLOOR_LINE,13,"   8           "


	CASE 1
	;２階
		FLAG:최대X = 14
		FLAG:최대Y = 14
;								 01234567890123
		CALL MAKE_FLOOR_LINE, 0,"              "
		CALL MAKE_FLOOR_LINE, 1," 111127 d1111 "
		CALL MAKE_FLOOR_LINE, 2," 2      1   1 "
		CALL MAKE_FLOOR_LINE, 3," % eA 311   1 "
		CALL MAKE_FLOOR_LINE, 4," 1    111   1 "
		CALL MAKE_FLOOR_LINE, 5," 11111111   1 "
		CALL MAKE_FLOOR_LINE, 6,"            1 "
		CALL MAKE_FLOOR_LINE, 7," 11f111111121 "
		CALL MAKE_FLOOR_LINE, 8," 1   $   B1 1 "
		CALL MAKE_FLOOR_LINE, 9," 1 $   $  1 1 "
		CALL MAKE_FLOOR_LINE,10," 1 11111$ $ 1 "
		CALL MAKE_FLOOR_LINE,11," 1   2      1 "
		CALL MAKE_FLOOR_LINE,12," 111Cg1$ 6211 "
		CALL MAKE_FLOOR_LINE,13,"              "

CASE 2
	;３階
		FLAG:최대X = 15
		FLAG:최대Y = 14
;								 012345678901234
		CALL MAKE_FLOOR_LINE, 0,"               "
		CALL MAKE_FLOOR_LINE, 1," 11111111D111$ "
		CALL MAKE_FLOOR_LINE, 2," 1      2 2    "
		CALL MAKE_FLOOR_LINE, 3," 1 E2111111111 "
		CALL MAKE_FLOOR_LINE, 4," 1   111111111 "
		CALL MAKE_FLOOR_LINE, 5," 1        2    "
		CALL MAKE_FLOOR_LINE, 6," 11F1111111111 "
		CALL MAKE_FLOOR_LINE, 7," 2   31111   1 "
		CALL MAKE_FLOOR_LINE, 8," 111   1 1   1 "
		CALL MAKE_FLOOR_LINE, 9,"   1   1 1   1 "
		CALL MAKE_FLOOR_LINE,10," 6 1   1 111 $ "
		CALL MAKE_FLOOR_LINE,11," 2 1 h 1   1   "
		CALL MAKE_FLOOR_LINE,12," 111 G 127 11$ "
		CALL MAKE_FLOOR_LINE,13,"               "

	CASE 3
	;４階
		FLAG:최대X = 15
		FLAG:최대Y = 13
;								 012345678901234
		CALL MAKE_FLOOR_LINE, 0,"               "
		CALL MAKE_FLOOR_LINE, 1,"       !       "
		CALL MAKE_FLOOR_LINE, 2,"       2       "
		CALL MAKE_FLOOR_LINE, 3,"     11111     "
		CALL MAKE_FLOOR_LINE, 4,"     11111     "
		CALL MAKE_FLOOR_LINE, 5,"     11111     "
		CALL MAKE_FLOOR_LINE, 6,"       1       "
		CALL MAKE_FLOOR_LINE, 7," 1111111111111 "
		CALL MAKE_FLOOR_LINE, 8," 2 1     1   1 "
		CALL MAKE_FLOOR_LINE, 9," 7 1 H $21   1 "
		CALL MAKE_FLOOR_LINE,10,"   1 2       1 "
		CALL MAKE_FLOOR_LINE,11," 111 111111111 "
		CALL MAKE_FLOOR_LINE,12,"               "
	CASEELSE


ENDSELECT

;=======================================================================
;タイル調整
;=======================================================================
@MAKE_FLOOR_LINE_COMMON_86, ARG, ARG:1, ARG:2
#LOCALSIZE 30
;LOCAL:3 宝箱 던전플래그:84~99
;LOCAL:4 이벤트
;(0/0)でLOCALを소거
SIF ARG:1 == 0 && ARG:2 == 0
	VARSET LOCAL
SELECTCASE ARG
	CASE 3
		IF GETBIT(던전플래그:(FLAG:현던전):(FLAG:현M+70), LOCAL:3)
			DA:(ARG:1):(ARG:2) = 1
		ELSE
			DA:(ARG:1):(ARG:2) = FLAG:현M *1000 + LOCAL:3 * 10 + 3
		ENDIF
		LOCAL:3++
	CASE 4
		DA:(ARG:1):(ARG:2) = FLAG:현M *1000 + LOCAL:4 * 10 + 4
		LOCAL:4++
	CASE 5
		;DA:(ARG:1):(ARG:2) = FLAG:현M *1000 + LOCAL:5 * 10 + 5
		;LOCAL:5++
	CASE 6
		DA:(ARG:1):(ARG:2) = FLAG:현M *1000 + LOCAL:6 * 10 + 6
		LOCAL:6++
	CASE 7
		DA:(ARG:1):(ARG:2) = FLAG:현M *1000 + LOCAL:7 * 10 + 7
		LOCAL:7++
	CASE 8
		DA:(ARG:1):(ARG:2) = FLAG:현M *1000 + LOCAL:8 * 10 + 8
		LOCAL:8++
	CASE 9
		DA:(ARG:1):(ARG:2) = FLAG:현M *1000 + LOCAL:9 * 10 + 9
		LOCAL:9++
ENDSELECT


;=======================================================================
;タイル定義
;=======================================================================
@DEFINE_TILES_86, ARGS, ARG, ARG:1
SELECTCASE ARGS

	CASE "a"
		RETURN 101
	CASE "A"
		RETURN 111
	CASE "b"
		RETURN 201
	CASE "B"
		RETURN 211
	CASE "c"
		RETURN 301
	CASE "C"
		RETURN 311
	CASE "d"
		RETURN 401
	CASE "D"
		RETURN 411
	CASE "e"
		RETURN 501
	CASE "E"
		RETURN 511
	CASE "f"
		RETURN 601
	CASE "F"
		RETURN 611
	CASE "g"
		RETURN 701
	CASE "G"
		RETURN 711
	CASE "h"
		RETURN 801
	CASE "H"
		RETURN 811
	CASE "#"
		RETURN 14
	CASE "$"
		RETURN 24
	CASE "%"
		RETURN 34
	CASE "!"
		RETURN 1004
ENDSELECT


;=======================================================================
;[5]조사　実行時の이벤트
;=======================================================================
@EVENT_CHECK_DUNGEON_86
CALL EVENT_DUNGEON_86
RETURN RESULT

;=======================================================================
;タイル進入時の이벤트
;=======================================================================
@EVENT_ENTER_DUNGEON_86,ARG
;ARG = 進入時の向き　0の場合ワープなど
CALL EVENT_DUNGEON_86, ARG , 0
RETURN RESULT

@EVENT_DUNGEON_86, ARG, ARG:1
SELECTCASE DA:(FLAG:현X):(FLAG:현Y) % 10
;==========
;ワープの処理
;==========
CASE 1
CALL FLOOR_86
RETURN RESULT

;==========
;出口の処理
;==========
CASE 8
CALL DUNGEON_EXIT
RETURN 1
;==========
;扉の処理
;==========
CASE 2
CALL DUNGEON_DOOR,ARG
RETURN 1
;========
;宝の処理
;========
CASE 3
CALL TREASURE_86
RETURN 1

;=======
;階段
;=======
CASE 6
CALL UPSTAIRS_86
RETURN RESULT

CASE 7
CALL DOWNSTAIRS_86
RETURN RESULT
;==========
;이벤트
;==========
CASE 4
	SELECTCASE DA:(FLAG:현X):(FLAG:현Y) / 10
	CASE  1
		CALL MESSAGE_WINDOW_D, "", "＞사당이 전시되어 있다."
		CALL MESSAGE_WINDOW_D, "", "＞「―――형태로 볼 때, 나라 시대 이전의 옛 것으로 생각되지만,/무슨 목적으로 만들어진 것인지는 확실하지 않다.」/라고 적혀 있다."
		CALL MESSAGE_WINDOW_D, "", "＞무언가를 봉인하기 위해 세워진 것 같지만,/본래 자리에서 옮겨지고 이곳에 전시되어/지금은 약한 기척을 보이고 있을 뿐이다"
	CASE  2
		IF 던전플래그:86:2 < 6
		CALL MESSAGE_WINDOW_D, "", "여성의 동상이 있다"
		던전플래그:86:2 += 1
		ELSE
		CALL MESSAGE_WINDOW_D, "", "……여성의 동상이 너무 많다는 생각이 든다"
		ENDIF
	CASE  3
		IF 던전플래그:86:1 == 1
		CALL MESSAGE_WINDOW_D, "", "＞악마들이 동상을 옮기고 있다"
		CALL MESSAGE_WINDOW_D, "잔트만", "또 단탈리안 님께서는 인간을 동상으로 만든거냐"
		CALL MESSAGE_WINDOW_D, "인큐버스", "그 분의 취미를 이해 못하겠어"
		CALL MESSAGE_WINDOW_D, "", "＞악마들이 이쪽을 눈치챘다!"
		CALL MESSAGE_WINDOW_D, "잔트만", "…! 너 침입자냐!?"
				FLAG:도주불가플래그 = 1
				FLAG:회화불능플래그 = 1
				FLAG:선제기습취소 = 1
				CALL SET_ENEMY,8,[[キャラ:잔트만]],35,0,1
				
				CALL SET_ENEMY,10,[[キャラ:인큐버스]],35,0,1

				CALL SYNC_STATUS,(CHARANUM-1)
				CALL HEALTH_CHARA,(CHARANUM-1)		
				CALL BATTLE_START
				FLAG:도주불가플래그 = 0
				FLAG:회화불능플래그 = 0
				FLAG:선제기습취소 = 0
		CALL MESSAGE_WINDOW_D, "", "＞악마들을 쓰러뜨렸다!"
		CALL MESSAGE_WINDOW_D, "", "＞아무래도 박물관에 배치된 동상들은/박물관에 있던 인간들이 변한 것 같다."
		CALL MESSAGE_WINDOW_D, "", "＞박물관을 지배하는 악마를 쓰러뜨리면 원래대로 돌아갈 지도 모르지만/지금은 어떻게 할 방법이 없다."
		던전플래그:86:1 = 2
		ENDIF
	CASE  100
			IF 던전플래그:86:0 == 0
				CALL MESSAGE_WINDOW_D, "", "＞"
				CALL MESSAGE_WINDOW_D, "단탈리안", "어떤가, 여기까지 오면서 내 컬렉션을 즐길 수 있었나."
				CALL MESSAGE_WINDOW_D, "단탈리안", "내 컬렉션과 어리석은 인간의 영혼을 동시에 손에 넣는 일석이조의 방법."
				CALL MESSAGE_WINDOW_D, "단탈리안", "이 박물관의 물건들도 많은 인간들의 혼을 사로잡아왔던 것들뿐이지"
				CALL MESSAGE_WINDOW_D, "단탈리안", "이 박물관의 모든 것이 나의 에너지다!"
				IF IS_LOOKSLIKE_MALE(MASTER)
					CALL MESSAGE_WINDOW_D, "단탈리안", "그럼, 너도 나의 에너지가 되어라."
				ELSE
					CALL MESSAGE_WINDOW_D, "단탈리안", "너도 내 컬렉션에 동참하겠군."
				ENDIF
				CALL MESSAGE_WINDOW_D, "", "타천사 단탈리안이 1명 나왔다！"
				FLAG:도주불가플래그 = 1
				FLAG:회화불능플래그 = 1
				FLAG:선제기습취소 = 1
				CALL SET_ENEMY,9,[[キャラ:단탈리안]],40,0,1
				CFLAG:(CHARANUM-1):행동횟수 = 2
				CFLAG:(CHARANUM-1):ＨＰ보정 += 1000
				CFLAG:(CHARANUM-1):ＭＰ보정 = 9000
				ABL:(CHARANUM-1):아이템1 = [[아이템:지혜의향]]
				ABL:(CHARANUM-1):입수확률1 = 100
				CALL SYNC_STATUS,(CHARANUM-1)
				CALL HEALTH_CHARA,(CHARANUM-1)		
				CALL BATTLE_START
				FLAG:도주불가플래그 = 0
				FLAG:회화불능플래그 = 0
				FLAG:선제기습취소 = 0
				CALL MESSAGE_WINDOW_D, "단탈리안", "윽, 나의 에너지가……/나의 컬렉션이……"
				CALL MESSAGE_WINDOW_D, "", "＞타천사 단탈리안을 쓰러뜨렸다!"
				CALL MESSAGE_WINDOW_D, "", "＞단탈리안을 토벌한 대가로 계좌에 ￥25000이 지급되었고, 명성 20을 얻었다"
				MONEY += 25000
				FLAG:명성 += 20
				던전플래그:86:0 = 1
				RETURN 1
		ENDIF
	ENDSELECT
ENDSELECT
RETURN 0


;=======================================================================
;階段置き場
;=======================================================================
@UPSTAIRS_86
;位置とIDが対応しているはずなので、同IDの階段を探させれば良い
SELECTCASE FLAG:현M
	CASEELSE
		CALL DUNGEON_UPSTAIRS_ID, FLAG:현M+1 , DA:(FLAG:현X):(FLAG:현Y) + 1000 + 1
ENDSELECT
RETURN 1

@DOWNSTAIRS_86
SELECTCASE FLAG:현M
	CASEELSE
		CALL DUNGEON_DOWNSTAIRS_ID, FLAG:현M-1 , DA:(FLAG:현X):(FLAG:현Y) - 1000 - 1
ENDSELECT
RETURN 1


;-----------------------------------------------------------------------
;タイル이벤트
;-----------------------------------------------------------------------
@FLOOR_86, ARG
#LOCALSIZE 4
#LOCALSSIZE 2
SELECTCASE DA:(FLAG:현X):(FLAG:현Y) / 10
	CASE 0 , 10 , 20 , 30 , 40 , 50 , 60 , 70 , 80
		RETURN 0
	;ワープゾーン
	CASEELSE
		;ワープゾーン関係
		;100の位がID
		;10の位が0なら上層に、1なら下層に行く
		LOCAL = DA:(FLAG:현X):(FLAG:현Y) / 10 % 10 ? DA:(FLAG:현X):(FLAG:현Y) -10 # DA:(FLAG:현X):(FLAG:현Y) + 10
		LOCAL:1 = DA:(FLAG:현X):(FLAG:현Y) / 10 % 10 ? FLAG:현M - 1 # FLAG:현M + 1
		CALL MESSAGE_WINDOW_D, "", "＞떨어지는 구멍이다!"
		CALL SHOW_PICTURE, "EMPTY"
		CALL DUNGEON_WORP_ID, LOCAL:1, LOCAL, 1
ENDSELECT
;=======================================================================
;宝箱の中身
;=======================================================================
@TREASURE_86
#LOCALSIZE 9
LOCAL = FLAG:현M + 70
LOCAL:1 = (DA:(FLAG:현X):(FLAG:현Y) / 10) % 100
SELECTCASE DA:(FLAG:현X):(FLAG:현Y) / 10
	;マップ번호*100+そのマップで何番눈の宝箱かを示す数値でどの宝箱かを判別します。
	;例えば0の場合、0版のマップの0番눈の宝箱であることを表しています。
	CASE 0
		CALL GET_TREASURE, [[아이템:방천화극]] , 1 , FLAG:현던전, LOCAL , LOCAL:1
	CASE 100
		CALL GET_TREASURE, [[아이템:연마의면구]] , 1 , FLAG:현던전, LOCAL , LOCAL:1
	CASE 200
		CALL GET_TREASURE, [[아이템:도쿠로의케이코기]] , 1 , FLAG:현던전, LOCAL , LOCAL:1
ENDSELECT
RETURN 1


;=======================================================================
;인카운트율
;=======================================================================
@ENCOUNT_RATE_86
		FLAG:인카운트율 = FLAG:미조우걸음수*5
SIF FLAG:미조우걸음수 < 5
	FLAG:인카운트율 = 0
;=======================================================================
;필요레벨눈安
;권장LV 雑魚최저LV 雑魚最高LV ボスLV 
;=======================================================================
@GET_DUNGEON_LV_86
RETURN 30, 29, 34, 40
;=======================================================================
;エンカウント処理
;=======================================================================
@CHECK_ENCOUNT_86
IF RAND:100 < FLAG:인카운트율
	CALL ENEMY_TABLE
	RETURN 1
ELSE
	FLAG:미조우걸음수 += 1
	RETURN 0
ENDIF
;=======================================================================
;적の종족の종류数
;RETURN X でXが종류の数になります
;あまりいろんなのが混ざっているとCOOPがとりにくくなったり
;적の공격속성が多くなる傾向にあるので、
;종류の数は1・2종류を主体に時々3종류くらいを기본にするのが望ましいと思われます
;=======================================================================
@CLASS_NUM_86
RETURN CLASS_NUM_COMMON("中級")
;=======================================================================
@ENEMY_NUM_86, ARG
RETURN ENEMY_NUM_COMMON("中級", ARG)
;=======================================================================
;적の종류
;=======================================================================
@ENEMY_86, ARG
SELECTCASE RAND:10
	CASE IS < 1
		RETURN [[キャラ:탁비]],33
	CASE IS < 2
		RETURN [[キャラ:뷔브르]],30
	CASE IS < 3
		RETURN [[キャラ:칼라드리우스]],30
	CASE IS < 4
		RETURN [[キャラ:프린시펄리티]],29
	CASE IS < 5
		RETURN [[キャラ:로렐라이]],31
	CASE IS < 6
		RETURN [[キャラ:성성이]],32
	CASE IS < 7
		RETURN [[キャラ:잔트만]],30
	CASE IS < 8
		RETURN [[キャラ:인큐버스]],34
	CASE IS < 9
		RETURN [[キャラ:스튐팔리데스]],32
	CASE IS < 10
		RETURN [[キャラ:누에]],31
ENDSELECT

;=======================================================================
;윤간참가악마
;=======================================================================
@DUNGEON_RAPE_DEVIL_86
;랜덤にどの악마が出るか決定
;RETURN CSV번호 , 人数 , 레벨
SELECTCASE RAND:3
	CASE 0
		RETURN [[キャラ:성성이]] , 3 + RAND:10 , CSVBASE([[キャラ:성성이]] , GETNUM(BASE , "LV") , 0) + RAND:3
	CASE 1
		RETURN [[キャラ:잔트만]] , 3 + RAND:10 , CSVBASE([[キャラ:잔트만]] , GETNUM(BASE , "LV") , 0) + RAND:3
	CASE 2
		RETURN [[キャラ:탁비]] , 3 + RAND:10 , CSVBASE([[キャラ:탁비]] , GETNUM(BASE , "LV") , 0) + RAND:3
ENDSELECT

