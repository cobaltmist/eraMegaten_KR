
;=======================================================================
;異界化エルミン
;フラグ
;=======================================================================




;=======================================================================
;攻略조건
;=======================================================================
@PREREQUISITE_DUNGEON_66
;特になし
SIF 이벤트플래그:23:0 == 2 && 던전플래그:66:1 == 0
	RETURN 1
RETURN 0


;=======================================================================
;던전名
;=======================================================================
@GET_DUNGEON_NAME_66
RESULTS = 이계화엘민학원


;=======================================================================
;フ로어名표시
;=======================================================================
@FLOORNAME_66
PRINT 이계화엘민학원
SELECTCASE FLAG:현M
	CASE 0
		PRINTL １Ｆ 에어리어１
	CASE 1
		PRINTL １Ｆ 에어리어２
	CASE 2
		PRINTL １Ｆ 에어리어３
	CASE 3
		PRINTL ２Ｆ 에어리어１
	CASE 4
		PRINTL ２Ｆ 에어리어２
	CASE 5
		PRINTL １Ｆ 에어리어４
	CASEELSE
		PRINTL
ENDSELECT


;=======================================================================
;特殊タイル표시
;=======================================================================
@TILE_MARK_66_0_4_0
RESULTS = ↑
@TILE_MARK_66_0_7_0
RESULTS = ↑

@TILE_MARK_66_4_3_0
RESULTS = ↑
@TILE_MARK_66_4_5_0
RESULTS = ↑

@TILE_MARK_66_1_4_14
RESULTS = ↓
@TILE_MARK_66_1_7_14
RESULTS = ↓

@TILE_MARK_66_3_3_14
RESULTS = ↓
@TILE_MARK_66_3_5_14
RESULTS = ↓

@TILE_MARK_66_1_14_7
RESULTS = →
@TILE_MARK_66_1_14_9
RESULTS = →

@TILE_MARK_66_2_0_7
RESULTS = ←
@TILE_MARK_66_2_0_9
RESULTS = ←

;=======================================================================
;スタート地点입력
;=======================================================================
@START_DUNGEON_66,ARG
FLAG:현M = 0
FLAG:현X = 12
FLAG:현Y = 13
;CALL AUTOMAP

;=======================================================================
;スタート時이벤트
;=======================================================================
@EVENT_DUNGEON_START_66
CALL MESSAGE_WINDOW_D, "", "＞마침내 미카게쵸의 주민들을 마을밖으로 탈출시킬 때가 왔다。/＞이를 위해 주민들을 성 엘민학원으로 모이게 한 그 때였다"
CALL MESSAGE_WINDOW_D, "？？？", "/　　　　도　망　치　지　못　한　다"
CALL MESSAGE_WINDOW_D, "", "＞어디서부터 들려오는지 모를 목소리가 울려퍼지고、/＞세계가 급속하게 변질되어간다……"
CALL MESSAGE_WINDOW_D, "", "………/……/…"
CALL MESSAGE_WINDOW_D, "", @"＞이곳은 교실……인 것일까？모여있을 터인 사람들이 단 한명도 보이지 않는다。/＞……이정도로 빠르게 이계화가 발생한 것을 봤을때、원인이 되는 악마는 어지간히 강력할 것으로 추정된다。/＞미카게쵸에서의 마지막 임무가 결코 쉽지않게 된 것을 확신하며、/＞%CALLNAME:MASTER%는 다시 한번 기합을 넣었다。"

;=======================================================================
;指定したマスに進入가능か
;=======================================================================
@CAN_ENTER_66,ARG,ARG:1
CALL CAN_ENTER,ARG,ARG:1
RETURN RESULT
;=======================================================================
;フ로어데이터
;=======================================================================
@MAKE_FLOOR_66
SELECTCASE FLAG:현M
	CASE 0
	;１階
		FLAG:최대X = 15
		FLAG:최대Y = 15
;X座標をこんな形でふっとくと、見やすいかもしれません
;				 	 012345678901234
		CALL MAKE_FLOOR_LINE, 0,"000090090000000"
		CALL MAKE_FLOOR_LINE, 1,"000111111100000"
		CALL MAKE_FLOOR_LINE, 2,"010100000111110"
		CALL MAKE_FLOOR_LINE, 3,"012100000000000"
		CALL MAKE_FLOOR_LINE, 4,"010100000000000"
		CALL MAKE_FLOOR_LINE, 5,"000100000000000"
		CALL MAKE_FLOOR_LINE, 6,"010111100000000"
		CALL MAKE_FLOOR_LINE, 7,"012100100000000"
		CALL MAKE_FLOOR_LINE, 8,"010100100000000"
		CALL MAKE_FLOOR_LINE, 9,"000100100000000"
		CALL MAKE_FLOOR_LINE,10,"010100101111110"
		CALL MAKE_FLOOR_LINE,11,"012100001000200"
		CALL MAKE_FLOOR_LINE,12,"010100001001110"
		CALL MAKE_FLOOR_LINE,13,"000111111101110"
		CALL MAKE_FLOOR_LINE,14,"000000000000000"

		;宝箱の設置
		CALL SET_TILE,6, 10, 던전플래그:66:2 ,0, 13
		
		;이벤트の設置(Bマーケット)
		CALL SET_TILE,1,3,던전플래그:66:8,0,74
	CASE 1
	;２階
		FLAG:최대X = 15
		FLAG:최대Y = 15
;X座標をこんな形でふっとくと、見やすいかもしれません
;				 	 012345678901234
		CALL MAKE_FLOOR_LINE, 0,"000000000000000"
		CALL MAKE_FLOOR_LINE, 1,"000111111100110"
		CALL MAKE_FLOOR_LINE, 2,"012101000101100"
		CALL MAKE_FLOOR_LINE, 3,"010101000101000"
		CALL MAKE_FLOOR_LINE, 4,"012101010111000"
		CALL MAKE_FLOOR_LINE, 5,"000101110001100"
		CALL MAKE_FLOOR_LINE, 6,"011100010000110"
		CALL MAKE_FLOOR_LINE, 7,"010010000000019"
		CALL MAKE_FLOOR_LINE, 8,"010010000000010"
		CALL MAKE_FLOOR_LINE, 9,"011011000000019"
		CALL MAKE_FLOOR_LINE,10,"001111001110010"
		CALL MAKE_FLOOR_LINE,11,"011001000100000"
		CALL MAKE_FLOOR_LINE,12,"001000001110000"
		CALL MAKE_FLOOR_LINE,13,"001111111010000"
		CALL MAKE_FLOOR_LINE,14,"000090090000000"

		;宝箱の設置
		CALL SET_TILE,1, 3, 던전플래그:66:3 ,0, 23
		;이벤트の設置(病院)
		CALL SET_TILE,13,1,던전플래그:66:9,0,84
	CASE 2
	;3階
		FLAG:최대X = 15
		FLAG:최대Y = 15
;X座標をこんな形でふっとくと、見やすいかもしれません
;				 	 012345678901234
		CALL MAKE_FLOOR_LINE, 0,"000000000000000"
		CALL MAKE_FLOOR_LINE, 1,"000000011001110"
		CALL MAKE_FLOOR_LINE, 2,"011110110001110"
		CALL MAKE_FLOOR_LINE, 3,"010011100000200"
		CALL MAKE_FLOOR_LINE, 4,"000001000111110"
		CALL MAKE_FLOOR_LINE, 5,"001111111100000"
		CALL MAKE_FLOOR_LINE, 6,"011000001000000"
		CALL MAKE_FLOOR_LINE, 7,"910000011100000"
		CALL MAKE_FLOOR_LINE, 8,"010011110111110"
		CALL MAKE_FLOOR_LINE, 9,"910010000010100"
		CALL MAKE_FLOOR_LINE,10,"010011000010100"
		CALL MAKE_FLOOR_LINE,11,"010001111110100"
		CALL MAKE_FLOOR_LINE,12,"010000020000200"
		CALL MAKE_FLOOR_LINE,13,"010001111110100"
		CALL MAKE_FLOOR_LINE,14,"000000000000000"

;(히-호-군)
		;이벤트の設置
		CALL SET_TILE,12,1,던전플래그:66:4,0,14
		;이벤트の設置(아야세함락)
		CALL SET_TILE,12,13,던전플래그:66:5,0,44
		;이벤트の設置
		CALL SET_TILE,12,1,던전플래그:66:4,1,34

	CASE 3
	;4階
		FLAG:최대X = 15
		FLAG:최대Y = 15
;X座標をこんな形でふっとくと、見やすいかもしれません
;				 	 012345678901234
		CALL MAKE_FLOOR_LINE, 0,"000000000000000"
		CALL MAKE_FLOOR_LINE, 1,"011100121010110"
		CALL MAKE_FLOOR_LINE, 2,"010111100012110"
		CALL MAKE_FLOOR_LINE, 3,"010100001010110"
		CALL MAKE_FLOOR_LINE, 4,"010111101010000"
		CALL MAKE_FLOOR_LINE, 5,"010000101110000"
		CALL MAKE_FLOOR_LINE, 6,"010000101000000"
		CALL MAKE_FLOOR_LINE, 7,"012110111111110"
		CALL MAKE_FLOOR_LINE, 8,"010110000000010"
		CALL MAKE_FLOOR_LINE, 9,"010110000000010"
		CALL MAKE_FLOOR_LINE,10,"010110000000010"
		CALL MAKE_FLOOR_LINE,11,"012110000000010"
		CALL MAKE_FLOOR_LINE,12,"010000000000010"
		CALL MAKE_FLOOR_LINE,13,"011111111001110"
		CALL MAKE_FLOOR_LINE,14,"000909000000000"

		;이벤트の設置
		CALL SET_TILE,13,2,던전플래그:66:4,1,24


	CASE 4
	;5階
		FLAG:최대X = 15
		FLAG:최대Y = 15
;X座標をこんな形でふっとくと、見やすいかもしれません
;				 	 012345678901234
		CALL MAKE_FLOOR_LINE, 0,"000909000000000"
		CALL MAKE_FLOOR_LINE, 1,"011111100000000"
		CALL MAKE_FLOOR_LINE, 2,"010000000000000"
		CALL MAKE_FLOOR_LINE, 3,"011111100000000"
		CALL MAKE_FLOOR_LINE, 4,"010000110000000"
		CALL MAKE_FLOOR_LINE, 5,"010110100000000"
		CALL MAKE_FLOOR_LINE, 6,"010100000000000"
		CALL MAKE_FLOOR_LINE, 7,"011101000000000"
		CALL MAKE_FLOOR_LINE, 8,"001001001111170"
		CALL MAKE_FLOOR_LINE, 9,"001001101000000"
		CALL MAKE_FLOOR_LINE,10,"001100101011110"
		CALL MAKE_FLOOR_LINE,11,"000101111110010"
		CALL MAKE_FLOOR_LINE,12,"010100010000010"
		CALL MAKE_FLOOR_LINE,13,"011111110111110"
		CALL MAKE_FLOOR_LINE,14,"000000000000000"
		;이벤트の設置(에리함락)
		CALL SET_TILE,9,13,던전플래그:66:6,0,54
	CASE 5
	;6階
		FLAG:최대X = 15
		FLAG:최대Y = 15
;X座標をこんな形でふっとくと、見やすいかもしれません
;				 	 012345678901234
		CALL MAKE_FLOOR_LINE, 0,"000000000000000"
		CALL MAKE_FLOOR_LINE, 1,"000011101111000"
		CALL MAKE_FLOOR_LINE, 2,"000011121001000"
		CALL MAKE_FLOOR_LINE, 3,"000011101001000"
		CALL MAKE_FLOOR_LINE, 4,"000000001000000"
		CALL MAKE_FLOOR_LINE, 5,"000011101000000"
		CALL MAKE_FLOOR_LINE, 6,"000011121000000"
		CALL MAKE_FLOOR_LINE, 7,"000011101000000"
		CALL MAKE_FLOOR_LINE, 8,"000000001011160"
		CALL MAKE_FLOOR_LINE, 9,"011111111010000"
		CALL MAKE_FLOOR_LINE,10,"010000001010000"
		CALL MAKE_FLOOR_LINE,11,"010111101110000"
		CALL MAKE_FLOOR_LINE,12,"012111100000000"
		CALL MAKE_FLOOR_LINE,13,"010111100000000"
		CALL MAKE_FLOOR_LINE,14,"000000000000000"
		;이벤트の設置(ゆきの함락)
		CALL SET_TILE,4,2,던전플래그:66:7,0,64
		;이벤트の設置(BOSS)
		CALL SET_TILE,5,12,던전플래그:66:10,0,94
	CASEELSE

ENDSELECT



;=======================================================================
;[5]조사　実行時の이벤트
;=======================================================================
@EVENT_CHECK_DUNGEON_66

;==========
;出입の処理
;==========
IF DA:(FLAG:현X):(FLAG:현Y) == 8
	CALL DUNGEON_EXIT
	RETURN 1
;========
;宝の処理
;========
;% 10は10で割ったあまり、つまり下一桁がでてきます
;그리고、下一桁はタイルの종류を表す
ELSEIF DA:(FLAG:현X):(FLAG:현Y) % 10 == 3
	CALL TREASURE_66
	RETURN RESULT
;=======
;階段
;=======
ELSEIF DA:(FLAG:현X):(FLAG:현Y) == 6
	CALL UPSTAIRS_66
	RETURN RESULT

ELSEIF DA:(FLAG:현X):(FLAG:현Y) == 7
	CALL DOWNSTAIRS_66
	RETURN RESULT
ELSE
	PRINTW 아무 것도 없는 것같다
	RETURN 0
ENDIF

;=======================================================================
;タイル進入時の이벤트
;=======================================================================
@EVENT_ENTER_DUNGEON_66,ARG
;ARG = 進入時の向き　0の場合ワープなど
;==========
;出입の処理
;==========
IF DA:(FLAG:현X):(FLAG:현Y) % 10 == 8
	CALL DUNGEON_EXIT
	RETURN 1
;==========
;マップ遷移の処理
;==========
ELSEIF DA:(FLAG:현X):(FLAG:현Y) == 9
	SELECTCASE FLAG:현M
		CASE 0
			IF FLAG:현Y == 0
				FLAG:현M = 1
				FLAG:현Y = 14
			ENDIF
		CASE 1
			IF FLAG:현Y == 14
				FLAG:현M = 0
				FLAG:현Y = 0
			ELSE
				FLAG:현M = 2
				FLAG:현X = 0
			ENDIF
		CASE 2
			IF FLAG:현X == 0
				FLAG:현M = 1
				FLAG:현X = 14
			ENDIF
		CASE 3
			IF FLAG:현Y == 14
				FLAG:현M = 4
				FLAG:현Y = 0
			ENDIF
		CASE 4
			IF FLAG:현Y == 0
				FLAG:현M = 3
				FLAG:현Y = 14
			ENDIF

	ENDSELECT
	CALL MAKE_FLOOR, FLAG:현던전
	CALL AUTOMAP
	RETURN 1
;========
;宝の処理
;========
ELSEIF DA:(FLAG:현X):(FLAG:현Y) % 10 == 3
	CALL TREASURE_66
	RETURN RESULT
;=======
;階段
;=======
ELSEIF DA:(FLAG:현X):(FLAG:현Y) % 10 == 6
	CALL UPSTAIRS_66
	RETURN RESULT

ELSEIF DA:(FLAG:현X):(FLAG:현Y) % 10 == 7
	CALL DOWNSTAIRS_66
	RETURN RESULT

;==========
;扉の処理
;==========
ELSEIF DA:(FLAG:현X):(FLAG:현Y) % 10 == 2
	CALL DUNGEON_DOOR,ARG
	RETURN 1


;========================
;이벤트
;========================
ELSEIF DA:(FLAG:현X):(FLAG:현Y) % 10 == 4

	SELECTCASE DA:(FLAG:현X):(FLAG:현Y) /10
		CASE 1
			CUSTOMDRAWLINE =
			CALL MESSAGE_WINDOW_D, "", "＞그곳에는、2마리의 잭프로스트가 있었다/＞한쪽은、남자 교복을 껴입고、학생모까지 쓰고있다。/＞다른 쪽은 맙소사 세일러복이다……。"
			CALL MESSAGE_WINDOW_D, "잭프로스트？", "음、너희들은 학생으로는 보이지않는구나호？/학생도 아닌데、학교에는 무슨 일로 왔냐호？"
			CALL MESSAGE_WINDOW_D, "", "＞……사정을 설명해주니、/＞잭프로스트는 납득한 듯 크게 고개를 끄덕였다。"
			CALL MESSAGE_WINDOW_D, "잭프로스트？", "그렇군호～/그래서、모처럼 학교에 왔는데 학생이 아무도 없는 것이었구나호/이래서야、학교에서 친구를 만들겠다는 계획이 엉망이다호/…그렇지만 해결해준다면、협력하겠다호"
			CALL MESSAGE_WINDOW_D, "잭프로스트？", "따라와라호"
			CALL MESSAGE_WINDOW_D, "", @"＞히ー호ー군이라고 이름을 밝힌 잭프로스트의 말에 따르면、/＞이 앞으로 나아가기 위한 비밀통로는 개통과 유지에 특수한 마력이 필요하여、/＞%CALLNAME:MASTER%나、%CALLNAME:MASTER%의 동료마들로써는 지나갈 방법이 없다고 한다。"
			CALL MESSAGE_WINDOW_D, "히ー호ー군", "그럼、나는 아래층으로 돌아갈게호/여기에는 마이 하니ー히호코양이 남을테니、/돌아가고 싶을 때는 말해줘호"
			;ゆきのがパーティにいて、함락している
			IF FINDCHARA_B([[キャラ:유키노상]])== 2 && 함락(RESULT:1) && ABL:(RESULT:1):초기페르소나 != [[キャラ:두르가(페르소나)]]
				CALL MESSAGE_WINDOW_D, "히ー호ー군", "……아、참。/방금、이런걸 주웠다호/아마、너희들이 가지고 있는 편이 도움이 될 것 같다는 생각이 든다호"
				CALL MESSAGE_WINDOW_D, "", "＞히ー호ー군은 마침 떠오랐다는 듯이 말하며、/＞주머니에서 무언가를 꺼내서 쥐어줬다。"
				;ゆきの초기페르소나バージョンアップ
				CALL MESSAGE_WINDOW_D, "", "＞유키노가 받아들인 그것은 들소의 뿔로 만든 장식물처럼 보인다。/＞직후、유키노의 뒤쪽에서 그녀의 페르소나「베스타」가 나타났다。/＞뿔은 불타오르듯 빛을 내뿜으며、베스타에게 흡수되듯 사라졌다。"
				CALL MESSAGE_WINDOW_D, "", "＞유키노의 초기페르소나가 성장했다！"
				ABL:(RESULT:1):초기페르소나 = [[キャラ:두르가(페르소나)]]
				CALL SYNC_STATUS, RESULT:1
			ENDIF
			IF TALENT:MASTER:140
				CALL MESSAGE_WINDOW_D, "히ー호ー군", "……그렇지만、히호코양이 아무리 귀엽다고 해도 손을 댔다간 용서하지 않겠어호"
			ELSE
				CALL MESSAGE_WINDOW_D, "히ー호ー군", "그렇지만、아무리 도움이 된다고해도、나에게 반해버리면 안된다호"
			ENDIF
			CALL MESSAGE_WINDOW_D, "", "＞그렇게 말하곤、히ー호ー군은 아주 흥겨운듯 돌아갔다。"
			FLAG:현M = 3
			FLAG:현X = 13
			FLAG:현Y = 2
			던전플래그:66:4 = 1
			CALL MAKE_FLOOR, FLAG:현던전
			CALL AUTOMAP
			RETURN 1
		CASE 2
			CUSTOMDRAWLINE =
			CALL MESSAGE_WINDOW_D, "", "＞그곳에는、세일러복을 억지로 쑤셔입은 잭프로스트가 있었다。"
			CALL MESSAGE_WINDOW_D, "히호코양", "저쪽으로 돌아갈거야호？/그럼 따라와호！"
			FLAG:현M = 2
			FLAG:현X = 12
			FLAG:현Y = 1
			CALL MAKE_FLOOR, FLAG:현던전
			CALL AUTOMAP
		CASE 3
			CUSTOMDRAWLINE =
			CALL MESSAGE_WINDOW_D, "", "＞그곳에는、교복을 입은 잭프로스트가 있었다。"
			CALL MESSAGE_WINDOW_D, "히ー호ー군", "윗층으로 갈거야호？/그럼 따라와호！"
			;ゆきのがパーティにいて、함락している
			IF FINDCHARA_B([[キャラ:유키노상]])== 2 && 함락(RESULT:1) && ABL:(RESULT:1):초기페르소나 != [[キャラ:두르가(페르소나)]]
				CALL MESSAGE_WINDOW_D, "히ー호ー군", "……아、참。/방금、이런걸 주웠다호/아마、너희들이 가지고 있는 편이 도움이 될 것 같다는 생각이 든다호"
				CALL MESSAGE_WINDOW_D, "", "＞히ー호ー군은 마침 떠오랐다는 듯이 말하며、/＞주머니에서 무언가를 꺼내서 쥐어줬다。"
				;ゆきの초기페르소나バージョンアップ
				CALL MESSAGE_WINDOW_D, "", "＞유키노가 받아들인 그것은 들소의 뿔로 만든 장식물처럼 보인다。/＞직후、유키노의 뒤쪽에서 그녀의 페르소나「베스타」가 나타났다。/＞뿔은 불타오르듯 빛을 내뿜으며、베스타에게 흡수되듯 사라졌다。"
				CALL MESSAGE_WINDOW_D, "", "＞유키노의 초기페르소나가 성장했다！"
				ABL:(RESULT:1):초기페르소나 = [[キャラ:두르가(페르소나)]]
				CALL SYNC_STATUS, RESULT:1
			ENDIF
			FLAG:현M = 3
			FLAG:현X = 13
			FLAG:현Y = 2
			CALL MAKE_FLOOR, FLAG:현던전
			CALL AUTOMAP
		CASE 4
;아야세がパーティにいて、함락している
			IF FINDCHARA_B([[キャラ:아야세]])== 2 && 함락(RESULT:1) && 던전플래그:66:5 == 0
				CALL MESSAGE_WINDOW_D, "아야세", @"어머？//이것 봐봐、%CALLNAME:MASTER%ー？"
				CALL MESSAGE_WINDOW_D, "", @"＞%CALLNAME:MASTER%가 뒤돌아보니、/＞복도 구석에 쭈그려 앉은 아야세가 무언가를 줏어들었다。/＞……깨진 거울의 파편인 듯하다。"
				CALL MESSAGE_WINDOW_D, "", @"＞%CALLNAME:MASTER%가 미처 던져버리라고 지시하기도 전에、아야세의 손 안에서 그것이 빛을 발하기 시작했다。/＞……빛이 사그라들 무렵、아야세의 손에는 한 장의 가면이 올려져있엇다。/＞그 표면은 마치 거울처럼 빛을 반사하고 있었지만、신기하게도 그것을 착용해도 시야가 가려지지는 않았다。/＞아야세는 얼마간 이런저런 각도로 비춰본 뒤、"
				CALL MESSAGE_WINDOW_D, "아야세", "으음～、뭔지는 모르겠지만、/쓸모가 있는…걸까？"
				CALL MESSAGE_WINDOW_D, "", @"＞고개를 갸웃거리며、가면을 %CALLNAME:MASTER%에게 건냈다。"
				CALL MESSAGE_WINDOW_D, "", "＞슈피겔마스크를 입수했다。"
				ITEM:슈피겔마스크 += 1
				던전플래그:66:5 = 1
			ELSE
				CALL MESSAGE_WINDOW_D, "", "＞그곳에는、아무것도 없다。"
			ENDIF
		CASE 5
;에리がパーティにいて、함락している
			IF FINDCHARA_B([[キャラ:에리]])== 2 && 함락(RESULT:1) && 던전플래그:66:6 == 0
				CALL MESSAGE_WINDOW_D, "에리", "어머？/이건……mirror？"
				CALL MESSAGE_WINDOW_D, "", @"＞%CALLNAME:MASTER%가 뒤돌아보니、/＞에리가 발치에서 굴러다니던 무언가를 줏어들었다。/＞……깨진 거울의 파편인 듯하다。"
				CALL MESSAGE_WINDOW_D, "", @"＞%CALLNAME:MASTER%가 미처 던져버리라고 지시하기도 전에、에리의 손 안에서 그것이 빛을 발하기 시작했다。/＞……빛이 사그라들 무렵、에리의 손안에는 한자루의 검이 있엇다。/＞마치 유리를 잘게 깨뜨려 만든것처럼 생겼지만、유리같이 약한 재질은 아닌 것 같다。/＞에리는 확인해보듯 한두번 휘둘러보곤、"
				CALL MESSAGE_WINDOW_D, "에리", "……판단은 맡기도록 하겠지만、실용성은 있는듯 하네요"
				CALL MESSAGE_WINDOW_D, "", @"＞그리 말하곤、검을 %CALLNAME:MASTER%에게 건냈다。"
				CALL MESSAGE_WINDOW_D, "", "＞슈피겔블레이드를 입수했다。"
				ITEM:슈피겔블레이드 += 1
				던전플래그:66:6 = 1
			ELSE
				CALL MESSAGE_WINDOW_D, "", "＞그곳에는、아무것도 없다。"
			ENDIF
		CASE 6
;ゆきのがパーティにいて、함락している
			IF FINDCHARA_B([[キャラ:유키노상]])== 2 && 함락(RESULT:1) && 던전플래그:66:7 == 0
				CALL MESSAGE_WINDOW_D, "유키노", "음、……이건 뭐지？"
				CALL MESSAGE_WINDOW_D, "", @"＞%CALLNAME:MASTER%가 뒤돌아보니、/＞유키노가 창틀에 있던 무언가를 집어들었다。/＞……깨진 거울의 파편인 듯하다。"
				CALL MESSAGE_WINDOW_D, "", @"＞%CALLNAME:MASTER%가 미처 던져버리라고 지시하기도 전에、유키노의 손 안에서 그것이 빛을 발하기 시작했다。/＞……빛이 사그라들 무렵、유키노의 손위에는 한벌의 갑옷이 있엇다。/＞그 표면은、마치 잘 닦은 거울처럼 빛나고 있다。/＞유키노는 그 갑옷을 몇번 콩콩 두들겨 보고는、"
				CALL MESSAGE_WINDOW_D, "유키노", "……쓸만한걸까、이거？"
				CALL MESSAGE_WINDOW_D, "", @"＞유키노는、갑옷을 %CALLNAME:MASTER%에게 건냈다。"
				CALL MESSAGE_WINDOW_D, "", "＞슈피겔메일을 입수했다。"
				ITEM:슈피겔메일 += 1
				던전플래그:66:7 = 1
			ELSE
				CALL MESSAGE_WINDOW_D, "", "＞그곳에는、아무것도 없다。"
			ENDIF
		CASE 7
;救出의뢰2をクリアしてる
			IF 의뢰플래그:16:0 >= 1 && 던전플래그:66:8 == 0
				CALL MESSAGE_WINDOW_D, "", @"＞%CALLNAME:MASTER%의 시야 한 구석에 무언가 빛나고 있는것이 보였다。"
				CALL MESSAGE_WINDOW_D, "", @"＞……줏어들어보니 깨진 거울의 파편같은 모양이다。/＞%CALLNAME:MASTER%가 버리려고 하자、손안에서 그것이 빛을 발하기 시작했다。/＞……빛이 사그라들 무렵、손안에는 거울 파편 대신 방호구가 있었다。/＞그 표면은、마치 잘 닦은 거울처럼 빛나고 있다。"
				CALL MESSAGE_WINDOW_D, "", "＞슈피겔쉴드를 입수했다。"
				ITEM:슈피겔쉴드 += 1
				던전플래그:66:8 = 1
			ELSE
				CALL MESSAGE_WINDOW_D, "", "＞그곳에는、아무것도 없다。"
			ENDIF
		CASE 8
;救出의뢰3をクリアしてる
			IF 의뢰플래그:16:0 == 2 && 던전플래그:66:9 == 0
				CALL MESSAGE_WINDOW_D, "", @"＞%CALLNAME:MASTER%의 시야 한 구석에 무언가 빛나고 있는것이 보였다。"
				CALL MESSAGE_WINDOW_D, "", @"＞……줏어들어보니 깨진 거울의 파편같은 모양이다。/＞%CALLNAME:MASTER%가 버리려고 하자、손안에서 그것이 빛을 발하기 시작했다。/＞……빛이 사그라들 무렵、손안에는 거울 파편 대신 신발이 있었다。/＞그 표면은、마치 잘 닦은 거울처럼 빛나고 있다。"
				CALL MESSAGE_WINDOW_D, "", "＞슈피겔바인을 입수했다。"
				ITEM:슈피겔바인 += 1
				던전플래그:66:9 = 1
			ELSE
				CALL MESSAGE_WINDOW_D, "", "＞그곳에는、아무것도 없다。"
			ENDIF
		CASE 9
;BOSS　아수라여왕
			CALL MESSAGE_WINDOW_D, "", "＞이곳이 이계의 최심부인 듯하다。/＞그곳에는、머리가 3개 달린 거대한 여성이 기다리고 있었다。/＞마주서고 있는 것만으로도 느껴지는 중압감은、/＞눈앞의 존재가 이계화의 원흉이라는 사실을 확신하기에 충분한 수준이었다。"
			CALL MESSAGE_WINDOW_D, "？？？", "……어째서지？/이곳은 나의 세계인데……/나에게는 이곳밖에 없는……/이곳에서쯤은 원하는대로 하게 해줘도 괜찮잖아！"
			CALL MESSAGE_WINDOW_D, "", "＞이녀석에게 무슨 사정이 있는지는 알 수 없지만、/＞이녀석으로 인해서 갇혀있다는 사실과、/＞이 녀석을 어떻게든 하지 않으면、/＞다수의 비전투원을 탈출시키는 것이 불가능하다는 것만은 확실하다。"
			CALL MESSAGE_WINDOW_D, "", "/　　　마왕 아수라여왕이 １체 나타났다！"
			CUSTOMDRAWLINE =
			WAIT
			FLAG:도주불가플래그 = 1
			FLAG:회화불능플래그 = 1
			FLAG:선제기습취소 = 1
			CALL SET_ENEMY,9,[[キャラ:아수라여왕]], 70, 0, 1
			NAME:(CHARANUM-1) = アシュラ女王
			CALLNAME:(CHARANUM-1) = アシュラ女王
			CFLAG:(CHARANUM-1):ＨＰ보정 = 3000
			CALL SYNC_STATUS,(CHARANUM-1)
			CALL HEALTH_CHARA,(CHARANUM-1)
			CFLAG:(CHARANUM-1):행동횟수 = 2
			CSTR:(CHARANUM-1):사고패턴 = 222
			CALL BATTLE_START
			FLAG:도주불가플래그 = 0
			FLAG:회화불능플래그 = 0
			FLAG:선제기습취소 = 0
			CALL MESSAGE_WINDOW_D, "아수라여왕", "……어째…서……"
			CALL MESSAGE_WINDOW_D, "", "＞쥐어짜내듯 한마디만을 토해내고、아수라여왕은 무너져내리며 사라져갔다。/＞그와 동시에 주변의 이계화가 풀려져간다……/＞이것으로、이 이상의 방해는 들어오지 않을 것이다。"
		CALL MESSAGE_WINDOW_D, "", "…………/………/……/…"
		CALL MESSAGE_WINDOW_D, "", @"＞%CALLNAME:MASTER%의 사무소"
		;마요네ＧＥＴ済み
			IF 이벤트플래그:1:0 == 3
				CALL MESSAGE_WINDOW_D, "간부", "보고는 읽어보았다。//……실로 훌륭한 일을 해주었다。"
				CALL MESSAGE_WINDOW_D, "간부", "자네가 확보해준 DEVA 시스템은、/새로이 전용 부서를 설립하여 연구하도록 결정됐다。/그리고、자네가 구출해낸 주민들 중에서/이쪽에 이런저런 형태로 협력을 해줄만한 사람도 생겨날 듯하다。"
				CALL MESSAGE_WINDOW_D, "", @"＞%CALLNAME:MASTER%의 보고서를 받아들인 팬텀・소사이어티의 간부는、/＞만족스럽다는듯 말하고 전화를 끊었다。"
			ELSE
				CALL MESSAGE_WINDOW_D, "마요네", "DEVA시스템은 귀중한 샘플로써、이쪽에서 확보하게 되었습니다。//……대단한 성과를 거두셨군요。"
				CALL MESSAGE_WINDOW_D, "마요네", "이미 윗쪽에서는 전용 부서를 설립하는 쪽으로 이야기가 진행되고 있다는 듯하네요。/다수의 주민들을 구출해낸 것도 높이 평가받을만 하네요。/그 중에는 재산이나 권력을 가진 사람도 있고。"
				CALL MESSAGE_WINDOW_D, "", @"＞%CALLNAME:MASTER%의 보고서를 받아들인 마요네는、/＞만족스럽다는듯 말하고 전화를 끊었다。"
			ENDIF
			CALL MESSAGE_WINDOW_D, "", @"＞이번건으로 조직내에서 %CALLNAME:MASTER%의 입장은 상당히 좋게 변할 것이다。/＞이후로 어떻게 처신할지를 생각하면서、%CALLNAME:MASTER%는 모아둔 서류들을 훑어보기 시작했다……"
	;地下鉄侵入禁止
			던전플래그:11:7 = 1
;			CALL MESSAGE_WINDOW_D, "", "/―――여신이문록 페르소나 어나더 엔드―――"
			던전플래그:66:1 = 1
;
		IF DAY < 51
			CALL MESSAGE_WINDOW_D, "", "/Ending No.029 (여신이문록 페르소나　눈의 여왕편 엔드　be your another mind)"
			FLAG:5 = 9
			SETBIT FLAG:취소된ED,29
			SETBIT FLAG:발견ED,29
			FLAG:탈출 = 1
			PRINTFORML [0]끝낸다 [1]계속한다 [2]일부의 데이터를 이어받아、새로 시작
			CALL INPUTINT,0, 1, 2
			IF RESULT == 0
				QUIT
			ELSEIF RESULT == 1
				CALL REQUEST_50_DAY_END
			ELSEIF RESULT == 2
				CALL START_NEWGAME
				RETURN 1
			ENDIF
		ENDIF
			CALL MESSAGE_WINDOW_D, "", "＞이번 임무의 공적으로、/＞￥1000000　조직기여도 500000　명성600/＞을 얻었습니다。"
			MONEY += 1000000
			FLAG:조직공헌도 += 500000
			FLAG:명성 += 600
			FLAG:탈출 = 1
	ENDSELECT
ENDIF
RETURN 0

;=======================================================================
;인카운트율
;=======================================================================
@ENCOUNT_RATE_66
FLAG:인카운트율 = FLAG:미조우걸음수*5
SIF FLAG:미조우걸음수 < 5
	FLAG:인카운트율 = 0

;=======================================================================
;エンカウント処理
;=======================================================================
@CHECK_ENCOUNT_66
IF RAND:100 < FLAG:인카운트율
	CALL ENEMY_TABLE
	RETURN 1
ELSE
	FLAG:미조우걸음수 += 1
	RETURN 0
ENDIF
;=======================================================================
;적の종족の종류数
;=======================================================================
@CLASS_NUM_66
RETURN CLASS_NUM_COMMON("最上級")
;=======================================================================
;적の総数
;ARGは出現する적の종류です
;=======================================================================
@ENEMY_NUM_66, ARG
RETURN ENEMY_NUM_COMMON("最上級", ARG)
;=======================================================================
;적の종류
;=======================================================================
@ENEMY_66, ARG
SELECTCASE RAND:100
	CASE IS < 9
		RETURN [[キャラ:옵신]], 55
	CASE IS < 18
		RETURN [[キャラ:그리드]], 56
	CASE IS < 27
		RETURN [[キャラ:질러시]], 57
	CASE IS < 36
		RETURN [[キャラ:벨리커시티]], 58
	CASE IS < 45
		RETURN [[キャラ:레이지니스]], 59
	CASE IS < 54
		RETURN [[キャラ:앨러건스]], 60
	CASE IS < 63
		RETURN 356, 56
	CASE IS < 72
		RETURN 706, 55
	CASE IS < 81
		RETURN 656, 56
	CASE IS < 90
		;9%　사룡무슈후슈LV48(55) 
		RETURN [[キャラ:무슈후슈]], 55
	CASEELSE
		RETURN 408, 56
ENDSELECT
	


;=======================================================================
;宝箱の中身
;=======================================================================
@TREASURE_66
;/10はIDを10で割る。つまり、下一桁をなくして、二桁눈と三桁눈を二桁の数字として取り出している
SELECTCASE DA:(FLAG:현X):(FLAG:현Y) / 10
			;IDを示しています。つまり、これはIDが1のとき、2の時で分岐
			CASE 1
				;GET_TREASURE,아이템번호、입수個数、던전ナンバー、あけたときONにするフラグの번호
				;1001は외상약で、それを1個、던전ナンバーは宝箱あけるときはよその던전をあけることがないだろうのでFLAG:현던전が無難です
				;그리고、フラグは던전플래그:1(에코빌딩):0を1にするということです
				;MAPをつくるときにこの宝箱は던전플래그:1(에코빌딩):0が0のときしか置かないことになってるのでこれで消えます
				CALL GET_TREASURE,[[아이템:챠크라포트]],1,FLAG:현던전,2
			CASE 2
				CALL GET_TREASURE,[[아이템:보옥륜]],1,FLAG:현던전,3
ENDSELECT
RETURN 1

;=======================================================================
;階段置き場
;=======================================================================
@UPSTAIRS_66
SELECTCASE FLAG:현M
	CASE 5
		CALL DUNGEON_UPSTAIRS,4,FLAG:현X,FLAG:현Y
	CASEELSE
ENDSELECT
RETURN 1

@DOWNSTAIRS_66
SELECTCASE FLAG:현M
	CASE 4
		CALL DUNGEON_UPSTAIRS,5,FLAG:현X,FLAG:현Y
	CASEELSE
ENDSELECT
RETURN 1


;女王사고패턴
@SET_ACTION_222,ARG
IF RAND:3 == 0
	LOCAL = 0
ELSEIF RAND:2 == 0
	LOCAL = 1
ELSE
	LOCAL = 2
ENDIF

IF LOCAL == 0 && CFLAG:ARG:행동한횟수 == 0
	MAXBASE:ARG:40 = 100
	MAXBASE:ARG:41 = 100
	MAXBASE:ARG:42 = 100
	MAXBASE:ARG:43 = 100
	MAXBASE:ARG:44 = 100
	MAXBASE:ARG:45 = 100
	MAXBASE:ARG:46 = 100
	MAXBASE:ARG:47 = 100
	MAXBASE:ARG:52 = 100
	MAXBASE:ARG:53 = 100
	MAXBASE:ARG:54 = 100
	MAXBASE:ARG:55 = 100
	MAXBASE:ARG:56 = 100
ELSEIF LOCAL == 1 && CFLAG:ARG:행동한횟수 == 0
	IF RAND:4 == 0
		MAXBASE:ARG:40 = 0
	ELSE
		MAXBASE:ARG:40 = 50
		IF RAND:3 == 0
			MAXBASE:ARG:41 = 0
		ELSE
			MAXBASE:ARG:41 = 50
			IF RAND:2 == 0
				MAXBASE:ARG:42 = 0
				MAXBASE:ARG:43 = 50
			ELSE
				MAXBASE:ARG:42 = 50
				MAXBASE:ARG:43 = 0
			ENDIF
		ENDIF
	ENDIF
	IF RAND:4 == 0
		MAXBASE:ARG:44 = 150
		MAXBASE:ARG:45 = 150
		MAXBASE:ARG:46 = 100
		MAXBASE:ARG:47 = 100
		MAXBASE:ARG:52 = 100
		MAXBASE:ARG:53 = 100
		MAXBASE:ARG:54 = 100
		MAXBASE:ARG:55 = 100
		MAXBASE:ARG:56 = 100
	ELSEIF RAND:3 == 0
		MAXBASE:ARG:44 = 100
		MAXBASE:ARG:45 = 100
		MAXBASE:ARG:46 = 150
		MAXBASE:ARG:47 = 150
		MAXBASE:ARG:52 = 100
		MAXBASE:ARG:53 = 100
		MAXBASE:ARG:54 = 100
		MAXBASE:ARG:55 = 100
		MAXBASE:ARG:56 = 100
	ELSEIF RAND:2 == 0
		MAXBASE:ARG:44 = 100
		MAXBASE:ARG:45 = 100
		MAXBASE:ARG:46 = 100
		MAXBASE:ARG:47 = 100
		MAXBASE:ARG:52 = 150
		MAXBASE:ARG:53 = 100
		MAXBASE:ARG:54 = 150
		MAXBASE:ARG:55 = 100
		MAXBASE:ARG:56 = 100
	ELSE
		MAXBASE:ARG:44 = 100
		MAXBASE:ARG:45 = 100
		MAXBASE:ARG:46 = 100
		MAXBASE:ARG:47 = 100
		MAXBASE:ARG:52 = 100
		MAXBASE:ARG:53 = 150
		MAXBASE:ARG:54 = 100
		MAXBASE:ARG:55 = 100
		MAXBASE:ARG:56 = 150
	ENDIF
ELSEIF LOCAL == 2 && CFLAG:ARG:행동한횟수 == 0
	IF RAND:4 == 0
		MAXBASE:ARG:40 = 150
		MAXBASE:ARG:41 = 100
		MAXBASE:ARG:42 = 120
		MAXBASE:ARG:43 = 100
	ELSEIF RAND:3 == 0
		MAXBASE:ARG:40 = 120
		MAXBASE:ARG:41 = 150
		MAXBASE:ARG:42 = 100
		MAXBASE:ARG:43 = 100
	ELSEIF RAND:2 == 0
		MAXBASE:ARG:40 = 100
		MAXBASE:ARG:41 = 100
		MAXBASE:ARG:42 = 150
		MAXBASE:ARG:43 = 120
	ELSE
		MAXBASE:ARG:40 = 100
		MAXBASE:ARG:41 = 120
		MAXBASE:ARG:42 = 100
		MAXBASE:ARG:43 = 150
	ENDIF
	IF RAND:4 == 0
		MAXBASE:ARG:44 = 0
		MAXBASE:ARG:45 = 0
		MAXBASE:ARG:46 = 50
		MAXBASE:ARG:47 = 50
		MAXBASE:ARG:52 = 50
		MAXBASE:ARG:53 = 50
		MAXBASE:ARG:54 = 50
		MAXBASE:ARG:55 = 50
		MAXBASE:ARG:56 = 50
	ELSEIF RAND:3 == 0
		MAXBASE:ARG:44 = 50
		MAXBASE:ARG:45 = 50
		MAXBASE:ARG:46 = 0
		MAXBASE:ARG:47 = 0
		MAXBASE:ARG:52 = 50
		MAXBASE:ARG:53 = 50
		MAXBASE:ARG:54 = 50
		MAXBASE:ARG:55 = 50
		MAXBASE:ARG:56 = 50
	ELSEIF RAND:2 == 0
		MAXBASE:ARG:44 = 50
		MAXBASE:ARG:45 = 50
		MAXBASE:ARG:46 = 50
		MAXBASE:ARG:47 = 50
		MAXBASE:ARG:52 = 0
		MAXBASE:ARG:53 = 50
		MAXBASE:ARG:54 = 0
		MAXBASE:ARG:55 = 50
		MAXBASE:ARG:56 = 50
	ELSE
		MAXBASE:ARG:44 = 50
		MAXBASE:ARG:45 = 50
		MAXBASE:ARG:46 = 50
		MAXBASE:ARG:47 = 50
		MAXBASE:ARG:52 = 50
		MAXBASE:ARG:53 = 0
		MAXBASE:ARG:54 = 50
		MAXBASE:ARG:55 = 50
		MAXBASE:ARG:56 = 0
	ENDIF
ENDIF
IF CFLAG:ARG:행동한횟수 == 0
	IF CFLAG:ARG:공격강화 < -4 || CFLAG:ARG:명중강화 < -4 || CFLAG:ARG:회피강화 < -4 || CFLAG:ARG:마법위력강화 < -4
		CFLAG:ARG:입력행동 = [[스킬:데・쿤다]]
	ELSEIF RAND:2 == 0
		CFLAG:ARG:입력행동 = [[스킬:랜더마이저]]
	ELSE
		CFLAG:ARG:입력행동 = 0
	ENDIF
ELSEIF CFLAG:ARG:행동한횟수 == 1
	IF RAND:4 == 0
		CFLAG:ARG:입력행동 = [[스킬:파이어스톰]]
	ELSEIF RAND:3 == 0
		CFLAG:ARG:입력행동 = [[스킬:우뢰의세례]]
	ELSEIF RAND:2 == 0
		CFLAG:ARG:입력행동 = [[스킬:절대영도]]
	ELSE
		CFLAG:ARG:입력행동 = [[스킬:선풍진]]
	ENDIF
ELSE
	IF RAND:3 == 0
		CFLAG:ARG:입력행동 = [[스킬:이검난무]]
	ELSEIF RAND:2 == 0
		CFLAG:ARG:입력행동 = [[스킬:아카샤아츠]]
	ELSE
		CFLAG:ARG:입력행동 = 0
	ENDIF
ENDIF
CALL RANDOM_TARGET, ARG, CFLAG:ARG:입력행동

;アクション実行不能なら自動的に통상공격にする
CALL CHECK_ACTIONABLE, ARG, CFLAG:ARG:입력행동
IF RESULT == 0
	CFLAG:ARG:입력행동 = 0
	CALL RANDOM_TARGET, ARG, CFLAG:ARG:입력행동
ENDIF


;=======================================================================
;윤간참가악마
;=======================================================================
@DUNGEON_RAPE_DEVIL_66
;랜덤にどの악마が出るか決定
;RETURN CSV번호 , 人数 , 레벨
SELECTCASE RAND:3
	CASE 0
		RETURN [[キャラ:인큐버스]] , 3 + RAND:10 , CSVBASE([[キャラ:인큐버스]] , GETNUM(BASE , "LV") , 0) + RAND:3
	CASE 1
		RETURN [[キャラ:도미니온]] , 3 + RAND:10 , CSVBASE([[キャラ:도미니온]] , GETNUM(BASE , "LV") , 0) + RAND:3
	CASE 2
		RETURN [[キャラ:베르세르크]] , 3 + RAND:10 , CSVBASE([[キャラ:베르세르크]] , GETNUM(BASE , "LV") , 0) + RAND:3
ENDSELECT




