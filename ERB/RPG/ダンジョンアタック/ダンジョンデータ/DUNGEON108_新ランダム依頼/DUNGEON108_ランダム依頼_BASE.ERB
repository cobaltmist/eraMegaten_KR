;=======================================================================
;フラグ
;의뢰플래그:108:1	受注した依頼
;
;던전플래그:108:0-10 = 宝箱
;던전플래그:108:11 = ボス撃破フラグ(1.倒した)
;
;던전플래그:108:20～29　ランダム依頼の判定に使用

;던전플래그:108:50	ランダムダンジョンの階層
;던전플래그:108:51	ランダムダンジョンの階段位置(X)
;던전플래그:108:52	ランダムダンジョンの階段位置(Y)

;=======================================================================
;攻略条件
;=======================================================================
@PREREQUISITE_DUNGEON_108
;ランダム依頼を受諾していると発生
IF 의뢰플래그:108:2 == 1
	RETURN 1
ELSE
	RETURN 0
ENDIF


;=======================================================================
;ダンジョン名
;=======================================================================
;面倒ではあるがCASEはそれぞれ1、２、３と順番に。視認性が死ぬので。視認性が！死ぬので！
@GET_DUNGEON_NAME_108
SELECTCASE 의뢰플래그:108:1
	;氷漬けの工場
	CASE 0
		RESULTS = 凍った製菓工場
	;下水道の異音
	CASE 3,
		RESULTS = 下水道
	;武装集団排除
	CASE 5
		RESULTS = 占拠されたダム
	;機密情報奪還
	CASE 6
		RESULTS = 廃棄されたダム
	;強奪部隊追撃
	CASE 7
		RESULTS = 下水道
	;防衛システム破壊
	CASE 9
		RESULTS = 兵器工場
	;拠点ビル襲撃
	CASE 12
		RESULTS = 拠点ビル
	;ゴブリン排除
	CASE 15
		RESULTS = 妖精の森
	;山を飛ぶ不審な影
	CASE 23
		RESULTS = 放棄された山中基地
	;廃工場侵入
	CASE 24
		RESULTS = 廃工場
	;異界化したビルの解放
	CASE 26
		RESULTS = 異界化したビル
	;変異したウナギの始末
	CASE 28
		RESULTS = 下水道
	;ドリアードを間引いてくれ
	CASE 30
		RESULTS = 森林地帯
	;地下洞窟調査
	CASE 32
		RESULTS = 地下洞窟
ENDSELECT


;=======================================================================
;攻略開始時のイベント
;=======================================================================
@EVENT_DUNGEON_START_108
SELECTCASE 의뢰플래그:108:1
	;氷漬けの工場
	CASE 0
		CALL MESSAGE_WINDOW_D, "", 				@"＞工場内に入ると、あたり一面が氷漬けにされている。", , , , , 4
	;下水道の異音
	CASE 3
		CALL MESSAGE_WINDOW_D, "", 				@"＞下水道内に入ると、何か聞こえてきた。", , , , , 4
		CALL MESSAGE_WINDOW_D, "？？？" , 		@"「……とけて……とけて……」「……いたいよぉ……くるしいよぉ……」", , , , , 4
	;武装集団排除
	CASE 5
		CALL MESSAGE_WINDOW_D, "メシア教徒" , 	@"「依頼を受けていただいた方ですね、お待ちしておりました。」", , , , , 4
		CALL MESSAGE_WINDOW_D, "メシア教徒" , 	@"「敵は奥に陣取っています。確実に処理してください。」", , , , , 4
	;機密情報奪還
	CASE 6
		CALL MESSAGE_WINDOW_D, "" , 			@"＞研究者の逃げ込んだダム内部へ侵入した。", , , , , 4
	;強奪部隊追撃
	CASE 7
		CALL MESSAGE_WINDOW_D, "" , 			@"＞襲撃部隊の立て籠もった下水道へ侵入した。", , , , , 4
	;防衛システム破壊
	CASE 9
		CALL MESSAGE_WINDOW_D, "" , 				@"＞工場に内に侵入すると、多数の警備ロボが警戒している。", , , , , 4
		CALL MESSAGE_WINDOW_D, "警備ロボ" , 		@"「警告、ここは関係者以外立チ入リ禁止です。１０秒以内ニ退去シテクダサイ。」", , , , , 4
		CALL MESSAGE_WINDOW_D, "警備ロボ" , 		@"「１０、９、８、７……排除シマス、排除シマス。」", , , , , 4
	;拠点ビル襲撃
	CASE 12
		CALL MESSAGE_WINDOW_D, "", 				@"＞ビルの中に入ると、工作員からの通信が入った。", , , , , 4
		CALL MESSAGE_WINDOW_D, "工作員" , 		@"「サマナー聞こえるか、まずは２階の敵を撃破してくれ」", , , , , 4
	;ゴブリン排除
	CASE 15
		CALL MESSAGE_WINDOW_D, "", 				@"＞妖精たちが住処としている森に足を踏み入れた。", , , , , 4
	;山を飛ぶ不審な影
	CASE 23
		CALL MESSAGE_WINDOW_D, "", 				@"＞指定ポイントの付近に風化した入口を見つけ、侵入した。", , , , , 4
		CALL MESSAGE_WINDOW_D, "", 				@"＞付近に目標の「巣」があるはずだ、探し出して破壊しよう。", , , , , 4
	;廃工場侵入
	CASE 24
		CALL MESSAGE_WINDOW_D, "", 				@"＞メシア教の拠点の一つである廃工場に足を踏み入れた。", , , , , 4
	;異界化したビルの解放
	CASE 26
		CALL MESSAGE_WINDOW_D, "", 				@"＞異界化したビルへと侵入した。", , , , , 4
	;変異したウナギの始末
	CASE 28
		CALL MESSAGE_WINDOW_D, "" , 			@"＞悪魔変異したウナギを追って下水道へ侵入した。", , , , , 4;
	;ドリアードを間引いてくれ
	CASE 30
		CALL MESSAGE_WINDOW_D, "" , 			@"＞森林地帯に足を踏み入れた。/＞ＭＡＧによって変異した高濃度の花粉が漂っている……", , , , , 4
	CASE 32
		CALL MESSAGE_WINDOW_D, "" , 			@"＞洞窟に足を踏み入れた。/＞……強烈な腐臭が鼻をつく。さっさと終わらせよう。", , , , , 4
ENDSELECT

;=======================================================================
;脱出時のイベント
;=======================================================================
@EVENT_DUNGEON_END_108
IF 의뢰플래그:108:1 == 29 && 던전플래그:108:20 == 1
	CALL MESSAGE_WINDOW_D, "" , 	@"目標の救助に成功した。", , , , , 4
	LOCAL:1 = (RAND:5 + 2)*4;ダンジョンタイプは通常の依頼の4倍の報酬
	CALL MESSAGE_WINDOW_D, "" , 	@"%CALLNAME:MASTER%は報酬として{LOCAL:1}00マッカと{LOCAL:1}0の名声を得た。", , , , , 4
	MONEY:1 += 100*LOCAL:1
	FLAG:명성 += 10*LOCAL:1
	;依頼受諾フラグを0に
	의뢰플래그:108:2 = 0
	;던전플래그を0に
	던전플래그:108:20 = 0



;ランダム依頼の場合、ダンジョンを出ると依頼キャンセル
ELSEIF 의뢰플래그:108:2 == 1
	CALL MESSAGE_WINDOW_D, "", "＞依頼をキャンセルした。"
	의뢰플래그:108:2 = 0

ENDIF

;=======================================================================
;指定したマスに進入可能か
;=======================================================================
@CAN_ENTER_108,ARG,ARG:1
CALL CAN_ENTER,ARG,ARG:1
RETURN RESULT


;=======================================================================
;[5]調べる　実行時のイベント
;=======================================================================
@EVENT_CHECK_DUNGEON_108

;==========
;出口の処理
;==========
IF DA:(FLAG:현X):(FLAG:현Y) % 10 == 8
	CALL DUNGEON_EXIT
	RETURN 1

;========
;宝の処理
;========
ELSEIF DA:(FLAG:현X):(FLAG:현Y) % 10 == 3
	;ランダムダンジョン
	SIF 의뢰플래그:108:3 == 6
		CALL TREASURE_RAND_DANGEON
	
;=======
;階段
;=======
ELSEIF DA:(FLAG:현X):(FLAG:현Y) % 10 == 6
	CALL UPSTAIRS_108
	RETURN RESULT
	
ELSEIF DA:(FLAG:현X):(FLAG:현Y) % 10 == 7
	;ランダムダンジョン
	IF 의뢰플래그:108:3 == 6
		CALL RAND_DUNGEON_DOWNSTAIRS
		RETURN RESULT
	ELSE
		CALL DOWNSTAIRS_108
		RETURN RESULT
	ENDIF

;========
;イベント
;========
ELSEIF DA:(FLAG:현X):(FLAG:현Y) % 10 == 4
	CALLFORM  DUNGEON_EVENT_108_{의뢰플래그:108:3}_{의뢰플래그:108:1}
ELSE
	CALL MESSAGE_WINDOW_D, "", "＞何も無いようだ"
	RETURN 0
ENDIF

;=======================================================================
;タイル進入時のイベント
;=======================================================================
@EVENT_ENTER_DUNGEON_108,ARG
;ARG = 進入時の向き　0の場合ワープなど
;==========
;出口の処理
;==========
IF DA:(FLAG:현X):(FLAG:현Y) % 10 == 8
	CALL DUNGEON_EXIT
	RETURN 1

;========
;宝の処理
;========
ELSEIF DA:(FLAG:현X):(FLAG:현Y) % 10 == 3
;ランダムダンジョン
SIF 의뢰플래그:108:3 == 6
	CALL TREASURE_RAND_DANGEON

;=======
;階段
;=======
ELSEIF DA:(FLAG:현X):(FLAG:현Y) % 10 == 6
	CALL UPSTAIRS_108
	RETURN RESULT

ELSEIF DA:(FLAG:현X):(FLAG:현Y) % 10 == 7
	IF 의뢰플래그:108:3 == 6
		CALL RAND_DUNGEON_DOWNSTAIRS
		RETURN RESULT
	ELSE
		CALL DOWNSTAIRS_108
		RETURN RESULT
	ENDIF
;==========
;扉の処理
;==========
ELSEIF DA:(FLAG:현X):(FLAG:현Y) % 10 == 2
	CALL DUNGEON_DOOR,ARG
	RETURN 1

;===========
;イベント
;===========
ELSEIF DA:(FLAG:현X):(FLAG:현Y) % 10 == 4
	CALLFORM DUNGEON_EVENT_108_{의뢰플래그:108:3}_{의뢰플래그:108:1}
ENDIF
RETURN 0

;=======================================================================
;輪姦参加悪魔
;=======================================================================
@DUNGEON_RAPE_DEVIL_108
;ランダムにどの悪魔が出るか決定
;RETURN CSV番号 , 人数 , レベル
SELECTCASE RAND:4
	CASE 0
		RETURN [[キャラ:잇폰다타라]] , 3 + RAND:10 , CSVBASE([[キャラ:잇폰다타라]] , GETNUM(BASE , "LV") , 0) + RAND:3
	CASE 1
		RETURN [[キャラ:코볼트]] , 3 + RAND:10 , CSVBASE([[キャラ:코볼트]] , GETNUM(BASE , "LV") , 0) + RAND:3
	CASE 2
		RETURN [[キャラ:안드라스]] , 3 + RAND:10 , CSVBASE([[キャラ:안드라스]] , GETNUM(BASE , "LV") , 0) + RAND:3
	CASE 3
		RETURN [[キャラ:브라우니]] , 3 + RAND:10 , CSVBASE([[キャラ:브라우니]] , GETNUM(BASE , "LV") , 0) + RAND:3
ENDSELECT

