@CALLTRAINEND
TFLAG:CALLTRAIN = 0
@SHOW_USERCOM
#LOCALSSIZE 1
#DIM LCOUNT
VARSET Q, -1
;派生用
VARSET R, -1
Z= 0
;CALLTRAIN時は표시しない
SIF TFLAG:CALLTRAIN
	RETURN 0
;명령어를 모두 체크
LOCAL:1 = -1
FOR LOCAL, 0, 1000
	;이름의 길이가 0인 경우、없는 것으로 간주한다
	SIF STRLENS(TRAINNAME:LOCAL) == 0
		CONTINUE
	;파생 명령어는 버린다
	TRYCCALLFORM COMTYPE_{LOCAL}
		SIF RESULT == COMTYPE("派生系")
			CONTINUE
	CATCH
	ENDCATCH
	LOCAL:1++
	;COMABLE를 체크
	CALL COM_ABLE_COMMON_D, LOCAL
	SIF RESULT == 0
		CONTINUE
	;파생 명령어인지 아닌지를 체크
	TRYCCALLFORM JUMP_COM{LOCAL}
		LOCAL:2 = RESULT >= 0 ? RESULT # LOCAL
	CATCH
		LOCAL:2 = LOCAL
	ENDCATCH
	;MENU배열에 실행 가능한 명령어를 등록해 나가기
	Q:(LOCAL:1) = LOCAL:2
	;필터관계는 파생 전에 체크하므로 주의할 것
	SIF GET_COM_FILTERING(LOCAL, TARGET)
		CONTINUE
	TRYCCALLFORM COMTYPE_{LOCAL}
		SIF CFLAG:(170+RESULT) == 1
			CONTINUE
	CATCH
	ENDCATCH
	;이미 표시된 명령어가 여기까지 오면 돌아간다
	SIF MATCH(R, LOCAL:2)
		CONTINUE
	;커맨드 표시
	TRYCCALLFORM COMNAME{LOCAL:2}
		PRINTFORMC %RESULTS%[{LOCAL:1,3}]
	CATCH
		PRINTFORMC %TRAINNAME:(LOCAL:2)%[{LOCAL:1,3}]
	ENDCATCH
	;이쯤 되면 표시된 것으로 등록된다
	R:(LOCAL:1) = LOCAL:2
	;줄바꿈(개행) 처리
	CALL CHECK_NEWLINE
NEXT

;USERCOM표시の前に一度、改行する
IF (Z % TRAINPRINTCPL())
	Z = 0
	PRINTL 
ENDIF

;필터されている系統の표시
SETCOLOR COLOR("gray")
FOR LOCAL,0,16
	SELECTCASE LOCAL
		CASE 13,14
			CONTINUE
		CASEELSE
			IF CFLAG:TARGET:(CFLAGNAME:(170+LOCAL)) == 0
				SETCOLOR COLOR("aqua")
			ELSE
				SETCOLOR COLOR("light-gray")
			ENDIF
			;SIF CFLAG:TARGET:(CFLAGNAME:(170+LOCAL)) == 0 && (LOCAL != 15 && コマンド数:LOCAL > 0)
			;	CONTINUE
			;SIF LOCAL == 15 && CFLAG:TARGET:(CFLAGNAME:(170+LOCAL)) == 0
			;SIF CFLAG:TARGET:(CFLAGNAME:(170+LOCAL)) == 0 && コマンド数:LOCAL == 0
			;SIF LOCAL == 15 && Z != 0
			;	PRINTL
			;KR판 레이아웃 수정 -8 > -4 , CFLAG XX계필터, XX系フィルタ의 변수명 길이차이에 의한 STRLENS 보정
			;PRINTFORMC  %SUBSTRING(CFLAGNAME:(170+LOCAL),,STRLENS(CFLAGNAME:(170+LOCAL))-8)%[{700+LOCAL}] ;original
			PRINTFORMC  %SUBSTRING(CFLAGNAME:(170+LOCAL),,STRLENS(CFLAGNAME:(170+LOCAL))-4)%[{700+LOCAL}]
			CALL CHECK_NEWLINE
	ENDSELECT
NEXT
RESETCOLOR

IF (Z % TRAINPRINTCPL())
	Z = 0
	PRINTL 
ENDIF


IF !CFLAG:TARGET:옵션필터
	A = 0
	Z = 0
	PRINTC 내역표시[800]
	CALL CHECK_NEWLINE
	PRINTC 더러움 표시 & 관리[801]
	CALL CHECK_NEWLINE
	PRINTC 능력표시[802]
	CALL CHECK_NEWLINE
	B = 11
	FOR LCOUNT, 0, 50
		C = B+LCOUNT
		;미약、이뇨제、비디오카메라、새댁플레이、수치플레이、강정신약사용時は覗く
		SIF C == 26
			CONTINUE
		SIF C == 27
			CONTINUE
		SIF C == 28
			CONTINUE
		SIF C == 30
			CONTINUE
		SIF C == 33
			CONTINUE
		SIF C == 34
			CONTINUE
		SIF C == 40
			CONTINUE
	NEXT
		PRINTC 착의설정[803]
		CALL CHECK_NEWLINE
	IF HAVE_PENIS(PLAYER) || HAVE_PENIS(TARGET)
		IF ITEM:45 > 0
			PRINTC 콘돔설정[804]
			CALL CHECK_NEWLINE
		ENDIF
		PRINTC 자동사정부위변경[805]
		CALL CHECK_NEWLINE
	ENDIF
	IF ASSIPLAY
		PRINTC 능력표시(조수)[806]
		CALL CHECK_NEWLINE
	ELSE
		PRINTC 능력표시(마스터)[806]
		CALL CHECK_NEWLINE
	ENDIF

	IF (!(CFLAG:초기주도권 || TALENT:쾌감을부정 || TALENT:저항 || TALENT:억압) && TALENT:남자 ) || ABL:순종 > 2
		PRINTFORMC 주도권을 \@ TEQUIP:주도권 ? 받는다 # 건네준다　 \@[808]
		CALL CHECK_NEWLINE
	ENDIF

	IF ASSI >= 0
		IF ASSIPLAY && TEQUIP:25 == 0
			PRINTC 마스터가 조교한다[900]
		ELSEIF TEQUIP:25 == 0
			PRINTC 조수가 조교한다[900]
		ENDIF
		CALL CHECK_NEWLINE
	ENDIF

	PRINTFORMC ＭＡＧ흡수(\@(CFLAG:ＭＡＧ비피흡수 == 1) ? OFF # ON \@)[902]
	CALL CHECK_NEWLINE


	IF ASSIPLAY
		PRINTFORMC ＭＡＧ양도(\@(CFLAG:ASSI:ＭＡＧ비피흡수 == 1) ? OFF # ON \@)[906]
		CALL CHECK_NEWLINE
	ELSE
		PRINTFORMC ＭＡＧ양도(\@(CFLAG:MASTER:ＭＡＧ비피흡수 == 1) ? OFF # ON \@)[906]
		CALL CHECK_NEWLINE
	ENDIF

	PRINTC 조교메뉴등록[980]
	CALL CHECK_NEWLINE
	FOR LOCAL, 0, 5
		SIF GLOBALS:LOCAL == ""
			GLOBALS:LOCAL = 조교메뉴{LOCAL+1}
		SIF !GETBIT(CFLAG:조교메뉴표시설정, LOCAL)
			CONTINUE
		PRINTFORMC %GLOBALS:LOCAL%[{981+LOCAL}]
		CALL CHECK_NEWLINE
	NEXT
	FOR LOCAL, 0, 3
		LOCALS = %AUTO_SPLIT(CSTR:(71+LOCAL),"|",10)%
		SIF LOCALS == "" || !GETBIT(CFLAG:조교메뉴표시설정, LOCAL+5)
			CONTINUE
		PRINTFORMC %LOCALS%[{986+LOCAL}]
		CALL CHECK_NEWLINE
	NEXT
	;IF FLAG:550 > 0
	;	PRINTC 조교메뉴표시[991]
	;	CALL CHECK_NEWLINE
	;	PRINTC 조교메뉴実行[992]
	;	CALL CHECK_NEWLINE
	;ENDIF

	PRINTC 커맨드필터[993]
	CALL CHECK_NEWLINE
	IF EXIST_PICTURE(NO:TARGET, 100) || CFLAG:TARGET:얼굴이미지 > 0
		PRINTC 얼굴그래픽 설정[994]
		CALL CHECK_NEWLINE
	ENDIF
ENDIF
PRINTFORMC 일시적함락소질변경\@ CFLAG:일시적함락소질변경 ? ON#OFF\@[998]
CALL CHECK_NEWLINE
IF Z != 0
	Z = FLAG:조교커맨드의나열수 - 1
	CALL CHECK_NEWLINE
ENDIF
DRAWLINE
PRINTC 조교종료[999]
PRINTL
IF PREVCOM >= 0
	PRINTL 
	PRINT ＜전회조교커맨드:
	PRINTS TSTR:0
	SIF TFLAG:전회조교자 == ASSI
		PRINT (조수)
	PRINTL ＞
ELSE
	PRINTL 
	PRINT ＜전회조교커맨드:없음＞
ENDIF

@USERCOM
#LOCALSIZE 2
IF RESULT < 0 || RESULT > 999
	RETURN 0
;커맨드필터들 입력계
ELSEIF (RESULT >= 700 && RESULT <= 712) || RESULT == 715
	INVERTBIT CFLAG:TARGET:(RESULT + 170 - 700), 0
ELSEIF RESULT == 800
	CALL SHOW_EQUIP
	RETURN 1
ELSEIF RESULT == 801
	CALL STAIN_INFO
	RETURN 1
ELSEIF RESULT == 802
	CALL SHOW_CHARADATA,TARGET
	WAIT
	RETURN 1
ELSEIF RESULT == 803
	CALL CLOTHES_CHANGE,TARGET
	RETURN 1
ELSEIF RESULT == 804 && ( HAVE_PENIS(PLAYER) || HAVE_PENIS(TARGET) ) && ITEM:45 > 0
	CALL CONDOM_SETTING
	RETURN 1
ELSEIF RESULT == 805 && ( HAVE_PENIS(PLAYER) || HAVE_PENIS(TARGET) )
	CALL SAMENPLACE_SETTING
	RETURN 1
ELSEIF RESULT == 806
	CALL SHOW_CHARADATA,PLAYER
	WAIT
	RETURN 1
ELSEIF RESULT == 808 && ((!(CFLAG:초기주도권 || TALENT:쾌감을부정 || TALENT:저항 || TALENT:억압) && TALENT:남자 ) || ABL:순종 > 2)
	INVERTBIT TEQUIP:주도권 , 0
	RETURN 1
ELSEIF RESULT == 900 && ASSI > 0 && TEQUIP:25 == 0
	IF ASSIPLAY
		ASSIPLAY = 0
		PLAYER = MASTER
	ELSE
		ASSIPLAY = 1
		PLAYER = ASSI
	ENDIF
	RETURN 1

ELSEIF RESULT == 902
	IF CFLAG:ＭＡＧ비피흡수 == 0
		CFLAG:ＭＡＧ비피흡수 = 1
	ELSE
		CFLAG:ＭＡＧ비피흡수 = 0
	ENDIF
	RETURN 1
ELSEIF RESULT == 906
	IF ASSIPLAY
		IF CFLAG:ASSI:ＭＡＧ비피흡수 == 0
			CFLAG:ASSI:ＭＡＧ비피흡수 = 1
		ELSE
			CFLAG:ASSI:ＭＡＧ비피흡수 = 0
		ENDIF
	ELSE
		IF CFLAG:MASTER:ＭＡＧ비피흡수 == 0
			CFLAG:MASTER:ＭＡＧ비피흡수 = 1
		ELSE
			CFLAG:MASTER:ＭＡＧ비피흡수 = 0
		ENDIF
	ENDIF
	RETURN 1
ELSEIF RESULT == 980
	CALL COMSEQ_REGISTER
	RETURN 1
ELSEIF RANGE(RESULT, 981, 988)
	CALL COMSEQ_TRAIN, RESULT - 981
	RETURN 1
;ELSEIF RESULT == 991 && FLAG:550 > 0
;	CALL COMSEQ_SHOW
;	RETURN 1
;ELSEIF RESULT == 992 && FLAG:550 > 0
;	CALL COMSEQ_TRAIN
;	RETURN 1
ELSEIF RESULT == 993
	CALL COM_FILTER, TARGET
	RETURN 1
ELSEIF RESULT == 994
	CALL 얼굴이미지변경,TARGET
	RETURN 1
ELSEIF RESULT == 998
	INVERTBIT CFLAG:일시적함락소질변경 , 0
	RETURN 1
ELSEIF RESULT == 999
	BEGIN AFTERTRAIN
	RETURN 1
ELSEIF Q:RESULT >= 0
	DOTRAIN Q:RESULT
ENDIF
RETURN 0

@SHOW_EQUIP
T = TARGET
CALL SHOW_INFO_JUEL
IF PREVCOM >= 0
	PRINT 전회조교커맨드:
	PRINTS TSTR:0
	SIF TFLAG:전회조교자 == ASSI
		PRINT (조수)
	PRINTL 
ENDIF
SIF TEQUIP:26
	PRINTL [미약효과발휘중]
SIF TEQUIP:27
	PRINTL [이뇨제효과발휘중]
IF TEQUIP:34 == 1
	PRINTL [강정신약반동중]
ELSEIF TEQUIP:34 > 1
	PRINTL [강정신약효과발휘중]
ENDIF

SIF TEQUIP:28
	PRINTFORML [비디오촬영중({TFLAG:70 - 1}/10)]
SIF TEQUIP:29
	PRINTL [야외플레이중]
SIF TEQUIP:46 >= 1
	PRINTFORML [구경꾼 {TEQUIP:46}인]
SIF TEQUIP:30
	PRINTL [수치플레이중]
SIF TEQUIP:31
	PRINTL [목욕탕플레이중]
SIF TEQUIP:33
	PRINTL [신혼플레이중]
SIF TEQUIP:25
	PRINTL [촉수조교중]

IF TEQUIP:13 && TEQUIP:25
	PRINTL [촉수삽입]
ELSEIF TEQUIP:13
	PRINTL [바이브삽입중]
ENDIF

IF TEQUIP:14 && TEQUIP:25
	PRINTL [촉수애널삽입]
ELSEIF TEQUIP:14
	PRINTL [애널바이브삽입중]
ENDIF

IF TEQUIP:11 && TEQUIP:25
	PRINTL [촉수클리자극]
ELSEIF TEQUIP:11
	PRINTL [클리캡장착중]
ENDIF

IF TEQUIP:16 && TEQUIP:25
	PRINTL [촉수유두자극]
ELSEIF TEQUIP:16
	PRINTL [유두캡장착중]
ENDIF
IF TEQUIP:17 && TEQUIP:25
	PRINTL [촉수착유]
ELSEIF TEQUIP:17
	PRINTL [착유기장착중]
ENDIF
SIF TEQUIP:24
	PRINTL [유방전극장착중]

IF TEQUIP:12 && TEQUIP:25
	PRINTL [촉수페니스자극]
ELSEIF TEQUIP:12
	PRINTL [오나홀장착중]
ENDIF

IF TEQUIP:32
	PRINTL [샤워사용중]
ENDIF

IF TEQUIP:19 && TEQUIP:25
	PRINTL [촉수긴박]
ELSEIF TEQUIP:19
	PRINTL [밧줄로긴박]
ENDIF

IF TEQUIP:21 && TEQUIP:25
	PRINTL [촉수관장]
ELSEIF TEQUIP:21
	PRINTL [관장＋애널플러그장비중]
ENDIF

SIF TEQUIP:36
	PRINTL [촉수구욕중]

SIF TEQUIP:18
	PRINTL [아이마스크장착중]
SIF TEQUIP:20
	PRINTL [볼재갈장착중]
SIF TEQUIP:15
	PRINTL [애널비즈삽입중]
SIF TEQUIP:22
	PRINTL [확장벌룬삽입중]
SIF TEQUIP:23
	PRINTL [애널전극삽입중]

SIF TEQUIP:41
	PRINTL [삼각목마기승중]
SIF TEQUIP:42
	PRINTL [사정억제중]
	
SIF TEQUIP:PLAYER:26
	PRINTL [미약효과발휘중(조교자)]
	
IF TEQUIP:PLAYER:13 && TEQUIP:25
	PRINTL [촉수삽입(조교자)]
ELSEIF TEQUIP:PLAYER:13
	PRINTL [바이브삽입중(조교자)]
ENDIF

IF TEQUIP:PLAYER:14 && TEQUIP:25
	PRINTL [촉수애널삽입(조교자)]
ELSEIF TEQUIP:PLAYER:14
	PRINTL [애널바이브삽입중(조교자)]
ENDIF

IF TEQUIP:PLAYER:11 && TEQUIP:25
	PRINTL [촉수클리자극(조교자)]
ELSEIF TEQUIP:PLAYER:11
	PRINTL [클리캡장착중(조교자)]
ENDIF

IF TEQUIP:PLAYER:16 && TEQUIP:25
	PRINTL [촉수유두자극(조교자)]
ELSEIF TEQUIP:PLAYER:16
	PRINTL [유두캡장착중(조교자)]
ENDIF
IF TEQUIP:PLAYER:17 && TEQUIP:25
	PRINTL [촉수착유(조교자)]
ELSEIF TEQUIP:PLAYER:17
	PRINTL [착유기장착중(조교자)]
ENDIF

IF TEQUIP:PLAYER:12 && TEQUIP:25
	PRINTL [촉수페니스자극(조교자)]
ELSEIF TEQUIP:PLAYER:12
	PRINTL [오나홀장착중(조교자)]
ENDIF

SIF TEQUIP:PLAYER:15
	PRINTL [애널비즈삽입중(조교자)]

SIF EX:0
	PRINTFORM Ｃ절정:{EX:0}회　
SIF EX:1
	PRINTFORM Ｖ절정:{EX:1}회　
SIF EX:2
	PRINTFORM Ａ절정:{EX:2}회　
SIF EX:3
	PRINTFORM Ｂ절정:{EX:3}회　
SIF EX:4
	PRINTFORM 　분유:{EX:4}회　
SIF EX:5
	PRINTFORM 　사정:{EX:5}회　
SIF EX:0 || EX:1 || EX:2 || EX:3 || EX:4 || EX:5
	PRINTL 
SIF EX:PLAYER:0
	PRINTFORM 조교자Ｃ절정:{EX:PLAYER:0}회　
SIF EX:PLAYER:1
	PRINTFORM 조교자Ｖ절정:{EX:PLAYER:1}회　
SIF EX:PLAYER:2
	PRINTFORM 조교자Ａ절정:{EX:PLAYER:2}회　
SIF EX:PLAYER:3
	PRINTFORM 조교자자Ｂ절정:{EX:PLAYER:3}회　
SIF EX:PLAYER:0 || EX:PLAYER:1 || EX:PLAYER:2 || EX:PLAYER:3 || EX:PLAYER:4 || EX:PLAYER:5
	PRINTL 

WAIT

@CONDOM_SETTING
#DIM LCOUNT
A = 0
B = 0
C = 0
T = 0
PRINTFORMW 콘돔설정을 실시하는 대상을 선택해주세요 (현재 콘돔 갯수: {ITEM:45})
PRINTL  
FOR LCOUNT, 0, 3
	IF (HAVE_PENIS(MASTER)) && A == 0
		PRINTFORM [{LCOUNT}] %CALLNAME:MASTER%
		IF TEQUIP:MASTER:35 && (FLAG:98 & 4)
			PRINTL (착용마침、상비)
		ELSEIF TEQUIP:MASTER:35
			PRINTL (착용마침)
		ELSE
			PRINTL (미착용)
		ENDIF
		A = 1
	ELSEIF ASSI >= 0
		IF HAVE_PENIS(ASSI) && B == 0
			PRINTFORM [{LCOUNT}] %CALLNAME:ASSI%
			IF TEQUIP:ASSI:35 && (FLAG:98 & 2)
				PRINTL (착용마침、상비)
			ELSEIF TEQUIP:ASSI:35
				PRINTL (착용마침)
			ELSE
				PRINTL (미착용)
			ENDIF
			B = 1
		ENDIF
	ELSEIF HAVE_PENIS(TARGET) && C == 0
		PRINTFORM [{LCOUNT}] %CALLNAME:TARGET%
		IF TEQUIP:TARGET:35 && (FLAG:98 & 1)
			PRINTL (착용마침、상비)
		ELSEIF TEQUIP:TARGET:35
			PRINTL (착용마침)
		ELSE
			PRINTL (미착용)
		ENDIF
		C = 1
	ENDIF
NEXT
PRINTL [100]돌아간다
$INPUT_LOOP
INPUT
IF RESULT == 0
	IF A == 1
		T = MASTER
	ELSEIF B == 1
		T = ASSI
	ELSEIF C == 1
		T = TARGET
	ENDIF
ELSEIF RESULT == 1
	IF B == 1
		T = ASSI
	ELSEIF C == 1
		T = TARGET
	ENDIF
ELSEIF RESULT == 2
	T = TARGET
ELSEIF RESULT == 100
	RETURN 0
ELSE
	GOTO INPUT_LOOP
ENDIF

PRINTL 콘돔의 설정을 해주세요
PRINTL  
	PRINTFORM 설정대상：%CALLNAME:T%
	IF TEQUIP:T:35
		PRINT (착용마침
		IF (T == MASTER && (FLAG:98 & 4)) || (T == ASSI && (FLAG:98 & 2)) || (T == TARGET && (FLAG:98 & 1))
			PRINTL 、상비)
		ELSE
			PRINTL )
		ENDIF
	ELSE
		PRINTL (미착용)
	ENDIF
PRINTL [0]  콘돔을 항상 착용한다
PRINTL [1]  콘돔을 착용한다
PRINTL [2]  콘돔을 뺀다
PRINTL [100]돌아간다

$INPUT_LOOP1
INPUT
IF RESULT == 0
	IF TEQUIP:T:35 == 0
		ITEM:45 -= 1
		TEQUIP:T:35 = 1
	ENDIF
	SIF T == MASTER
		FLAG:98 |= 4
	SIF T == ASSI
		FLAG:98 |= 2
	SIF T == TARGET
		FLAG:98 |= 1
	PRINTFORMW %조사처리(CALLNAME:T,"는")%、콘돔을 항상 끼게했다
ELSEIF RESULT == 1
	IF TEQUIP:T:35 == 0
		;음란・창부持ち
		IF TALENT:PLAYER:4 || TALENT:PLAYER:7
			IF PLAYER != T
				IF RAND:2 == 0
					PRINTFORMW %조사처리(CALLNAME:PLAYER,"는")% 음란한 미소를 띠면서 콘돔을 꺼내、%CALLNAME:T%의 페니스에 입으로 장착시켰다…
				ELSE
					PRINTFORMW %조사처리(CALLNAME:PLAYER,"는")% 익숙한 솜씨로 콘돔을 물어、그대로 입으로 %CALLNAME:T%의 페니스에 장착시켰다…
				ENDIF
			ELSEIF PLAYER == MASTER && ASSI > 0
				SELECTCASE RAND:3
					CASE 0
						PRINTFORMW %조사처리(CALLNAME:PLAYER,"는")% 콘돔을 꺼내、%CALLNAME:ASSI%에게 입으로 %CALLNAME:T%의 페니스에 장착시키게 했다…
					CASE 1
						PRINTFORMW %조사처리(CALLNAME:ASSI,"는")% 익숙한 솜씨로 콘돔을 물어、그대로 입으로 %CALLNAME:T%의 페니스에 장착시켰다…
					CASE 2
						PRINTFORMW %조사처리(CALLNAME:PLAYER,"는")% 콘돔을 꺼내、%CALLNAME:TARGET%에게 입으로 %CALLNAME:T%의 페니스에 장착시키게 했다…
				ENDSELECT
			ELSE
				PRINTFORMW %조사처리(CALLNAME:PLAYER,"는")% 콘돔을 꺼내、%CALLNAME:TARGET%에게 입으로 %CALLNAME:T%의 페니스에 장착시키게 했다…
			ENDIF
		ELSE
			PRINTFORMW %조사처리(CALLNAME:T,"는")% 콘돔을 꼈다
		ENDIF
		ITEM:45 -= 1
		TEQUIP:T:35 = 1
	ELSEIF (T == MASTER && (FLAG:98 & 4)) || (T == ASSI && (FLAG:98 & 2)) || (T == TARGET && (FLAG:98 & 1))
		PRINTFORMW %조사처리(CALLNAME:T,"는")%、콘돔을 항상 끼지 않게 했다
		SIF T == MASTER
			FLAG:98 &= 3
		SIF T == ASSI
			FLAG:98 &= 5
		SIF T == TARGET
			FLAG:98 &= 6
	ELSE
		PRINTFORMW %조사처리(CALLNAME:T,"는")%、이미 콘돔을 끼고있다
	ENDIF
ELSEIF RESULT == 2
	PRINTFORMW %조사처리(CALLNAME:T,"는")% 콘돔을 벗었다
	SIF T == MASTER
		FLAG:98 &= 3
	SIF T == ASSI
		FLAG:98 &= 5
	SIF T == TARGET
		FLAG:98 &= 6
	TEQUIP:T:35 = 0
ELSEIF RESULT == 100
	RETURN 0
ELSE
	GOTO INPUT_LOOP1
ENDIF


@CHECK_NEWLINE
Z += 1
IF Z == TRAINPRINTCPL()
	PRINTL 
	Z = 0
ENDIF

@COM_FILTER, ARG
;改行用カウントをリセットしておく
LOCAL:1 = 0
DRAWLINE
IF CFLAG:ARG:이용필터 == 1
	PRINTL 【공통설정1】
ELSEIF CFLAG:ARG:이용필터 == 2
	PRINTL 【공통설정2】
ELSEIF CFLAG:ARG:이용필터 == 3
	PRINTL 【공통설정3】
ELSEIF CFLAG:ARG:이용필터 == 4
	PRINTFORML 【%CALLNAME:ARG%의 개별설정】
ELSE
	PRINTFORML 【필터 미사용】
ENDIF
;ページの決定で、LOCAL:3は開始のTRAIN、LOCAL:4が終了位置
IF LOCAL:3 == 0
	LOCAL:4 = 101
ELSEIF LOCAL:3 == 101
	LOCAL:4 = 1000
;ELSE
;	LOCAL:4 = 1000
ENDIF
;필터ーかかってるコマンドは灰色に
SETCOLOR 102, 102, 102
FOR LOCAL, LOCAL:3, LOCAL:4
	SIF CFLAG:ARG:이용필터 == 0
		BREAK
	;名前の長さが0の場合、ないものとみなす
	SIF STRLENS(TRAINNAME:LOCAL) == 0
		CONTINUE
	;共通설정モードの時は共通설정
	;필터링플래그が立ってないとき、通常표시、つまり立ってる時だけ灰色
	IF GET_COM_FILTERING(LOCAL, ARG)
		PRINTFORMC %TRAINNAME:LOCAL%[{LOCAL,3}]
	ELSE
		PRINTFORMCD %TRAINNAME:LOCAL%[{LOCAL,3}]
	ENDIF
	;改行処理
	LOCAL:1 += 1
	SIF (LOCAL:1 % TRAINPRINTCPL()) == 0
		PRINTL 
NEXT
IF (LOCAL:1 % TRAINPRINTCPL())
	PRINTL 
	LOCAL:1 = 0
ENDIF
RESETCOLOR
DRAWLINE
SETCOLOR 102, 255, 255
;現在ページも色で表す
IF LOCAL:3 == 0
	PRINTC [1000] 페이지1
ELSE
	PRINTCD [1000] 페이지1
ENDIF
IF LOCAL:3 == 101
	PRINTC [1001] 페이지2
ELSE
	PRINTCD [1001] 페이지2
ENDIF
;IF LOCAL:3 == 300
;	PRINTCD [1002] ページ3
;ELSE
;	PRINTC [1002] ページ3
;ENDIF
PRINTL 
;色を戻す
RESETCOLOR
DRAWLINE
PRINTL [1003] 돌아간다
SETCOLOR 102, 255, 255
IF CFLAG:ARG:이용필터 == 0
	PRINTL [1004] 이용하지않는다
ELSE
	PRINTDL [1004] 이용하지않는다
ENDIF
IF CFLAG:ARG:이용필터 == 1
	PRINTL [1005] 공통설정1
ELSE
	PRINTDL [1005] 공통설정1
ENDIF
IF CFLAG:ARG:이용필터 == 2
	PRINTL [1006] 공통설정2
ELSE
	PRINTDL [1006] 공통설정2
ENDIF
IF CFLAG:ARG:이용필터 == 3
	PRINTL [1007] 공통설정3
ELSE
	PRINTDL [1007] 공통설정3
ENDIF
IF CFLAG:ARG:이용필터 == 4
	PRINTL [1008] 개별설정
ELSE
	PRINTDL [1008] 개별설정
ENDIF
SIF CFLAG:ARG:이용필터
	PRINTDL [1009] 리셋
RESETCOLOR
$INPUT_LOOP
INPUT
IF RESULT == 1000
	LOCAL:3 = 0
ELSEIF RESULT == 1001
	LOCAL:3 = 101
;ELSEIF RESULT == 1002
;	LOCAL:3 = 300
ELSEIF RESULT == 1003
	RETURN 1
ELSEIF RESULT == 1004
	PRINTFORMW 필터를 사용하지 않습니다
	CFLAG:ARG:이용필터 = 0
ELSEIF RESULT == 1005
	PRINTW 공통설정1을 사용합니다
	CFLAG:ARG:이용필터 = 1
ELSEIF RESULT == 1006
	PRINTW 공통설정2를 사용합니다
	CFLAG:ARG:이용필터 = 2
ELSEIF RESULT == 1007
	PRINTW 공통설정3을 사용합니다
	CFLAG:ARG:이용필터 = 3
ELSEIF RESULT == 1008
	PRINTW 개별설정을 사용합니다
	CFLAG:ARG:이용필터 = 4
ELSEIF RESULT == 1009 && CFLAG:ARG:이용필터
	PRINTL 현재 표시하고 있는 설정을 리셋합니다
	PRINTL 정말로 좋습니까？
	CALL INPUT_YN
	IF RESULT == 0
		FOR LOCAL, SET_COM_FILTERING_NUM(ARG), SET_COM_FILTERING_NUM(ARG)+13
			IF CFLAG:ARG:이용필터 == 4
				CFLAG:ARG:LOCAL = 0
			ELSE
				FLAG:LOCAL = 0
			ENDIF
		NEXT
		PRINTW 리셋했습니다
	ENDIF
ELSEIF RESULT < 0 || RESULT > 1000 || !CFLAG:ARG:이용필터
	GOTO INPUT_LOOP
ELSEIF STRLENS(TRAINNAME:RESULT)
	CALL INVERT_COM_FILTERING(RESULT, ARG)
ELSE
	GOTO INPUT_LOOP
ENDIF
RESTART


@GET_COM_FILTERING(ARG, ARG:1 = -123456789)
#FUNCTION
;隠し番号입력で대상をTARGETにもとい、생략でTARGET
SIF ARG:1 == -123456789
	ARG:1 = TARGET
SIF ARG:1 < -1 || ARG:1 >= CHARANUM
	THROW "ARG:1의 값이 이상합니다"
SIF ARG < 0 || ARG >1008
	THROW "ARG의 값이 이상합니다"
;使うCFLAGの決定
LOCAL = ARG / 63 + SET_COM_FILTERING_NUM(ARG:1)
;そのCFLAGの何番눈のBITか
LOCAL:1 = ARG % 63
;フラグ체크
IF CFLAG:(ARG:1):이용필터 == 0
	RETURNF 0
ELSEIF CFLAG:(ARG:1):이용필터 < 4
	SIF GETBIT(FLAG:LOCAL, LOCAL:1)
		RETURNF 1
ELSE
	SIF GETBIT(CFLAG:(ARG:1):LOCAL, LOCAL:1)
		RETURNF 1
ENDIF
RETURNF 0
@INVERT_COM_FILTERING(ARG, ARG:1 = -123456789)
;隠し番号입력で대상をTARGETにもとい、생략でTARGET
SIF ARG:1 == -123456789
	ARG:1 = TARGET
SIF ARG:1 < -1 || ARG:1 >= CHARANUM
	PRINTW ARG:1의 값이 이상합니다
SIF ARG < 0 || ARG >1008
	PRINTW ARG의 값이 이상합니다
;使うFLAGの決定
LOCAL = ARG / 63 + SET_COM_FILTERING_NUM(ARG:1)
;そのCFLAGの何番눈のBITか
LOCAL:1 = ARG % 63
;フラグ反転
IF CFLAG:(ARG:1):이용필터 < 4
	INVERTBIT FLAG:LOCAL, LOCAL:1
ELSE
	INVERTBIT CFLAG:(ARG:1):LOCAL, LOCAL:1
ENDIF
RETURN 0

;필터링のFLAGの先머리の位置を返す
@SET_COM_FILTERING_NUM(ARG)
#FUNCTION
IF CFLAG:ARG:이용필터 == 1
	RETURNF GETNUM(FLAG, "필터공통설정1")
ELSEIF CFLAG:ARG:이용필터 == 2
	RETURNF GETNUM(FLAG, "필터공통설정2")
ELSEIF CFLAG:ARG:이용필터 == 3
	RETURNF GETNUM(FLAG, "필터공통설정3")
ELSEIF CFLAG:ARG:이용필터 == 4
	RETURNF GETNUM(CFLAG, "커맨드필터")
ELSE
	RETURNF -1
ENDIF
